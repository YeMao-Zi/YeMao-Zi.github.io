## æŠ€æœ¯æ–¹æ¡ˆ

1. æœåŠ¡å™¨å®‰è£… `gitlab runner` ï¼Œå¹¶ç¼–å†™ `gitlab-ci.yml` æ–‡ä»¶
2. é€šè¿‡ `oss-utils`æˆ– `oss sdk` å°†äº§ç‰©ä¸Šä¼ åˆ° é˜¿é‡Œäº‘ oss

### æœ€ç»ˆå®ç°

å¯ä»¥é€šè¿‡ https://tutulist.cn è®¿é—®å‰ç«¯èµ„æº

## å®‰è£… gitlab å’Œ gitlab runner

å¤§éƒ¨åˆ†ä¼ä¸šå…¶å®éƒ½ä¼šç§æœ‰åŒ–ä¸€ä¸ª gitlab ä¾›è‡ªå·±å…¬å¸å†…éƒ¨ä½¿ç”¨ï¼Œä½†æ˜¯ç§æœ‰åŒ–ä¸€ä¸ª gitlab æ˜¯æœ‰æœåŠ¡å™¨é…ç½®è¦æ±‚çš„;

### å®˜æ–¹å»ºè®®é…ç½®

 [æ–‡æ¡£åœ°å€](https://docs.gitlab.com/ee/install/requirements.html#cpu)

cpu 4æ ¸ æ˜¯æ¨èçš„æœ€å°æ ¸æ•°ï¼Œå¯ä»¥æ”¯æŒ 500 ä¸ªç”¨æˆ·ï¼›

å†…å­˜ 4G æ˜¯æœ€å°å†…å­˜ï¼Œå¯ä»¥æ”¯æŒ 500 ä¸ªç”¨æˆ·ï¼›

æ‰€ä»¥è¯´ï¼Œå¦‚æœè¦æƒ³ç§æœ‰åŒ–ä¸€ä¸ª `gitlab`  ä»“åº“ï¼Œä½ å°±éœ€è¦è´­ä¹°äº†ä¸€ä¸ªæœ€ä½ cpu 4æ ¸ ï¼Œå†…å­˜ 4G çš„æœåŠ¡å™¨ã€‚

å› ä¸ºæˆ‘ä»¬çš„æµ‹è¯•æœåŠ¡å™¨é…ç½®å¹¶ä¸é«˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åªåœ¨æœåŠ¡å™¨ä¸Šè·‘ä¸€ä¸ª `gitlab runner`ï¼Œ`gitlab`ä»“åº“ä½¿ç”¨å®˜æ–¹ä»“åº“ã€‚

### å®‰è£… gitlab runner

```shell
docker run -d --name gitlab-runner --restart always \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest
```

é€šè¿‡ `docker ps`å‘½ä»¤æŸ¥çœ‹ï¼Œ`gitlab runner` æ˜¯å¦å·²ç»è¿è¡Œ

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665550702802-60b3e54e-2e72-41ac-8969-4038e9da25d3.png)

### æ³¨å†Œ gitlab-runner

è¿™ä¸€æ­¥ä¸»è¦å°±æ˜¯å°†æˆ‘ä»¬æœåŠ¡å™¨ä¸Šçš„ runner ä¸ gitlab ä»£ç ä»“åº“å»ºç«‹è”ç³»

```shell
docker run --rm -it \
 -v /srv/gitlab-runner/config:/etc/gitlab-runner \
 gitlab/gitlab-runner \
 register
```

è¾“å…¥åï¼Œä¼šè¦æ±‚é”®å…¥ä¸€äº›é…ç½®

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665983995325-4d31235d-8a4c-4df3-8a50-2cfaa64910d4.png)

1. GitLab instance URL å’Œ registration token æˆ‘ä»¬å¯ä»¥åœ¨ gitlab é¡µé¢ä¸­æ‰¾åˆ° 

è·¯å¾„ï¼šéšä¾¿æ‰“å¼€ä¸€ä¸ªé¡¹ç›® -> è®¾ç½® -> CI/CD -> Runner -> å±•å¼€

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665551430841-8d469cf1-3847-48fc-b8b3-75037167307b.png)

è¾“å…¥å®Œæˆåï¼Œæˆ‘ä»¬åˆ·æ–° gitlab runner é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆ›å»ºçš„ runner äº†

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665983730670-318a4e83-10f2-49fb-936b-8dcb53e06907.png)

## ç¼–å†™ .gitlab-ci.yml æ–‡ä»¶

æœ‰äº† runnerï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥è·‘æµæ°´çº¿

### æµæ°´çº¿ä¸­çš„å¸¸ç”¨å‘½ä»¤

ä»¥ä¸‹å‘½ä»¤åªæ˜¯å¸¸ç”¨å‘½ä»¤çš„ç®€å•ç†è§£ï¼Œæ›´å¤šè¯¦ç»†çš„ä¿¡æ¯å’Œå…¶å®ƒå‘½ä»¤è¿˜è¡ŒæŸ¥é˜…[å®˜æ–¹æ–‡æ¡£](https://docs.gitlab.cn/jh/ci/yaml/)

#### image

æŒ‡å®šåŸºç¡€é•œåƒï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ npm æ‰§è¡Œç›¸å…³å‘½ä»¤ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ node é•œåƒ

#### workflow

æ¥ç¡®å®šæ˜¯å¦åˆ›å»ºæµæ°´çº¿ã€‚ åœ¨é¡¶å±‚å®šä¹‰æ­¤å…³é”®å­—ï¼Œä½¿ç”¨å•ä¸ª rules å…³é”®å­—æ¥åˆ¤æ–­

åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªå˜é‡`$CI_MERGE_REQUEST_TARGET_BRANCH_NAME` å’Œ `$CI_DEFAULT_BRANCH`

å½“åˆå¹¶ç›®æ ‡åˆ†æ”¯ä¸º `master`ï¼Œè¯¥æµæ°´çº¿æ‰èƒ½è¿è¡Œ

å…³äºæ›´å¤šçš„ç¯å¢ƒå˜é‡ï¼Œè¿˜è¯·æŸ¥é˜…[æ–‡æ¡£](https://docs.gitlab.cn/jh/ci/variables/predefined_variables.html)

#### stages

é˜¶æ®µï¼Œåœ¨ä¸Šå›¾ä¸­ï¼Œçº¢è‰²æ¡†å†…çš„å°±æ˜¯ stagesï¼Œinstallã€lintã€buildã€deploy å°±æ˜¯æˆ‘ä»¬å£°æ˜çš„é˜¶æ®µ

æ‹¿ä¸€ä¸ªå‰ç«¯é¡¹ç›®ä¸¾ä¾‹ï¼Œè¿™å››ä¸ªæ­¥éª¤æˆ‘ä»¬å¯ä»¥åšä»¥ä¸‹äº‹æƒ…

1. installï¼šæ‰§è¡Œ npm install ï¼Œå®‰è£…é¡¹ç›®æ‰€éœ€è¦çš„ä¾èµ–
2. lintï¼šæ‰§è¡Œ npm run lintï¼Œæ ¡éªŒé¡¹ç›®æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯æˆ–è€…ç±»å‹é”™è¯¯
3. buildï¼šæ‰§è¡Œ npm run buildï¼Œæ„å»ºå‰ç«¯é™æ€äº§ç‰©
4. deployï¼šå°† build æ„å»ºå‡ºçš„äº§ç‰©è¿›è¡Œéƒ¨ç½²![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665992433213-34c61d12-4a06-4c6c-92f7-62dc3f4d513e.png)

#### cache

job ä¹‹é—´ç¼“å­˜çš„æ–‡ä»¶ï¼Œåœ¨æ¯ä¸€ä¸ª job ä¹‹é—´å¯ä»¥å…±äº«

#### job

è¡¨ç¤ºæ„å»ºçš„ä½œä¸šï¼ˆæˆ–ç§°ä¹‹ä¸ºä»»åŠ¡ï¼‰ï¼Œä¸Šå›¾ï¼Œç»¿è‰²æ¡†ä¸­çš„å°±æ˜¯ job è¡¨ç¤ºæŸä¸ª stage é‡Œé¢æ‰§è¡Œçš„å…·ä½“ä»»åŠ¡

##### stage

æŒ‡å®šå½“å‰ job å±äºå“ªä¸€ä¸ª stages

##### script

å½“å‰ job éœ€è¦æ‰§è¡Œçš„ shell å‘½ä»¤

##### artifacts

å½“å‰ job æ‰§è¡Œåçš„äº§ç‰©ï¼Œå¯ä»¥é€šè¿‡ paths æŒ‡å®šäº§ç‰©çš„å­˜æ”¾è·¯å¾„ï¼Œexpire_in æŒ‡å®šäº§ç‰©çš„è¿‡æœŸæ—¶é—´

åœ¨è¿™åˆ†äº«ä¸€ä¸ªé¢è¯•é¢˜ï¼Œcatch å’Œ  artifacts æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

[å‚è€ƒæ–‡ç« ](https://blog.xinshangshangxin.com/2018/07/21/gitlab-ci-artifacts-cache/)

##### only

 å®šä¹‰å½“å‰ job åœ¨ä½•æ—¶è¿è¡Œã€‚

### ossutil64 ä½¿ç”¨

[è¯¦ç»†æ–‡æ¡£åœ°å€](https://help.aliyun.com/document_detail/120050.html)

-r ï¼šé€’å½’æ“ä½œ

-f ï¼šå¼ºåˆ¶æ“ä½œï¼Œä¸è¿›è¡Œè¯¢é—®æç¤º

--meta ï¼šé…ç½®æ–‡ä»¶å…ƒä¿¡æ¯ ï¼ˆheaderï¼‰

### .gitlab-ci.yml ç®€å•ç¤ºä¾‹

```yaml
image: node:14-alpine

# åªæœ‰å¾€ master åˆ†æ”¯åˆå¹¶çš„æ—¶å€™æ‰æ‰§è¡Œæ­¤æµæ°´çº¿
workflow:
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      when: always

# å®šä¹‰ä¸‰ä¸ªé˜¶æ®µ
stages:
  - install
  - build
  - deploy

# ç¼“å­˜äº§ç‰©ï¼Œåœ¨å¤šä¸ª job ä¹‹é—´å…±äº«
cache:
  - key: node-modules
    paths:
      - node_modules

install:
  stage: install
  script:
    - npm install cnpm --global --registry=https://registry.npmmirror.com
    - cnpm i
  only: # åªæœ‰ package.json æ–‡ä»¶æ›´æ”¹æ—¶ï¼Œæ‰é‡æ–°è·‘ install
    changes:
      - "package.json"
  retry: 2 # install å¤±è´¥é‡è¯•æ¬¡æ•°

build:
  stage: build
  script: npm run build
  artifacts:
    paths:
      - dist
    expire_in: 1 hrs # è®¾ç½®ä½œå“ç•™å­˜æ—¶é—´ï¼Œ1å°æ—¶åè‡ªåŠ¨å¤±æ•ˆ

# ä½¿ç”¨ oss è„šæœ¬ä¸Šä¼ 
deploy:
  stage: deploy
  script:
    - wget https://gosspublic.alicdn.com/ossutil/1.7.14/ossutil64
    - chmod 755 ossutil64
    - ./ossutil64 config -i ${accessKeyID} -k ${accessKeySecret} -e ${endPoint} -L CH -c ~/.ossutilconfig
    - ./ossutil64 -c ~/.ossutilconfig cp -r -f --meta Cache-Control:no-cache dist oss://tutulist-web-static/
    - ./ossutil64 -c ~/.ossutilconfig cp -r -f --meta Cache-Control:max-age=31536000 dist/assets oss://tutulist-web-static/assets

# ä½¿ç”¨ oss sdkä¸Šä¼ 
# deploy:
#   stage: deploy
#    script: npm run deploy:oss
```

### deployOss.js éƒ¨ç½²è„šæœ¬

1. ä¸å¸¦ `hash` çš„æ–‡ä»¶ï¼Œè®¾ç½® `no-cache`å¹¶ç›´æ¥ä¸Šä¼ 
2. å¸¦ `hash` çš„æ–‡ä»¶ï¼Œä¸Šä¼ å‰å…ˆåˆ¤æ–­ `oss` ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œä¸å­˜åœ¨æ‰ä¸Šä¼ ï¼Œå¹¶é…ç½®  1 å¹´çš„ç¼“å­˜æ—¶é—´
3. ä¸Šä¼ å®Œæˆåï¼Œå°†æœ¬åœ°çš„æ„å»ºäº§ç‰© å’Œ `oss` ä¸Šçš„æ–‡ä»¶è¿›è¡Œå¯¹æ¯”ï¼Œåˆ é™¤ `oss` å†—ä½™çš„æ–‡ä»¶

```javascript
import fs from "node:fs/promises";

import { dirname } from "node:path";
import { fileURLToPath } from "node:url";

import dotEnv from "dotenv";
import OSS from "ali-oss";

// è·å–ç¯å¢ƒå˜é‡
dotEnv.config();

const __filename = fileURLToPath(import.meta.url);
const distPath = `${dirname(__filename)}/dist`;

const client = new OSS({
  region: "oss-cn-beijing",
  accessKeyId: process.env.ACCESS_KEY_ID,
  accessKeySecret: process.env.ACCESS_KEY_SECRET,
  bucket: "tutulist-web-static",
});

const deploy = async () => {
  await uploadNoCacheFile();
  await uploadCacheFile();
  // åˆ é™¤å†—ä½™ oss æ–‡ä»¶
  await removeExtraFile();
};

const uploadNoCacheFile = async () => {
  const dir = await fs.opendir(distPath);
  // ä¸Šä¼ é hash èµ„æº
  for await (const dirent of dir) {
    if (dirent.name !== "assets") {
      await client.put(dirent.name, `${distPath}/${dirent.name}`, {
        headers: {
          "Cache-Control": "no-cache",
        },
      });
    }
  }
  console.log("ğŸš€ é hash æ–‡ä»¶ä¸Šä¼ æˆåŠŸ");
};

// ä¸Šä¼ å¸¦ hash çš„èµ„æº
const uploadCacheFile = async () => {
  const assetPath = `${distPath}/assets`;
  const dir = await fs.opendir(assetPath);
  for await (const dirent of dir) {
    const filePath = `assets/${dirent.name}`;
    const isExist = await isExistObject(filePath);
    if (!isExist) {
      await client.put(`assets/${dirent.name}`, `${assetPath}/${dirent.name}`, {
        headers: {
          "Cache-Control": "max-age=31536000",
        },
      });
    }
  }
  console.log("ğŸš€ hash æ–‡ä»¶ä¸Šä¼ æˆåŠŸ");
};

const isExistObject = async (name, options = {}) => {
  try {
    await client.head(name, options);
    return true;
  } catch (error) {
    return false;
  }
};

// åˆ é™¤è€çš„æ–‡ä»¶
const removeExtraFile = async () => {
  const { res, objects } = await client.list({
    prefix: "assets/",
  });
  // å°†æœ€åä¸€æ¬¡çš„äº§ç‰©ä¸ oss ä¸­å·²æœ‰çš„åšå¯¹æ¯”ï¼Œå°†ä¸å­˜åœ¨çš„è¿›è¡Œåˆ é™¤
  if (res.status === 200) {
    const notExistFileList = [];
    const __filename = fileURLToPath(import.meta.url);
    const distPath = `${dirname(__filename)}/dist`;

    for (let ossPath of objects) {
      try {
        await fs.access(`${distPath}/${ossPath.name}`);
      } catch (error) {
        notExistFileList.push(ossPath.name);
      }
    }

    if (notExistFileList.length) {
      client.useBucket("tutulist-web-static");

      console.log("ğŸš€ å‘ç° oss ä¸­å­˜åœ¨å†—ä½™æ–‡ä»¶ï¼Œæ­£åœ¨åˆ é™¤ã€‚ã€‚ã€‚");
      try {
        const {
          res: { status },
        } = await client.deleteMulti(notExistFileList);
        if (status === 200) {
          console.log("ğŸš€ å†—ä½™ oss æ–‡ä»¶å·²åˆ é™¤");
        }
      } catch (error) {
        console.log(`âŒ å†—ä½™ oss æ–‡ä»¶ åˆ é™¤å¤±è´¥`);
      }
    } else {
      console.log("â—ï¸ æœªå‘ç°å†—ä½™ oss æ–‡ä»¶");
    }
    process.exit(0);
  }
};

// æ‰§è¡Œéƒ¨ç½²ä»£ç ;
deploy();
"script": {
  ...å¿½ç•¥å…¶å®ƒ
  "deploy oss": "node deployOss.js",
}
```

tipsï¼šåœ¨éƒ¨ç½²æ—¶è¿˜æ˜¯é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜äº†ï¼Œæ¯æ¬¡ä½¿ç”¨ `vite` æ„å»ºæ—¶ï¼Œä¸ç®¡æ–‡ä»¶å†…å®¹æœ‰æ²¡æœ‰æ›´æ”¹ï¼Œæ–‡ä»¶çš„ `hash` éƒ½ä¼šå˜ï¼Œè¿™å°±ä»£è¡¨ç€ï¼Œåœ¨ä½¿ç”¨éƒ¨ç½²è„šæœ¬æ—¶ï¼Œæ¯æ¬¡ä¸Šä¼ åˆ° `oss` éƒ½æ˜¯å…¨é‡çš„æ¨é€ã€‚

ç›®å‰æ–‡ä»¶ `hash` è¿™ä¸ªé—®é¢˜ `github` å·²ç»æœ‰è¿™ä¸ª [issue](https://github.com/vitejs/vite/issues/6773) äº†ï¼Œä½†è¿˜æ˜¯ `open` çŠ¶æ€ï¼ŒæŒç»­å…³æ³¨ç€å§ã€‚ä¸è¿‡ï¼Œæˆ‘çŒœ `vue-cli` ä¸€å®šä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ ğŸ¶ğŸ¶ğŸ¶

### é…ç½®  CI/CD å˜é‡

åœ¨é€šè¿‡ `ossutil` éƒ¨ç½²æ—¶ï¼Œå¯¹äº `oss` çš„å¯†é’¥ï¼Œå¦‚æœä¸æƒ³ç›´æ¥å†™æ˜æ–‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å£°æ˜`CI/CD`å˜é‡çš„å½¢å¼æ³¨å…¥åˆ°è„šæœ¬ä¸­ï¼Œæœ€ç»ˆåœ¨ `yml`æ–‡ä»¶ä¸­å¯ä»¥é€šè¿‡  `${å˜é‡}` çš„å½¢å¼è·å–

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665986739287-855f58d8-e84f-4e8a-96a1-c5675e62e9ba.png)

## é˜¿é‡Œäº‘ oss å¯¹è±¡å­˜å‚¨

### åˆ›å»º Bucket

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665986109626-1e1f83bd-35c9-4c23-9998-e0f785230db1.png)

#### é…ç½® Bucket è¯»å†™æƒé™

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1666008504201-6b4398e6-a3c9-4aa5-8b02-16103b31c9a5.png)

#### é…ç½®é™æ€é¡µé¢

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1666008574190-91577ffd-7000-409d-b3f5-20df0fcc6b28.png)

#### ç»‘å®šåŸŸå

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1666008703787-093a0b14-6b5c-4c8b-8bb3-d5dd0c952eae.png)

å‹¾é€‰è‡ªåŠ¨æ·»åŠ  `CNAME` è®°å½•ï¼Œå°† `oss` åŸŸå å’Œè‡ªå·±åŸŸåè¿›è¡Œç»‘å®š

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1666008838991-a5623074-9664-4d15-a246-cae1d2d85b88.png)

## åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œè¿›è¡Œæµ‹è¯•

å½“æˆ‘ä»¬å°†åŠŸèƒ½åˆ†æ”¯åˆå¹¶åˆ° master åˆ†æ”¯æ—¶ï¼Œæµæ°´çº¿å°±å¼€å§‹å·¥ä½œäº†

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1666267748656-a1f18ecb-99ba-42aa-bfe7-27758a704af1.png)