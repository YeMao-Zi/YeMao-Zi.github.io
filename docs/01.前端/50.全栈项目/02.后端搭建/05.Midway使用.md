---
title: Midwayä½¿ç”¨
date: 2023-07-11 16:23:59
permalink: /pages/ebcdfa/
categories:
  - å‰ç«¯
  - å…¨æ ˆé¡¹ç›®
  - åç«¯æ­å»º
tags:
  - 
author: 
  name: å¤œçŒ«å­
  link: https://github.com/yemao-zi
titleTag: 
---
### è·¯ç”±å’Œæ§åˆ¶å™¨

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè§[å®˜æ–¹æ–‡æ¡£](http://www.midwayjs.org/docs/controller)

æ ¹æ®ä¸šåŠ¡ï¼Œæˆ‘ä»¬åˆ†äº†ä¸€ä¸‹ä»¥ä¸‹ 5 ä¸ªæ§åˆ¶å™¨ï¼Œç”¨äºå¤„ç†ä¸åŒä¸šåŠ¡

![img](https://s2.loli.net/2023/09/05/2mPMIjRsu8OBtv6.png)

**calendar.controller**

- æ—¥å†è§†è§’ã€æ—¶é—´å››è±¡é™

**cos.controller**

- è…¾è®¯äº‘ cosï¼Œæ–‡ä»¶ä¸Šä¼ ç›¸å…³

**setting.controller**

- ç”¨æˆ·è®¾ç½®

**todoBox.controller**

- å¾…åŠç®±

**user.controller**

- ç™»å½•æ³¨å†Œã€ä¸ªäººä¿¡æ¯

#### è®¾ç½®å…¨å±€è·¯ç”±å‰ç¼€

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåç«¯çš„æ¥å£åœ°å€éƒ½æ˜¯ä»¥ `/api` å¼€å¤´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `config.default.ts` æ–‡ä»¶ä¸­é…ç½®ï¼Œå°†æ‰€æœ‰çš„æ§åˆ¶å™¨éƒ½åŠ ä¸Šè¯¥å‰ç¼€

```javascript
export default {
  koa: {
    globalPrefix: '/api',
    port: 7001,
  },
}
```

#### å®šä¹‰ä¸€ä¸ª controller 

```
@inject`ï¼šæ³¨å…¥ç›¸å…³çš„ `Service
```

`@Put @Get`ï¼šå®šä¹‰ `http` è¯·æ±‚æ–¹å¼

`@Param`ï¼šè·å– `Params` å‚æ•°

![img](https://s2.loli.net/2023/09/05/mKZOFLWV2nb9jrh.png)

**Java å®ï¼Œä½ çœ‹æˆ‘ä»¬ä¿©ï¼Œåƒå—ï¼Ÿ**

ä»é¡µé¢ä»” åˆ° Spring ä»”ï¼Œå…¶å®ä¹Ÿå¾ˆå¿« ğŸ¶ğŸ¶ğŸ¶

![img](https://s2.loli.net/2023/09/05/dQmHegXpOBbyhtC.png)

#### å…³äºè£…é¥°å™¨è¯­æ³•

ä»¥ä¸‹æ˜¯é¢˜å¤–è¯ï¼Œå®ƒæ˜¯å®ç°è£…é¥°å™¨è¯­æ³•çš„å…³é”®ï¼ŒçŸ¥ä¹ä¸Šä¹Ÿæœ‰å¥½å¤šå…³äºè£…é¥°å™¨çš„å›ç­”ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´è‡ªè¡ŒæŸ¥çœ‹å•¦

##### [Reflect Metadata](https://jkchao.github.io/typescript-book-chinese/tips/metadata.html#åŸºç¡€)

### æœåŠ¡å’Œæ³¨å…¥

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè§ [å®˜æ–¹æ–‡æ¡£](http://www.midwayjs.org/docs/service)

æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ•°æ®åº“çš„ CRUDï¼Œéƒ½ä¼šå†™åœ¨è¿™é‡Œ

å®ƒé€šè¿‡ `@Provide()` è£…é¥°å™¨æš´éœ²è¯¥æœåŠ¡ã€‚åœ¨`Controller` æˆ–è€…ä»£ç è°ƒç”¨å¤„é€šè¿‡ `@Inject()` è£…é¥°å™¨æ³¨å…¥ 

```typescript
@Provide()
export class SettingService {
  @InjectEntityModel(SettingInfo)
  settingModel: Repository<SettingInfo>;

  @Inject()
  jwtService: JwtService;

  @Inject()
  ctx: Context;

  async saveSetting(settingInfo: SaveSettingDTO) {
    const { userId } = await getHeaderAuthInfo<TokenPayloadType>(
      this.jwtService,
      this.ctx.get('authorization')
    );

    const setting = await this.settingModel.findOneBy({ userId });
    if (setting) {
      await this.settingModel.update(userId, settingInfo);
      return 'ok';
    } else {
      const { startWeek, weekName } = settingInfo;
      const setting = await this.settingModel.create({
        userId,
        startWeek,
        weekName,
      });
      await this.settingModel.save(setting);
      return 'ok';
    }
  }
}
```



### ä¸­é—´ä»¶

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè§ [å®˜æ–¹æ–‡æ¡£](http://www.midwayjs.org/docs/middleware)

Web ä¸­é—´ä»¶æ˜¯åœ¨æ§åˆ¶å™¨è°ƒç”¨ **ä¹‹å‰** å’Œ **ä¹‹å**ï¼ˆéƒ¨åˆ†ï¼‰è°ƒç”¨çš„å‡½æ•°ã€‚

![img](https://s2.loli.net/2023/09/05/1DJLliV7qIbxm8O.png)

åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç¼–å†™äº†ä»¥ä¸‹ ä¸¤ä¸ªä¸­é—´ä»¶

- åœ¨æ§åˆ¶å™¨è°ƒç”¨å‰ï¼Œé€šè¿‡`jwt.middleware` å»æ ¡éªŒ  `token` çš„åˆæ³•æ€§
- åœ¨æ§åˆ¶å™¨è°ƒç”¨åï¼Œé€šè¿‡`response.middware` ç»Ÿä¸€è¿”å›çš„æ•°æ®ç»“æ„

#### jwt.middleware

åœ¨ä¸šåŠ¡ä¸­æ¯”å¦‚ ç™»å½•æ³¨å†Œ è¿™ä¸€ç±»çš„è¯·æ±‚åœ¨è¯·æ±‚å¤´ä¸­æ˜¯ä¸ä¼šæºå¸¦  `token` çš„ï¼Œå¯¹äºè¿™ä¸€ç±»çš„è¯·æ±‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å£°æ˜`ignore`æ–¹æ³•è¦å°†å…¶å¿½ç•¥æ‰ã€‚

```javascript
import { Inject, Middleware } from '@midwayjs/decorator';

import { httpError } from '@midwayjs/core';
import { JwtService } from '@midwayjs/jwt';

import type { Context, NextFunction } from '@midwayjs/koa';
@Middleware()
export class JwtMiddleware {
  @Inject()
  jwtService: JwtService;

  resolve() {
    return async (ctx: Context, next: NextFunction) => {
      // åˆ¤æ–­ä¸‹æœ‰æ²¡æœ‰æ ¡éªŒä¿¡æ¯
      if (!ctx.headers['authorization']) {
        throw new httpError.BadRequestError();
      }
      // ä» header ä¸Šè·å–æ ¡éªŒä¿¡æ¯
      const parts = ctx.get('authorization').trim().split(' ');

      if (parts.length !== 2) {
        throw new httpError.BadRequestError();
      }

      const [scheme, token] = parts;

      if (/^Bearer$/i.test(scheme)) {
        try {
          await this.jwtService.verify(token, {
            complete: true,
          });
        } catch (error) {
          throw new httpError.UnauthorizedError();
        }
        await next();
      } else {
        throw new httpError.ForbiddenError();
      }
    };
  }

  ignore(ctx: Context): boolean {
    const ignorePathList = [
      '/api/user/register',
      '/api/user/sendCode',
      '/api/user/loginByPassword',
      '/api/user/loginByCode',
      '/api/user/forgetPassword',
      '/api/user/refreshToken',
    ];
    return ignorePathList.includes(ctx.path);
  }
}
```

#### response.middware

é€šè¿‡`await next()` æ–¹æ³•çš„è°ƒç”¨ ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ° æ§åˆ¶å™¨è¿”å›çš„æ‰§è¡Œç»“æœï¼Œæœ€ç»ˆåŒ…è£…åè¿”å›ç»™å‰ç«¯ï¼ˆè°ƒç”¨æ–¹ï¼‰ï¼›

å£°æ˜ `match` æ–¹æ³•ï¼Œåªæœ‰åŒ¹é…åˆ°çš„è·¯ç”±æ‰ä¼šæ‰§è¡Œè¯¥ä¸­é—´

```javascript
import { IMiddleware } from '@midwayjs/core';
import { Middleware } from '@midwayjs/decorator';
import { NextFunction, Context } from '@midwayjs/koa';
/**
 * Response ä¸­é—´ä»¶ï¼Œè¿”å›æˆåŠŸæ€çš„ response
 */
@Middleware()
export class ResponseMiddleware implements IMiddleware<Context, NextFunction> {
  resolve() {
    return async (_ctx: Context, next: NextFunction) => {
      const data = await next();
      return {
        code: 200,
        msg: 'ok',
        data,
      };
    };
  }

  static getName = (): string => 'response';

  match = ctx => ctx.path.indexOf('/api') !== -1;
}
```



### å¼‚å¸¸å¤„ç†

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè§ [å®˜æ–¹æ–‡æ¡£](http://www.midwayjs.org/docs/error_filter)

å¯¹äºå¼‚å¸¸å¤„ç†ï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œ**http çš„å¼‚å¸¸å¤„ç†** å’Œ **ä¸šåŠ¡çš„å¼‚å¸¸å¤„ç†**

#### http å¼‚å¸¸å¤„ç†

`midway` å®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº† `httpError` è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å†…ç½®äº†ç›¸å…³é”™è¯¯æ¶ˆæ¯å’ŒçŠ¶æ€ç ã€‚æ¯”å¦‚è¯´ 401ï¼Œ403ï¼Œ503 è¿™ç§çš„ `http` çŠ¶æ€ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡ `throw` çš„æ–¹å¼å¾€å¤–æŠ›

![img](https://s2.loli.net/2023/09/05/RS6m3MkNTesu7tx.png)

#### ä¸šåŠ¡å¼‚å¸¸å¤„ç†

åœ¨æˆ‘ä»¬çš„æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¾€å¾€ä¹Ÿä¼šå’Œå‰ç«¯å®šä¹‰ä¸€äº›ä¸šåŠ¡ä¸Šçš„çŠ¶æ€ç ã€‚

æ¯”å¦‚æˆ‘ä»¬åœ¨è¿”å›çš„æ•°æ®ç»“æ„ä¸­å’Œå‰ç«¯çº¦å®šåªæœ‰ code ä¸º 200 çš„æƒ…å†µä¸‹è¯¥è¯·æ±‚æ‰ç®—æˆåŠŸï¼Œé 200 çš„æƒ…å†µä¸‹éƒ½ä¸ºå¼‚å¸¸ã€‚

![img](https://s2.loli.net/2023/09/05/pU8NBCX6RqPc9Ef.png)![img](https://s2.loli.net/2023/09/05/RbXUZJO4coQNBAP.png)

##### è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹

å®šä¹‰ä¸€ä¸ª `DefaultError` ç”¨äºå¤„ç†ä¸šåŠ¡ä¸Šçš„å¼‚å¸¸ï¼Œå¹¶ç»Ÿä¸€æŠ›çŠ¶æ€ç  500

```typescript
import { HttpStatus, MidwayError } from '@midwayjs/core';
// ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œç»Ÿä¸€å¾€å¤–æŠ› 500 çŠ¶æ€ç 
export class DefaultError extends MidwayError {
  constructor(message: string) {
    super(message, HttpStatus.INTERNAL_SERVER_ERROR.toString());
  }
}
// ä½¿ç”¨
if (password !== userPassword) {
  throw new DefaultError('è´¦å·æˆ–å¯†ç é”™è¯¯');
}
```

#### å¼‚å¸¸å¤„ç†å™¨

é€šè¿‡ `@Catch()` è£…é¥°å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æ•è·å…¨å±€çš„é”™è¯¯ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­æŠ›å‡ºçš„ `DefaultError` ä¹Ÿä¼šèµ°åˆ°è¿™ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ‹¿åˆ°ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ï¼Œæœ€ç»ˆè¿”å›ç»Ÿä¸€çš„æ ¼å¼

å½“ç„¶`@Catch()` ä¹Ÿå¯ä»¥æ•è·ç‰¹å®šçš„é”™è¯¯ï¼Œå°±çœ‹ä½ å¾€ `@Catch()` é‡Œé¢ä¼ é€’ä»€ä¹ˆæ ·çš„å‚æ•°äº†

```javascript
import { MidwayError } from '@midwayjs/core';
import { Catch } from '@midwayjs/decorator';
import { Context } from '@midwayjs/koa';

// æ•è·æ‰€æœ‰é”™è¯¯
@Catch()
export class DefaultErrorFilter {
  async catch(err: MidwayError, ctx: Context) {
    // é”™è¯¯æ—¥å¿—
    ctx.logger.error('%j', err);
    return {
      code: err.code ?? 500,
      message: err.message ?? 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      data: null,
    };
  }
}
```

##### `configuration.ts`ä¸­ä½¿ç”¨å¼‚å¸¸å¤„ç†å™¨

```javascript
export class ContainerLifeCycle {
  @App()
  app: koa.Application;

  async onReady() {
    // add middleware
    this.app.useMiddleware([ResponseMiddleware, JwtMiddleware]);
    // add filter
    this.app.useFilter([DefaultErrorFilter]);
  }
}
```

### å‚æ•°æ ¡éªŒ

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè§ [å®˜æ–¹æ–‡æ¡£](http://www.midwayjs.org/docs/extensions/validate)

å¯¹äºå‰ç«¯é€šè¿‡è¯·æ±‚ä¼ æ¥çš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„ `Validate` ç»„ä»¶è¿›è¡Œæ ¡éªŒï¼›

æ¯”å¦‚å¯¹æ•°æ®æ ¼å¼çš„æ ¡éªŒã€æ˜¯å¦ä¼ é€’å¿…ä¼ å­—æ®µã€å­—æ®µæ˜¯å¦å¯ä»¥ä¼ ç©ºã€æšä¸¾å€¼çš„å¤„ç†ç­‰ã€‚



å› ä¸º `Validate` ç»„ä»¶æ˜¯åŸºäº [joi](https://joi.dev/api/) çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ä½¿ç”¨ `joi` çš„ç›¸å…³æ’ä»¶è¿›è¡Œæ‰©å±•ï¼Œæ¯”å¦‚åœ¨é¡¹ç›®ä¸­æˆ‘ä»¬ä½¿ç”¨äº† `joiDate` å»æ ¡éªŒæ—¥æœŸæ ¼å¼

å¦å¤–å®˜æ–¹äº†ä¹Ÿæä¾›äº† `PickDto` å’Œ `OmitDto` å¯ä»¥å¯¹åŸæœ‰çš„ `DTO` è¿›è¡Œæ‰©å±•ã€‚



ä»¥ä¸‹æ˜¯ç›¸å…³çš„ä½¿ç”¨æ¡ˆä¾‹

```javascript
import joiDate from '@joi/date';

export class EventInfoDTO {
  @Rule(RuleType.number())
  id: number;

  // é€šè¿‡ joiDate æ ¡éªŒæ—¥æœŸæ ¼å¼
  @Rule(
    RuleType.extend(joiDate)
      .date()
      .format('YYYY-MM-DD')
      .required()
      .error(new Error('startTime æ—¥æœŸæ ¼å¼ä¸º YYYY-MM-DD'))
  )
  startTime: Date;

  // allow è™½ç„¶è¯¥å­—æ®µå¿…ä¼ ï¼Œä½†å…è®¸ä¸º ç©ºå­—ç¬¦ä¸²
  @Rule(
    RuleType.string()
      .max(200)
      .allow('')
      .required()
      .error(new Error('description å­—æ®µé™åˆ¶ 200 ä½ä»¥å†…çš„å­—ç¬¦'))
  )
  description: string;

  // å¤„ç†æšä¸¾ç±»å‹
  @Rule(RuleType.number().valid(DoneEnum.DONE, DoneEnum.UNDONE).required())
  isDone: DoneEnum;
}
```
