---
title: æœåŠ¡å™¨éƒ¨ç½²
date: 2023-07-11 16:28:16
permalink: /pages/b292f1/
categories:
  - å‰ç«¯
  - å…¨æ ˆé¡¹ç›®
  - å‰ç«¯éƒ¨ç½²
tags:
  - 
author: 
  name: å¤œçŒ«å­
  link: https://github.com/yemao-zi
titleTag: 
---
## æŠ€æœ¯æ–¹æ¡ˆ

1. é€šè¿‡ `docker` è¿è¡Œä¸€ä¸ª `nginx` å®¹å™¨ï¼Œå¹¶æŒ‚è½½å®¿ä¸»æœºç›®å½•ï¼›
2. å‰ç«¯ç¼–å†™ `deploy.js` ä¸Šä¼ è„šæœ¬ï¼Œå°†é™æ€èµ„æºä¸Šä¼ åˆ°ä¸è¯¥ `nginx` å®¹å™¨å…³è”çš„å®¿ä¸»æœºç›®å½•ä¸­

## å®‰è£… Nginx

### åŸºäº Docker å®‰è£… Nginx

### å®‰è£…å‘½ä»¤

```
docker pull nginx
```

### å¯åŠ¨ä¸€ä¸ªç®€å•çš„ Nginx é•œåƒ

#### æ˜¯å¦æˆåŠŸå®‰è£… Nginx é•œåƒ

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665897374554-5756f5a0-555e-4f72-a778-275fd4738fd8.png)

#### è¿è¡Œä¸€ä¸ª nginx å®¹å™¨

```
docker run -d -p 80:80 --name nginx nginx
```

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665567446027-c1b0d92b-9278-4c77-8b9b-83c496dd1559.png)

### ä¿®æ”¹ Nginx é…ç½®æ–‡ä»¶ 

æ ¹æ®åœºæ™¯æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼Œè¿›å…¥å®¹å™¨ç›´æ¥ä¿®æ”¹ æˆ–è€… å°†é•œåƒå†…çš„é…ç½®æ–‡ä»¶ä¸å®¿ä¸»æœºçš„æ–‡ä»¶ç›®å½•åšä¸€ä¸ªæ˜ å°„

#### è¿›å…¥å®¹å™¨å†…éƒ¨ç›´æ¥ä¿®æ”¹

åªé€‚ç”¨äºä¿®æ”¹é¢‘ç‡ä¸é«˜çš„åœºæ™¯ï¼Œæ¯æ¬¡ä¿®æ”¹é…ç½®éœ€è¿›å…¥å®¹å™¨å†…éƒ¨

##### æŸ¥çœ‹å®¹å™¨ id å¹¶è¿›å…¥å®¹å™¨å†…éƒ¨

`docker ps` æŸ¥çœ‹å®¹å™¨åˆ—è¡¨

```
docker exec -it å®¹å™¨id /bin/bash
```

`exit`é€€å‡ºå®¹å™¨

##### Nginx å®¹å™¨å†…éƒ¨å¤§è‡´ç›®å½•ç»“æ„

`/etc/nginx`: é…ç½®æ–‡ä»¶ç›®å½•

`/var/log/nginx`: æ—¥å¿—ç›®å½•

`/usr/share/nginx/html`ï¼šé»˜è®¤å‰ç«¯ä»£ç ç›®å½•

#### é…ç½®æ–‡ä»¶æ˜ å°„åˆ°å®¿ä¸»æœºæ–‡ä»¶

##### åˆ›å»ºå®¿ä¸»æœºæŒ‚è½½ç›®å½•

1. å›åˆ°æœåŠ¡å™¨æ ¹ç›®å½•

```
cd ~
```

1. åˆ›å»ºæ–‡ä»¶

```
mkdir -p home/nginx/{html,log,conf}
```

1. 1. html: å­˜æ”¾å‰ç«¯ html é¡µé¢
   2. log: å­˜æ”¾ Nginx logï¼ŒåæœŸå¯ä»¥æŸ¥çœ‹ access  å’Œ error æ—¥å¿—
   3. conf:  å­˜æ”¾ nginx é…ç½®

##### å°†å®¹å™¨å†…é…ç½®æ–‡ä»¶æ‹·è´åˆ°å®¿ä¸»

æ ¹ç›®å½•ä¸‹æ‰§è¡Œ

```
docker cp å®¹å™¨id:/etc/nginx/nginx.conf ./home/nginx/conf/nginx.conf
docker cp å®¹å™¨id:/etc/nginx/conf.d ./home/nginx/conf/conf.d
docker cp å®¹å™¨id:/usr/share/nginx/html ./home/nginx
```

#### å…³é—­å¹¶åˆ é™¤ä¹‹å‰å¯åŠ¨çš„ Nginx å®¹å™¨

```
docker stop å®¹å™¨id
docker rm -f å®¹å™¨id
```

#### å¯åŠ¨æ–°çš„  Nginx å®¹å™¨

ä½¿ç”¨ `--mount`å‘½ä»¤æŒ‚è½½å®¿ä¸»æœºçš„æ–‡ä»¶å’Œç›®å½•ä½œä¸ºæ•°æ®å·

```shell
docker run -d \
-p 80:80 \
--name nginx \
--mount type=bind,source=$HOME/home/nginx/conf/nginx.conf,target=/etc/nginx/nginx.conf \
--mount type=bind,source=$HOME/home/nginx/conf/conf.d,target=/etc/nginx/conf.d \
--mount type=bind,source=$HOME/home/nginx/log,target=/var/log/nginx \
--mount type=bind,source=$HOME/home/nginx/html,target=/usr/share/nginx/html \
nginx
```

#### æµ‹è¯•æ˜¯å¦æŒ‚è½½æˆåŠŸ

1. æ›´æ”¹ home/nginx/html/index.html é¡µé¢

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665594199704-5bcc0600-6e59-4a2b-9592-84259d2eb0e8.png)

1. `docker restart å®¹å™¨id`

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665594242187-d9c6d656-cf98-451d-8ca6-e286a1b3f502.png)

## ä¸Šä¼ å‰ç«¯é™æ€èµ„æº

ä¸Šä¸€æ­¥æˆ‘ä»¬æŒ‚è½½äº†å®¿ä¸»æœºç›®å½•/æ–‡ä»¶ä½œä¸º `Nginx`å®¹å™¨çš„æ•°æ®å·;

æ¥ä¸‹æ¥æˆ‘ä»¬å°† `Vue` æˆ–è€… `React` æ‰“åŒ…ç”Ÿæˆçš„ `dist` æˆ– `build` ä¸Šä¼ åˆ° `home/nginx/html`ä¸­ï¼Œå¹¶ç®€å•é…ç½®ä¸€ä¸‹ `Nginx`ï¼Œæˆ‘ä»¬çš„å‰ç«¯éƒ¨ç½²å°±ç®—æ˜¯å®Œæˆäº†

### åˆ›å»ºä¸€ä¸ª Vue3 é¡¹ç›®

```shell
pnpm create vite vue3-app --template vue-ts

cd vue3-app

pnpm install

pnpm run dev
```

### ç¼–å†™éƒ¨ç½²è„šæœ¬

#### å¤§è‡´æµç¨‹

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1666541333468-0f5ba80c-7b81-4f19-8e37-36bf8dbdf4af.png)

#### éœ€è¦ç”¨çš„ä¸‰æ–¹åº“

```
npm i node-ssh compressing dotenv inquirer ora --save-dev
```

1. `compressing`ï¼šæ–‡ä»¶å‹ç¼©
2. `inquirer`ï¼šå‘½ä»¤è¡Œäº¤äº’å·¥å…·
3. `dotEnv`ï¼šè·å–åœ¨ `.env` æ–‡ä»¶ä¸­å®šä¹‰çš„ç¯å¢ƒå˜é‡
4. `node-ssh`ï¼š`ssh` å·¥å…·ï¼Œç™»å½•è¿œç¨‹æœåŠ¡å™¨
5. `ora`ï¼šæ‰§è¡Œ `npm run build` æ—¶ï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ·»åŠ  `loading`æ•ˆæœ

#### deploy.js 

```javascript
import fs from "node:fs/promises";
import { dirname } from "node:path";
import { fileURLToPath } from "node:url";
import childProcess from "node:child_process";

import ora from "ora";
import { NodeSSH } from "node-ssh";
import compressing from "compressing";
import dotEnv from "dotenv";
import inquirer from "inquirer";

const BUILD_SCRIPT = "npm run build";

const deploy = async () => {
  // éœ€è¦åˆ›å»º .env æ–‡ä»¶ï¼Œå¹¶åœ¨ .env æ–‡ä»¶ä¸­å®šä¹‰æœåŠ¡å™¨ host åœ°å€
  const { HOST } = process.env;
  if (!HOST) {
    console.log("ğŸ¤”ğŸ¤”éƒ¨ç½²å¤±è´¥ï¼Œç¯å¢ƒå˜é‡æ— æ³•åŠ è½½");
    process.exit(0);
  }
  const config = {
    host: HOST,
    deployType: "deploy",
  };
  inquirer
    .prompt([
      {
        type: "input",
        message: "ğŸ˜„ğŸ˜„è¯·è¾“å…¥æœåŠ¡å™¨ç”¨æˆ·å",
        name: "username",
      },
      {
        type: "password",
        message: "ğŸ«£ ğŸ«£ è¯·è¾“å…¥æœåŠ¡å™¨å¯†ç ",
        name: "password",
        when: (answers) => answers.username,
      },
      {
        type: "list",
        message: "è¯·é€‰æ‹©éƒ¨ç½²æ–¹å¼",
        name: "deployType",
        choices: [
          { value: "deploy", name: "éƒ¨ç½²æ–°ç‰ˆ" },
          { value: "reset", name: "å›é€€ç‰ˆæœ¬" },
        ],
        when: (answers) => answers.username && answers.password,
      },
    ])
    .then(({ username, password, deployType }) => {
      config.username = username;
      config.password = password;
      config.deployType = deployType;
      // è¿æ¥æœåŠ¡å™¨
      connectServer(config);
    })
    .catch((err) => {
      console.log(err);
    });
};

const connectServer = async (config) => {
  try {
    const ssh = new NodeSSH();
    await ssh.connect({
      host: config.host,
      username: config.username,
      password: config.password,
      tryKeyboard: true,
    });
    console.log("ğŸš€ æœåŠ¡å™¨è¿æ¥æˆåŠŸ");
    if (config.deployType === "deploy") {
      handleUpload(ssh);
    }

    if (config.deployType === "reset") {
      handleReset(ssh);
    }
  } catch (error) {
    console.log("âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®ğŸ¤”ğŸ¤”");
    process.exit(0);
  }
};

const handleReset = async (ssh) => {
  const sftp = await ssh.requestSFTP();
  sftp.exists("/root/home/nginx/html/dist-last", async (boolean) => {
    if (boolean) {
      await ssh.execCommand("cd home/nginx/html && rm -rf dist");
      await ssh.execCommand("cd home/nginx/html && mv dist-last dist");
      await ssh.execCommand("docker restart nginx");
      console.log("ğŸš€ docker nginx é•œåƒå¼€å§‹é‡å¯");
      console.log("ğŸš€ğŸš€ğŸš€ å›é€€æˆåŠŸ ğŸš€ğŸš€ğŸš€");
      process.exit(0);
    } else {
      console.log("âŒ å›æ»šå¤±è´¥ï¼Œæœªå‘ç°å¤‡ä»½äº§ç‰©");
      process.exit(0);
    }
  });
};

const handleZipFile = () => {
  // eslint-disable-next-line no-async-promise-executor
  return new Promise(async (resolve, reject) => {
    try {
      await compressing.tar.compressDir("dist", "dist.tar");
      await compressing.gzip.compressFile("dist.tar", "dist.tgz");
      resolve(true);
    } catch (err) {
      console.log("âŒ æ–‡ä»¶å‹ç¼©å¤±è´¥", err);
      reject(false);
      process.exit(0);
    }
  });
};

const handleRunBuild = () => {
  const spinner = ora("å¼€å§‹æ„å»º build äº§ç‰©").start();
  try {
    childProcess.execSync(BUILD_SCRIPT);
    spinner.stop();
    console.log("ğŸš€ buildäº§ç‰©æ„å»ºæˆåŠŸ, å¼€å§‹å‹ç¼©æ–‡ä»¶");
  } catch (error) {
    console.log("âŒ npm run build æ‰§è¡Œå¤±è´¥");
    spinner.stop();
    process.exit(0);
  }
};

const handleUpload = async (ssh) => {
  handleRunBuild();

  const isSuccess = await handleZipFile();
  if (isSuccess) {
    console.log("ğŸš€ æ–‡ä»¶å‹ç¼©æˆåŠŸï¼Œå¼€å§‹ä¸Šä¼ æ–‡ä»¶");
    const __filename = fileURLToPath(import.meta.url);
    const distPath = `${dirname(__filename)}/dist.tgz`;

    try {
      await ssh.putFile(distPath, "/root/home/nginx/html/dist.tgz");
      console.log("ğŸš€ ä¸Šä¼ æ–‡ä»¶æˆåŠŸ");
    } catch (error) {
      console.log("âŒ ä¸Šä¼ æ–‡ä»¶å¤±è´¥", error);
      process.exit(0);
    }

    const sftp = await ssh.requestSFTP();
    sftp.exists("/root/home/nginx/html/dist", async (boolean) => {
      if (boolean) {
        await ssh.execCommand(
          "cd home/nginx/html && rm -rf dist-list && cp -r dist dist-last"
        );
        console.log("ğŸš€ æ„å»ºäº§ç‰©å¤‡ä»½æˆåŠŸ");
      } else {
        console.log("âš ï¸ æœªå‘ç°ä¸Šæ¬¡æ„å»ºäº§ç‰©");
      }
    });

    try {
      await ssh.execCommand("cd home/nginx/html && tar -zxvf dist.tgz -C ./");
      console.log("ğŸš€ æœåŠ¡å™¨è§£å‹æ–‡ä»¶æˆåŠŸ");
      await ssh.execCommand("docker restart nginx");
      console.log("ğŸš€ docker nginx é•œåƒå¼€å§‹é‡å¯");
      await ssh.execCommand("cd home/nginx/html && rm -rf dist.tgz");
      console.log("ğŸš€ æœåŠ¡å™¨å‹ç¼©æ–‡ä»¶å·²åˆ é™¤");
      await removeLocalFile();
      console.log("ğŸš€ğŸš€ğŸš€ éƒ¨ç½²æˆåŠŸ ğŸš€ğŸš€ğŸš€");
      process.exit(0);
    } catch (error) {
      console.log("âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨", error);
      process.exit(0);
    }
  }
};

const removeLocalFile = async () => {
  const __filename = fileURLToPath(import.meta.url);
  try {
    await fs.unlink(`${dirname(__filename)}/dist.tar`);
    await fs.unlink(`${dirname(__filename)}/dist.tgz`);
    console.log("ğŸš€æœ¬åœ°å‹ç¼©æ–‡ä»¶å·²åˆ é™¤");
  } catch (error) {
    console.log("âŒæœ¬åœ°å‹ç¼©æ–‡ä»¶åˆ é™¤å¤±è´¥", error);
  }
};
// è·å–ç¯å¢ƒå˜é‡
dotEnv.config();
// æ‰§è¡Œéƒ¨ç½²ä»£ç ;
deploy();
```

### æ·»åŠ  package.json  script è„šæœ¬

```json
"script": {
  ...å¿½ç•¥å…¶å®ƒ
  "deploy": "node deploy.js"
}
```

### æ•ˆæœå›¾

![img](https://cdn.nlark.com/yuque/0/2022/gif/275583/1665643677981-f0501383-0dc4-4936-84d1-4e5ab4c25966.gif)

## é…ç½® Nginx

### ä¿®æ”¹ html æ–‡ä»¶è·¯å¾„

1. æ‰“å¼€ Nginx é…ç½®æ–‡ä»¶

```
vim home/nginx/conf/conf.d/default.conf
```

1. ä¿®æ”¹ root è·¯å¾„

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665629792213-951cea4a-7c5a-4685-a499-09692accad94.png)

1. é‡å¯ nginx å®¹å™¨

```
docker restart nginx
```

1. æŸ¥çœ‹ç»“æœ

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665629957898-85d6f2d4-8803-422d-8244-fbdcf241bda9.png)





### é…ç½®é™æ€èµ„æºç¼“å­˜

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665644135032-603e36dd-2aaa-4796-91bf-32409d87e803.png)

#### ç¼“å­˜ç­–ç•¥

å¸¦ hash çš„èµ„æºï¼Œé…ç½®  `Cache-Control: max-age=31536000`

ä¸å¸¦ hash çš„èµ„æºï¼Œé…ç½® `Cache-Control: no-cache`

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665810509731-70f8ee7d-c972-41a0-8121-eec7218cd1d7.png)

### é…ç½®åŸŸå

å‰ææ˜¯ä½ æœ‰ä¸€ä¸ªåŸŸåï¼Œå¹¶ä¸”å·²ç»æˆåŠŸå¤‡æ¡ˆ

#### é…ç½®  [DNS è§£æ](https://dns.console.aliyun.com/#/dns/domainList)ï¼ˆé˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰

é…ç½®å®Œæˆåï¼Œé™ç­‰å‡ åˆ†é’Ÿå°±ä¼šç”Ÿæ•ˆ

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665772303631-307b082e-d70a-42a5-afe1-9517a63bc417.png)

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665772384438-06208594-5445-40b5-a375-d79d63d7c20b.png)

#### ä¿®æ”¹ nginx é…ç½®

ä¿®æ”¹ `default.conf` æ–‡ä»¶å°† `server_name` ä¿®æ”¹æˆåŸŸååœ°å€å³å¯

![img](https://cdn.nlark.com/yuque/0/2022/png/275583/1665809360882-9ec11e51-861b-48b4-b6b8-4f8c21a5a8be.png)

ä¿®æ”¹å®Œæˆåï¼Œ`docker restart nginx` é‡å¯ `nginx` å®¹å™¨

### å¼€å¯ gzip

[å‚è€ƒæ–‡ç« ](https://www.cnblogs.com/kevingrace/p/10018914.html)

é…ç½®æ–‡ä»¶åœ°å€:  nginx/config/conf/nginx.conf

```yaml
http {
		gzip  on;
    gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_http_version 1.1;
    gzip_comp_level 9;
    gzip_types       text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php application/javascript application/json;
    gzip_disable "MSIE [1-6]\.";
    gzip_vary on;
}
```

