## å…³äºé¢„åŠ è½½è„šæœ¬

Electron çš„ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹æœ‰ç€æ¸…æ¥šçš„åˆ†å·¥ã€‚

Electron çš„ä¸»è¿›ç¨‹æ˜¯ä¸€ä¸ªæ‹¥æœ‰ç€å®Œå…¨æ“ä½œç³»ç»Ÿè®¿é—®æƒé™çš„ Node.js ç¯å¢ƒã€‚ä½†å‡ºäºå®‰å…¨åŸå› ï¼Œæ¸²æŸ“è¿›ç¨‹é»˜è®¤è·‘åœ¨ç½‘é¡µé¡µé¢ä¸Šï¼Œè€Œå¹¶é Node.jsé‡Œã€‚ä¸ºäº†å°† Electron çš„ä¸åŒç±»å‹çš„è¿›ç¨‹æ¡¥æ¥åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨è¢«ç§°ä¸º **é¢„åŠ è½½** çš„ç‰¹æ®Šè„šæœ¬ã€‚

## ä½¿ç”¨é¢„åŠ è½½è„šæœ¬æ¥å¢å¼ºæ¸²æŸ“å™¨

é¢„åŠ è½½è„šæœ¬ä¼šåœ¨æ¸²æŸ“å™¨çš„ç½‘é¡µåŠ è½½ä¹‹å‰æ³¨å…¥ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªå°†åº”ç”¨ä¸­çš„ Chromeã€Nodeã€Electron ç‰ˆæœ¬å·æš´éœ²è‡³æ¸²æŸ“å™¨çš„é¢„åŠ è½½è„šæœ¬ã€‚

1.æ–°å»ºä¸€ä¸ª `preload.js` æ–‡ä»¶ã€‚è¯¥è„šæœ¬é€šè¿‡ `versions` è¿™ä¸€å…¨å±€å˜é‡ï¼Œå°† Electron çš„ `process.versions` å¯¹è±¡æš´éœ²ç»™æ¸²æŸ“å™¨ã€‚

```js
// preload.js
const { contextBridge } = require('electron')

contextBridge.exposeInMainWorld('versions', {
  node: () => process.versions.node,
  chrome: () => process.versions.chrome,
  electron: () => process.versions.electron,
  // èƒ½æš´éœ²çš„ä¸ä»…ä»…æ˜¯å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æš´éœ²å˜é‡
})
```

2.å°†è„šæœ¬è¿ç”¨è¿›æ¸²æŸ“å™¨ä¸­ã€‚åœ¨ BrowserWindow æ„é€ å™¨ä¸­ä½¿ç”¨ `webPreferences.preload` ä¼ å…¥è„šæœ¬çš„è·¯å¾„ã€‚

```js
const { app, BrowserWindow } = require('electron')
const path = require('path')

const createWindow = () => {
  const win = new BrowserWindow({
    width: 800,
    height: 600,
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
    },
  })

  win.loadFile('index.html')
}

app.whenReady().then(() => {
  createWindow()
})
```

> è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªNode.jsæ¦‚å¿µï¼š
>
> - [`__dirname`](https://nodejs.org/api/modules.html#modules_dirname) å­—ç¬¦ä¸²æŒ‡å‘å½“å‰æ­£åœ¨æ‰§è¡Œè„šæœ¬çš„è·¯å¾„ (åœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒæŒ‡å‘ä½ çš„é¡¹ç›®çš„æ ¹æ–‡ä»¶å¤¹)ã€‚
> - [`path.join`](https://nodejs.org/api/path.html#path_path_join_paths) API å°†å¤šä¸ªè·¯å¾„è”ç»“åœ¨ä¸€èµ·ï¼Œåˆ›å»ºä¸€ä¸ªè·¨å¹³å°çš„è·¯å¾„å­—ç¬¦ä¸²ã€‚

ç°åœ¨æ¸²æŸ“å™¨èƒ½å¤Ÿå…¨å±€è®¿é—® `versions` äº†ï¼Œè®©æˆ‘ä»¬å¿«å¿«å°†é‡Œè¾¹çš„ä¿¡æ¯æ˜¾ç¤ºåœ¨çª—å£ä¸­ã€‚ è¿™ä¸ªå˜é‡ä¸ä»…å¯ä»¥é€šè¿‡ `window.versions` è®¿é—®ï¼Œä¹Ÿå¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ `versions` æ¥è®¿é—®ã€‚

## è®¿é—® versions

1.æ–°å»ºä¸€ä¸ª `renderer.js` è„šæœ¬ï¼Œ è¿™ä¸ªè„šæœ¬ä½¿ç”¨ [`document.getElementById`](https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementById) DOM æ¥å£æ¥æ›¿æ¢ `id` å±æ€§ä¸º `info` çš„ HTML å…ƒç´ æ˜¾ç¤ºæ–‡æœ¬ã€‚

```js
const information = document.getElementById('info')
information.innerText = `æœ¬åº”ç”¨æ­£åœ¨ä½¿ç”¨ Chrome (v${versions.chrome()}), Node.js (v${versions.node()}), å’Œ Electron (v${versions.electron()})`
```

2.æ‰§è¡Œè¯¥è„šæœ¬

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <title>æ¥è‡ª Electron æ¸²æŸ“å™¨çš„é—®å¥½ï¼</title>
  </head>
  <body>
    <h1>æ¥è‡ª Electron æ¸²æŸ“å™¨çš„é—®å¥½ï¼</h1>
    <p>ğŸ‘‹</p>
    <p id="info"></p>
  </body>
  <script src="./renderer.js"></script>
</html>
```

é¡¹ç›®è¿è¡Œåå°†ä¼šè¾“å‡ºï¼š

```
æœ¬åº”ç”¨æ­£åœ¨ä½¿ç”¨ Chrome (v106.0.5249.119), Node.js (v16.16.0), å’Œ Electron (v21.2.0)
```

## åœ¨è¿›ç¨‹ä¹‹é—´é€šè®¯

Electron çš„ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹æœ‰ç€æ¸…æ¥šçš„åˆ†å·¥å¹¶ä¸”ä¸å¯äº’æ¢ã€‚ è¿™ä»£è¡¨ç€æ— è®ºæ˜¯ä»æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—® Node.js æ¥å£ï¼Œäº¦æˆ–è€…æ˜¯ä»ä¸»è¿›ç¨‹è®¿é—® HTML æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (DOM)ï¼Œéƒ½æ˜¯ä¸å¯èƒ½çš„ã€‚

è§£å†³è¿™ä¸€é—®é¢˜çš„æ–¹æ³•æ˜¯ä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡ (IPC)ã€‚å¯ä»¥ä½¿ç”¨ Electron çš„ `ipcMain` æ¨¡å—å’Œ `ipcRenderer` æ¨¡å—æ¥è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ã€‚

ä¸ºäº†ä»ä½ çš„ç½‘é¡µå‘ä¸»è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ `ipcMain.handle` è®¾ç½®ä¸€ä¸ª**ä¸»è¿›ç¨‹å¤„ç†ç¨‹åºï¼ˆhandlerï¼‰**ï¼Œç„¶ååœ¨é¢„å¤„ç†è„šæœ¬ä¸­æš´éœ²ä¸€ä¸ªè¢«ç§°ä¸º `ipcRenderer.invoke` çš„å‡½æ•°æ¥**è§¦å‘è¯¥å¤„ç†ç¨‹åºï¼ˆhandlerï¼‰**ã€‚

æ¯”å¦‚æ·»åŠ ä¸€ä¸ªå…¨å±€å‡½æ•° `ping`ï¼š

1.é¢„å¤„ç†è„šæœ¬ä¸­è®¾ç½®çš„ `invoke` è°ƒç”¨

å°† `invoke` ä½œä¸º`ping` æš´éœ²å‡ºå»

```js
// preload.js
const { contextBridge, ipcRenderer } = require('electron')

contextBridge.exposeInMainWorld('versions', {
  node: () => process.versions.node,
  chrome: () => process.versions.chrome,
  electron: () => process.versions.electron,
  ping: () => ipcRenderer.invoke('ping'),
  // èƒ½æš´éœ²çš„ä¸ä»…ä»…æ˜¯å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æš´éœ²å˜é‡
})
```

2.åœ¨ä¸»è¿›ç¨‹ä¸­è®¾ç½® handle ç›‘å¬å™¨

æ¯å½“æ¸²æŸ“å™¨è§¦å‘ `invoke` æ—¶ï¼Œæ­¤å‡½æ•°è¢«ç”¨ä½œä¸€ä¸ªå›è°ƒã€‚ç„¶åï¼Œè¿”å›å€¼å°†ä½œä¸ºä¸€ä¸ª Promise è¿”å›åˆ°æœ€åˆçš„ `invoke` è°ƒç”¨ã€‚

```js
// main.js
const { ipcMain } = require('electron')

const createWindow = () => {
  const win = new BrowserWindow({
    width: 800,
    height: 600,
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
    },
  })
  ipcMain.handle('ping', () => 'pong')
  win.loadFile('index.html')
}
```

3.è°ƒç”¨ `invoke`

```js
// renderer.js
const func = async () => {
  const response = await window.versions.ping()
  console.log(response) // æ‰“å° 'pong'
}

func()
```

