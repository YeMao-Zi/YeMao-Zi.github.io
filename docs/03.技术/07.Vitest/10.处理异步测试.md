# 处理异步测试

## 处理异步计时器

对于定时器， [vi](https://cn.vitest.dev/api/vi.html#vi-advancetimersbytime) 工具中提供了对应的 api ，来模拟计时器。

- vi.useFakeTimers

​	启用模拟计时器，使用当前 api 后就可以使用其他 api 模拟计时器的使用。

关联 api:

- vi.useRealTimers。
- 

```

```

```react
/**
 * 套餐单项组件
 */
import React, { Component } from 'react';
import PubSub from 'pubsub-js';
import TJ from 'TJ';
import Tool from '../util';
import * as PSTypes from '../util/pubsub-types';
import Toast from '@/module/toast';
import { Modal } from 'zarm';
import { checkMealItemsLimit } from '../util/check-meal-limit-add';
import '../style/recommend.less';
import { isUndefined } from 'lodash-es';

export default class SetmealExamItem extends Component {
  constructor(props) {
    super(props);
    this.state = {
      item: this.props.item,
      members: this.props.members || [],
      showTip: false,
      show: true,
      discountPrice: -1,
    };
  }

  componentDidMount() {
    let item = this.state.item;

    // 更新当前 单项 的选中状态
    PubSub.subscribe(PSTypes.SET_EXAMITEM_CHECKED, (e, data) => {
      let id = item.id;
      let { ids, checked, required } = data;

      if (ids.indexOf(id) > -1) {
        item.ui_checked = checked;
        if (required === true) item.ui_required = true;
        this.setState({ item });
        // 如果当前是 取消 或切换必选同组项，则记录当前ID，以便切换时报错还原该项
        if (!checked && item.ui_enableSelect && item.ui_required) {
          TJ.G.set('groupRequiredId', id);
        }
      }
    });

    // 更新单项优惠价
    PubSub.subscribe(PSTypes.SET_EXAMITEM_DISCOUNT_PRICE, (e, itemMap) => {
      this.setState({
        discountPrice: isUndefined(itemMap[this.props.item.id]) ? -1 : itemMap[this.props.item.id],
      });
    });
  }

  // 选择单项
  changeEv = () => {
    const v = this.state.item;
    const checked = v.ui_checked;
    const required = v.ui_required;
    const noCancel = v.ui_enableCancel === false;
    const that = this;
    const { hideSpecialRecommentTag, showRecommendType = 'both' } = this.props;

    const requiredMsg = (
      <span style={{ color: '#FFBE00' }}>
        <i className="weui-icon-warn weui-icon_msg-primary" style={{ fontSize: 16, verticalAlign: '-3px' }} />
        该项目为必选项, 不能取消
      </span>
    );

    const RecommendedContent = (
      <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'start', textAlign: 'start' }}>
        <div>此项目根据您检前评估作答推荐，为了您的健康着想，建议不要放弃检查。</div>
        {v.description && (
          <>
            <div style={{ fontWeight: 'bold' }}>项目介绍</div>
            <div>{v.description}</div>
          </>
        )}
        {v.warning && (
          <>
            <div>检查须知</div>
            <div>{v.warning}</div>
          </>
        )}
      </div>
    );

    // 必选项、不能取消的同组必选项、已经选中的 提示：必选不可取消
    if ((noCancel || required) && checked) {
      return Toast.show(requiredMsg);
    }

    if (!hideSpecialRecommentTag && showRecommendType !== 'none' && v.recommendType === 1 && checked) {
      Modal.confirm({
        title: v.name,
        content: RecommendedContent,
        cancelText: '放弃检查',
        onCancel: () => changeCheck(),
        okText: '不放弃',
        onOk: () => {},
      });
    } else {
      changeCheck();
    }

    function changeCheck(checkState = !checked) {
      // let checkState = !checked;
      const members = that.state.members;
      const isChecked = noCancel ? true : checkState;

      // 检查是否超过套餐 单项选择数量限制
      if (isChecked) {
        if (
          !checkMealItemsLimit(
            that.props.mealItemIds,
            [...that.props.mealAndSingleAddItemIds, v.id],
            that.props.maxAddItemCount,
          )
        ) {
          return;
        }
      }

      // 显示：注意信息 Warning
      // if(isChecked && v.warning ){
      //   dialog.show({ title: '温馨提示', message: <span className="tl" dangerouslySetInnerHTML={{__html: v.warning}} /> })
      // }

      // 如果有 members 就把同组其它项取消选中
      members && PubSub.publish(PSTypes.SET_EXAMITEM_CHECKED, { ids: members, checked: false });

      // 单项把 选中和取消的数据传递给父组件，父组件根据选中状态 与 categoryId 来操作chooseIds 和 每个分类中的选中个数信息
      that.props.onChange({
        id: v.id,
        checked: isChecked,
        categoryId: v.ui_categoryId,
        cancelIds: members,
        isItem: true,
        warning: v.showWarning ? v.warning : '',
      });

      that.setState({ item: { ...v, ui_checked: isChecked } });
    }
  };

  // 切换 说明
  toggleShowTipEv = () => {
    this.setState({ showTip: !this.state.showTip });
  };
  showDetail = () => {
    // if (this.props.showExamItemDesc) return false;
    this.props.showDetail(this.state.item);
  };
  render() {
    const { discountPrice, item } = this.state;
    // 推荐标签展示类型：默认是都展示 both，同组项下的单个单项都不展示 none，为你推荐分类下只展示 特推标签 onlyEspecially
    const {
      className,
      count = 0,
      hideSpecialRecommentTag,
      showExamItemDesc = false,
      showRecommendType = 'both',
      isInnerItem = false,
    } = this.props;

    const {
      salePrice,
      price,
      name,
      pinyin,
      tagName,
      gender,
      marriageId,
      materialItem: isMaterialItem,
      description,
      recommendType,
    } = item;

    const tagNames = $.trim(tagName);
    // 是否是女已婚
    const genderMarr = gender === 1 && marriageId === 1;

    return (
      <dl className={className}>
        <div>
          {/* 隐藏的项目拼音,用于搜索组项目 */}
          {!isMaterialItem && <div style={{ position: 'absolute', left: '-10rem' }}>{pinyin}</div>}
          <dt>
            <div className="item-content">
              <h4>
                <span onClick={this.showDetail}>
                  {!hideSpecialRecommentTag && showRecommendType !== 'none' && recommendType === 1 && (
                    <span className="tag-em-red need-shift-up mr4">特推</span>
                  )}
                  {showRecommendType === 'both' && recommendType === 0 && (
                    <span className="tag-em-green need-shift-up ml5">推荐</span>
                  )}
                  {!!tagNames && <span className="word-icon">{tagNames}</span>}
                  {genderMarr && <span className="word-icon">女已婚</span>}
                  <span className="f32 c-text item-name">{name}</span>
                  {isInnerItem && <span className="word-icon ml5">套餐内</span>}
                  {!hideSpecialRecommentTag && showRecommendType !== 'none' && recommendType === 1 && (
                    <span className="tag-em-red need-shift-up ml5">推荐方案</span>
                  )}
                </span>
              </h4>
              {showExamItemDesc && <div className="meal-item-desc" dangerouslySetInnerHTML={{ __html: description }} />}
              <ExamItemPriceInfo price={salePrice} originalPrice={price} count={count} discountPrice={discountPrice} />
              {!price && count > 0 && <span className="c-fail f32">{`x${count}`}</span>}
            </div>
          </dt>
        </div>
        {!isMaterialItem && (
          <div className="check-content" onClick={this.changeEv}>
            <i type="checkbox" className={Tool.getStyle4ExamItem(item)} data-id={item.id} />
          </div>
        )}
      </dl>
    );
  }
}

function ExamItemPriceInfo({ price, originalPrice, count, discountPrice }) {
  if (!price) return null;
  const priceFormated = TJ.formatPrice(discountPrice > -1 ? discountPrice : price);
  return (
    <span className="f32 c-text">
      <span className="f24">￥</span>
      {priceFormated}
      {!!originalPrice && originalPrice > price && (
        <span className="item-delete origin-price ml10 f28">￥{TJ.formatPrice(originalPrice)}</span>
      )}
      {count > 0 && <span className="c-fail ml10">{`x${count}`}</span>}
    </span>
  );
}

```

