---
title: npm常用命令
date: 2024-06-13 14:27:01
permalink: /pages/61f2f95fd7da1777
categories: 
  - 技术
  - 技术文档
tags: 
  - null
author: 
  name: 阿莫、
  link: https://blog.csdn.net/qq_45897239/article/details/136063330
titleTag: 
---

### 一、文件预览

#### 1、安装 `pdfjs-dist` ，此处指定版本为 `2.16.105`

> yarn add pdfjs-dist@2.16.105

**注：3.x版本部分功能的实现方法与旧版本存在差异。**

#### 2、`html` 结构内容

```vue
<template>
    <div id="pdf-view">
        <canvas v-for="page in state.pdfPages" :key="page" id="pdfCanvas" />
        <div id="text-view"></div>
    </div>
</template>
```

#### 3、`js` 功能实现：

```js
<script setup>
import * as pdfjsViewer from 'pdfjs-dist/web/pdf_viewer.js'
import 'pdfjs-dist/web/pdf_viewer.css'
import * as PDF from 'pdfjs-dist'

// 文件路径
import pdf from './2020试卷.pdf';

import { ref, reactive, onMounted, nextTick } from 'vue';

const state = reactive({
    // 文件路径
    pdfPath: pdf, 
    // 总页数
    pdfPages: 1, 
    // 页面缩放
    pdfScale: 2, 
})

onMounted(() => {
    loadFile(state.pdfPath)
});

let pdfDoc = null;

function loadFile(url) {
    PDF.getDocument({
        url,
        cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/cmaps/',
        cMapPacked: true,
    }).promise.then((pdf) => {
        pdfDoc = pdf
        // 获取pdf文件总页数
        state.pdfPages = pdf.numPages
        nextTick(() => {
            renderPage(1) // 从第一页开始渲染
        })
    })
}

function renderPage(num) {
    pdfDoc.getPage(num).then((page) => {
        const canvas = document.getElementById('pdfCanvas')
        const ctx = canvas.getContext('2d')
        const viewport = page.getViewport({ scale: state.pdfScale })
        canvas.width = viewport.width
        canvas.height = viewport.height
        const renderContext = {
            canvasContext: ctx,
            viewport
        }
        page.render(renderContext)
    })
}
</script>

```

#### 4、可能出现的问题

##### (1) 部分字体出现乱码或浏览器控制台出现警告

浏览器警告：![浏览器警告](https://img-blog.csdnimg.cn/direct/acf0e54520e143178750ff900e802c80.jpeg#pic_center)

**解决方案：**

在 `getDocument` 方法中追加 `cMapUrl` 和 `cMapPacked` [参数](https://so.csdn.net/so/search?q=参数&spm=1001.2101.3001.7020)：

```js
PDF.getDocument({
    url,
    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/cmaps/',
    cMapPacked: true,
})

```

**注：`cMapUrl` 参数可指定为本地文件路径，可在路径 `node_modules/pdfjs-dist/cmaps` 中获取。通过测试发现，该警告即便不处理依然不影响页面展示，但是在后续的文本选中功能上可能会受影响。**

### 二、文本选中

#### 1、功能实现

在文件预览的基础上添加以下代码：

```js
import { TextLayerBuilder } from 'pdfjs-dist/web/pdf_viewer.js';
const pdfjsWorker = import('pdfjs-dist/build/pdf.worker.entry')
PDF.GlobalWorkerOptions.workerSrc = pdfjsWorker

const eventBus = new pdfjsViewer.EventBus();

function renderPage(num) {
    pdfDoc.getPage(num).then((page) => {
        ...
        const renderContext = {
            ...
        }
        // page.render(renderContext)

        // 获取文本内容和渲染页面的 Promise
        const getTextContentPromise = page.getTextContent();
        const renderPagePromise = page.render(renderContext);

        Promise.all([getTextContentPromise, renderPagePromise])
            .then(([textContent]) => {
                const textLayerDiv = document.createElement('div');
                // 注意：此处不要修改该元素的class名称，该元素的样式通过外部导入，名称是固定的
                textLayerDiv.setAttribute('class', 'textLayer');
                // 设置容器样式
                textLayerDiv.setAttribute('style', `
                    z-index: 1;
                    opacity: 1;
                    background-color:#fff;
                    transform: scale(1.1);
                    width: 100%,
                    height: 100%,
                `);
                // 设置容器的位置和宽高
                textLayerDiv.style.left = canvas.offsetLeft + 'px';
                textLayerDiv.style.top = canvas.offsetTop + 'px';
                textLayerDiv.style.height = canvas.offsetHeight + 'px';
                textLayerDiv.style.width = canvas.offsetWidth + 'px';

                const textView = document.querySelector('#text-view');
                textView.appendChild(textLayerDiv);

                const textLayer = new TextLayerBuilder({
                    // container: ,
                    textLayerDiv: textLayerDiv,
                    pageIndex: page.pageIndex,
                    viewport: viewport,
                    eventBus,
                    // textDivs: []
                });

                textLayer.setTextContent(textContent);
                textLayer.render();
            }) 
            .catch((error) => {
                console.error('Error rendering page:', error);
            })
    })
}

```

#### 2、可能出现的问题：

##### (1) 页面文字可选中，但文本不可见

通过测试发现，将 `pdfjs-dist/web/pdf_viewer.css` 路径下的 `color` 属性注释后可显示文本。

```css
.textLayer span,
.textLayer br {
  /* color: transparent; */
  position: absolute;
  white-space: pre;
  cursor: text;
  transform-origin: 0% 0%;
}

```

##### (2) 浏览器控制台报错 `Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'dispatch')`

浏览器报错：

![浏览器报错](https://img-blog.csdnimg.cn/direct/5064c4c88c684baaa7d00ca2e2c6a426.jpeg#pic_center)

**解决方案：**

通过上网查找资料得知，需在 `TextLayerBuilder` 中追加参数 `eventBus`：

```js
const eventBus = new pdfjsViewer.EventBus();

function renderPage(num) {
    pdfDoc.getPage(num).then((page) => {
        ...
    Promise.all([getTextContentPromise, renderPagePromise])
        .then(([textContent]) => {
                    ...
        const textLayer = new TextLayerBuilder({
            ...
            eventBus,
        });
        ...
}).catch ((error) => {...})})}

```

