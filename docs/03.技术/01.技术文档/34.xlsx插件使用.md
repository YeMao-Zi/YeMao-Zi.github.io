---
title: xlsxæ’ä»¶ä½¿ç”¨
date: 2024-06-13 14:27:01
permalink: /pages/61f2f95fd7da1888
categories: 
  - æŠ€æœ¯
  - æŠ€æœ¯æ–‡æ¡£
tags: 
  - null
author: 
  name: å¥½è„¾æ°”å§‘å¨˜
  link: https://juejin.cn/post/7047334220166856740
titleTag: 
---

excel è¡¨æ ¼è§£ææ’ä»¶

<!-- more -->

# xlsxæ’ä»¶ä½¿ç”¨

å®‰è£…å¹¶å¼•å…¥[XLSX](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsheetjs%2Fsheetjs)

```bash
npm i xlsx
```

## è¯»å–excleæ–‡ä»¶å¹¶è§£æè¯¦ç»†æ–‡ä»¶ä¿¡æ¯

## FileReaderè¯»å–æ–‡ä»¶å†…å®¹

```typescript
export const readExcel = (file) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = reader.result;
      // reader.result === e.target.result
      const result = [];
      parseExcelData(fileData, result);
      resolve(result);
    };
    reader.readAsArrayBuffer(file);
  });
};
```

### [FileReader](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFileReader)çš„è¯»å–æ–¹æ³•

- ã€å±æ€§ã€‘readyState è¡¨ç¤ºFileReaderçŠ¶æ€çš„æ•°å­— {EMPTY: 0, LOADING: 1, DONE: 2}ã€‚
- ã€å±æ€§ã€‘result æ–‡ä»¶çš„å†…å®¹ã€‚è¯¥å±æ€§ä»…åœ¨è¯»å–æ“ä½œå®Œæˆåæ‰æœ‰æ•ˆã€‚
- ã€äº‹ä»¶ã€‘onload åœ¨è¯»å–æ“ä½œå®Œæˆæ—¶è§¦å‘ã€‚
- ã€æ–¹æ³•ã€‘**readAsArrayBuffer()** è¯»å–æŒ‡å®šçš„ Blob æˆ– File å¯¹è±¡ã€‚ä¸€æ—¦å®Œæˆï¼Œä¼šå‡ºå‘onload/onloadendäº‹ä»¶ï¼ŒreadyStateçŠ¶æ€ä¼šå˜å‘³DONEï¼ŒåŒæ—¶ result å±æ€§ä¸­å°†åŒ…å«ä¸€ä¸ª ArrayBuffer å¯¹è±¡ä»¥è¡¨ç¤ºæ‰€è¯»å–æ–‡ä»¶çš„æ•°æ®ã€‚
- ã€æ–¹æ³•ã€‘**readAsBinaryString()** å’Œ readAsArrayBuffer åŠŸèƒ½ç›¸åŒï¼ŒåŒºåˆ«æ˜¯ result å±æ€§å°†åŒ…å«æ‰€è¯»å–æ–‡ä»¶åŸå§‹äºŒè¿›åˆ¶æ ¼å¼ã€‚ï¼ˆ**éæ ‡å‡†:**  è¯¥ç‰¹æ€§æ˜¯éæ ‡å‡†çš„ï¼Œè¯·å°½é‡ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼ï¼‰
- ã€æ–¹æ³•ã€‘**readAsDataURL()**  å’Œ readAsArrayBuffer åŠŸèƒ½ç›¸åŒï¼ŒåŒºåˆ«æ˜¯ result å±æ€§å°†åŒ…å«æ‰€è¯»å–æ–‡ä»¶çš„ `data:`URLæ ¼å¼çš„å­—ç¬¦ä¸²ï¼ˆbase64ç¼–ç ï¼‰ã€‚
- ã€æ–¹æ³•ã€‘**readAsText()** **å¼‚æ­¥**è¯»å–æŒ‡å®šçš„ Blob æˆ– File å¯¹è±¡ï¼Œæ ¹æ®ç‰¹æ®Šçš„ç¼–ç æ ¼å¼è½¬åŒ–ä¸ºå†…å®¹(å­—ç¬¦ä¸²å½¢å¼)ã€‚

## XLSXè§£ææ–‡ä»¶å†…å®¹

```js
import * as XLSX from "xlsx";

export const parseExcelData = (fileData, result) => {
  const workbook = XLSX.read(fileData, { type: "binary" });
  workbook.SheetNames.forEach((sheetName) => {
    const tableAu = XLSX.utils.sheet_to_html(workbook.Sheets[sheetName]);
    result.push({
      sheetName,
      sheet: XLSX.utils.sheet_to_formulae(workbook.Sheets[sheetName]),
      json: XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]),
      tableAu,
    });
  });
};
```

### [XLSX](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsheetjs%2Fsheetjs)

**è§£ææ–¹æ³•**

- XLSX.read(data, read_opts) è§£ææ•°æ® data
- XLSX.readFile(filename, read_opts) è§£ææ–‡ä»¶åä¸º fileName çš„æ–‡ä»¶ï¼Œnodeç¯å¢ƒä¸‹ä½¿ç”¨

### read_opts

**1. type æ–‡ä»¶ç±»å‹**

| `type`     | expected input                                               |
| ---------- | ------------------------------------------------------------ |
| `"base64"` | string: Base64 encoding of the file   éœ€è¦å°†å†…å®¹è½¬æˆ base-64 ç¼–ç çš„ ASCII å­—ç¬¦ä¸² |
| `"binary"` | string: binary string (byte `n` is `data.charCodeAt(n)`)   å¯¹åº” fileReader.readAsBinaryString() |
| `"string"` | string: JS string (characters interpreted as UTF8)           |
| `"buffer"` | nodejs Buffer   å¯¹åº” fileReader.readAsArrayBuffer()          |
| `"array"`  | array: array of 8-bit unsigned int (byte `n` is `data[n]`) Uint8Arrayï¼Œ8ä½æ— ç¬¦å·æ•°ç»„ï¼› |
| `"file"`   | string: path of file that will be read (nodejs only)  æ–‡ä»¶çš„è·¯å¾„ï¼ˆä»…nodejsä¸‹æ”¯æŒï¼‰ï¼› |

#### è§£ætype: base64

**1. buffer -> BinaryString -> base64**

```js
function fixdata(data) { //æ–‡ä»¶æµè½¬BinaryString
    let o = "", l = 0;
    const w = 10240;
    for (; l < data.byteLength / w; ++l) 
        o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
    o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
    return o;
}

const fileReader = new FileReader();
fileReader.onload = (e: any) => {
    const data = fileReader.result;
    const workbook = XLSX.read(btoa(fixdata(data)), {type:"base64"})
    // TODO: ...
};
fileReader.readAsArrayBuffer(file);
```

1. fixdata() å°†æ–‡ä»¶æµ fileReader.readAsArrayBuffer() è·å–æ­é…çš„æ–‡ä»¶æµè½¬ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸²ã€‚
2. [btoa()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2Fbtoa) å°†äºŒè¿›åˆ¶å­—ç¬¦ä¸²è½¬åŒ–ä¸º base-64 ç¼–ç çš„ ASCII å­—ç¬¦ä¸²ã€‚
3. XLSX.read(encodedData, {type:"base64"}) è¯»å–excelæ–‡ä»¶ï¼Œè·å–workbookå¯¹è±¡

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e392a4480842465699ee5ec61823371d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

**2. base64æ–‡ä»¶**

```js
const fileReader = new FileReader();
fileReader.onload = (e: any) => {
    const data = fileReader.result;
    const workbook = XLSX.read((data as string).split(';')[1].replace('base64,',''), {type:"base64"});
    // TODO: ...
};
fileReader.readAsDataURL(file);
```

#### è§£æ type: buffer

```ini
iniå¤åˆ¶ä»£ç const reader = new FileReader();
fileReader.readAsArrayBuffer(file)
reader.onload = (e: any) => {
    const data = reader.result;
    const workbook = XLSX.read(data, { type: 'buffer' });
    // TODO: ...
}
```

#### è§£æ type: binary

```js
const reader = new FileReader();
fileReader.readAsBinaryString(file)
reader.onload = (e: any) => {
    const data = reader.result;
    const workbook = XLSX.read(data, { type: 'binary' });
    // TODO: ...
}
```

## excelæ•°æ®é¢„è§ˆ

### `workbook` å¯¹è±¡

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34ad4552065a47099a755d594ec5278d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

- **SheetNames** å­˜æ”¾excelä¸­sheetåç§°
- **Sheets** å­˜æ”¾æ¯ä¸ªsheetä¸­çš„å…·ä½“å†…å®¹

### [sheet object è¡¨æ ¼å¯¹è±¡](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSheetJS%2Fsheetjs%23sheet-objects)

`Sheets` æ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€å¼ è¡¨æ ¼ï¼Œè¡¨æ ¼ä¸­é™¤äº†ä»¥ `!` å¼€å¤´çš„éƒ½è¡¨ç¤ºå•å…ƒæ ¼ï¼Œä»¥ `!` å¼€å¤´çš„è¡¨ç¤ºä¸€äº›ç‰¹æ®Šçš„å«ä¹‰ï¼š

- `!ref` è¡¨ç¤ºæ‰€æœ‰å•å…ƒæ ¼èŒƒå›´
- `!margin` è¡¨ç¤ºé¡µè¾¹è·ï¼ŒåŒ…å«leftã€rightã€topã€bottomã€headerã€footer
- `!merges` è¡¨ç¤ºåˆå¹¶å•å…ƒæ ¼ï¼Œæ˜¯ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«`s`å’Œ`e`ä¸¤ä¸ªå¯¹è±¡åˆ†åˆ«è¡¨ç¤º**å¼€å§‹**å’Œ**ç»“æŸ**ï¼Œ`s`å’Œ`e`åŒ…å«`r`å’Œ`c`ä¸¤ä¸ªå¯¹è±¡åˆ†åˆ«è¡¨ç¤º**è¡Œ**å’Œ**åˆ—** ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f72fa16dae794b3ca1701407fb64c93b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

### [cell object å•å…ƒæ ¼å¯¹è±¡](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSheetJS%2Fsheetjs%23cell-object)

`Cell Object` æ¯ä¸€ä¸ªå•å…ƒæ ¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…æ‹¬ `v`ã€`w`ã€`t`ã€`f`ã€`F`ã€`r`ã€`h`ã€`c`ã€`z`ã€`l`ã€`s` å­—æ®µ

- tï¼šè¡¨ç¤ºå†…å®¹ç±»å‹ï¼Œ`b` Boolean, `e` Error, `n` Number, `d` Date, `s` Textç­‰
- vï¼šè¡¨ç¤ºåŸå§‹å€¼
- wï¼šè¡¨ç¤ºæ ¼å¼åŒ–åçš„å†…å®¹
- fï¼šè¡¨ç¤ºå…¬å¼ï¼Œä¾‹å¦‚ `f: "C3+4"`
- hï¼šhtmlå†…å®¹
- rï¼šå¯Œæ–‡æœ¬å†…å®¹rich text

### [XLSX.utils](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSheetJS%2Fsheetjs%23utilities)

`XLSX.utils` æä¾›äº†ç›´æ¥å¯ç”¨çš„APIè§£æ

**Exporting:**

- XLSX.utils.sheet_to_csv ç”ŸæˆCSVæ ¼å¼
- XLSX.utils.sheet_to_txt ç”Ÿæˆæ–‡æœ¬æ ¼å¼
- XLSX.utils.sheet_to_json è¾“å‡ºjsonæ ¼å¼
- XLSX.utils.sheet_to_html å°†excelæ•°æ®è½¬åŒ–ä¸ºhtml(table)
- XLSX.utils.sheet_to_formulae è¾“å‡ºå…¬å¼åˆ—è¡¨(å¸¦æœ‰å€¼å›é€€)ã€‚ ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2a6b6dc46ae43f29fea6a5616909c54~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

## ä¸‹è½½æ–‡ä»¶

1. `XLSX.write` ç”Ÿæˆä¸€ä¸ª sheet
2. `new Blob` å°† binary å­—ç¬¦ä¸²è½¬æˆ blob å¯¹è±¡
3. `URL.createObjectURL` å°† blob å¯¹è±¡è½¬æˆ url ä¸‹è½½åœ°å€

```javascript
// å°†ä¸€ä¸ªsheetè½¬æˆæœ€ç»ˆçš„excelæ–‡ä»¶çš„blobå¯¹è±¡ï¼Œç„¶ååˆ©ç”¨URL.createObjectURLä¸‹è½½
function sheet2blob(workbook) {
    // ç”Ÿæˆexcelçš„é…ç½®é¡¹
    var wopts: any = {
        bookType: 'xlsx', // è¦ç”Ÿæˆçš„æ–‡ä»¶ç±»å‹
        bookSST: false, // æ˜¯å¦ç”ŸæˆShared String Tableï¼Œå®˜æ–¹è§£é‡Šæ˜¯ï¼Œå¦‚æœå¼€å¯ç”Ÿæˆé€Ÿåº¦ä¼šä¸‹é™ï¼Œä½†åœ¨ä½ç‰ˆæœ¬IOSè®¾å¤‡ä¸Šæœ‰æ›´å¥½çš„å…¼å®¹æ€§
        type: 'binary'
    };
    var wbout = XLSX.write(workbook, wopts);
    var blob = new Blob([s2ab(wbout)], {type:"application/octet-stream"});
    // å­—ç¬¦ä¸²è½¬ArrayBuffer
    function s2ab(s: any) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
    return blob;
}
```

å‚è€ƒæ–‡ç«  [JSå¼¹å‡ºä¸‹è½½å¯¹è¯æ¡†ä»¥åŠå®ç°å¸¸è§æ–‡ä»¶ç±»å‹çš„ä¸‹è½½](https://link.juejin.cn?target=http%3A%2F%2Fblog.haoji.me%2Fjs-download.html)

```js
/**
 * é€šç”¨çš„æ‰“å¼€ä¸‹è½½å¯¹è¯æ¡†æ–¹æ³•ï¼Œæ²¡æœ‰æµ‹è¯•è¿‡å…·ä½“å…¼å®¹æ€§
 * @param url ä¸‹è½½åœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªblobå¯¹è±¡ï¼Œå¿…é€‰
 * @param saveName ä¿å­˜æ–‡ä»¶åï¼Œå¯é€‰
 */
export function downloadDialog(sheetDatas, saveName = 'å¯¼å‡º.xlsx') {
    let url: any = sheet2blob(sheetDatas);
    
    if (typeof url == 'object' && url instanceof Blob) {
        url = URL.createObjectURL(url); // åˆ›å»ºblobåœ°å€
    }
    var aLink = document.createElement('a');
    aLink.href = url;
    aLink.download = saveName; // HTML5æ–°å¢çš„å±æ€§ï¼ŒæŒ‡å®šä¿å­˜æ–‡ä»¶åï¼Œå¯ä»¥ä¸è¦åç¼€ï¼Œæ³¨æ„ï¼Œfile:///æ¨¡å¼ä¸‹ä¸ä¼šç”Ÿæ•ˆ
    var event;
    if (window.MouseEvent) event = new MouseEvent('click');
    else {
        event = document.createEvent('MouseEvents');
        event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
    }
    aLink.dispatchEvent(event);
}
```

### `workbook` å¯¹è±¡

`workbook` çš„æ ¼å¼å’Œ `XLSX.read` è¯»å–å‡ºæ¥çš„å¯¹è±¡æ ¼å¼ä¸€è‡´ï¼ŒåŒ…å« SheetNames å’Œ Sheets

ğŸ‘‡ é€šè¿‡`XLSX.utils`æä¾›çš„APIç”Ÿæˆ`workbook`

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a0c599e40eeb453a961339afa8024f28~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

### [XLSX.utils](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSheetJS%2Fsheetjs%23utilities)

`XLSX.utils` æä¾›äº†ç›´æ¥å¯ç”¨çš„APIè§£æ

**Importing:**

- XLSX.utils.aoa_to_sheet å°†`csv`ç»“æ„çš„äºŒç»´æ•°ç»„è½¬ sheet
- XLSX.utils.json_to_sheet å°†`json`æ ¼å¼æ•°æ®è½¬ sheet
- XLSX.utils.table_to_sheet å°†ä¸€ä¸ª`table dom`ç›´æ¥è½¬æˆ sheetï¼Œä¼šè‡ªåŠ¨è¯†åˆ«`colspan`å’Œ`rowspan`å¹¶å°†å…¶è½¬æˆå¯¹åº”çš„å•å…ƒæ ¼åˆå¹¶
- XLSX.utils.sheet_add_aoa å‘ç°æœ‰çš„å·¥ä½œè¡¨ä¸­æ·»åŠ ä¸€ä¸ª`csv`æ•°ç»„
- XLSX.utils.sheet_add_json å°†ä¸€ä¸ª`json`å¯¹è±¡æ·»åŠ åˆ°ç°æœ‰çš„å·¥ä½œè¡¨ä¸­

```js
const sheetName = 'sheet1';
const aoa = [['å§“å','æ€§åˆ«','å¹´é¾„','æ³¨å†Œæ—¶é—´'], ['å¼ ä¸‰','ç”·','18','9/16/21','22'], ['æå››','å¥³','22','9/16/21','26'], ['ä¸»è¦ä¿¡æ¯','','','å…¶å®ƒä¿¡æ¯']];
const csv = `å§“å,æ€§åˆ«,å¹´é¾„,æ³¨å†Œæ—¶é—´,\nå¼ ä¸‰,ç”·,18,9/16/21,22\næå››,å¥³,22,9/16/21,26\nä¸»è¦ä¿¡æ¯,,,å…¶å®ƒä¿¡æ¯,`;
const json = [
    { 'å§“å': 'å¼ ä¸‰', 'å¹´é¾„': 18, 'æ€§åˆ«': 'ç”·', 'æ³¨å†Œæ—¶é—´': 44455.62984811343 },
    { 'å§“å': 'æå››', 'å¹´é¾„': 22, 'æ€§åˆ«': 'å¥³', 'æ³¨å†Œæ—¶é—´': 44455.62984811343 },
    { 'å§“å': 'ä¸»è¦ä¿¡æ¯', 'æ³¨å†Œæ—¶é—´': 'å…¶å®ƒä¿¡æ¯' },
];

workbook.SheetNames.push(sheetName);
// workbook.Sheets[sheetName] = XLSX.utils.json_to_sheet(json);
// workbook.Sheets[sheetName] = XLSX.utils.aoa_to_sheet(aoa);
// workbook.Sheets[sheetName] = csv2sheet(csv);
workbook.Sheets[sheetName] = XLSX.utils.table_to_sheet(document.getElementsByTagName('table')[0]);
```

