(window.webpackJsonp=window.webpackJsonp||[]).push([[214],{590:function(t,s,a){"use strict";a.r(s);var n=a(5),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"mvc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mvc"}},[t._v("#")]),t._v(" MVC")]),t._v(" "),s("p",[t._v("后端框架基本都是 MVC 的架构。")]),t._v(" "),s("p",[t._v("MVC 是 Model View Controller 的简写。MVC 架构下，请求会先发送给 Controller，由它调度 Model 层的 Service 来完成业务逻辑，然后返回对应的 View。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/7phDfr5vjBbeRPo.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"aop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aop"}},[t._v("#")]),t._v(" AOP")]),t._v(" "),s("p",[t._v("在这个流程中，Nest 还提供了 AOP （Aspect Oriented Programming）的能力，也就是面向切面编程的能力。")]),t._v(" "),s("p",[t._v("AOP 是什么意思呢？什么是面向切面编程呢？")]),t._v(" "),s("p",[t._v("一个请求过来，可能会经过 Controller（控制器）、Service（服务）、Repository（数据库访问） 的逻辑：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/RNT2u6nrbDowKli.png",alt:""}})]),t._v(" "),s("p",[t._v("如果想在这个调用链路里加入一些通用逻辑该怎么加呢？比如日志记录、权限控制、异常处理等。")]),t._v(" "),s("p",[t._v("容易想到的是直接改造 Controller 层代码，加入这段逻辑。")]),t._v(" "),s("p",[t._v("这样可以，但是不优雅，因为这些通用的逻辑侵入到了业务逻辑里面。能不能透明的给这些业务逻辑加上日志、权限等处理呢？")]),t._v(" "),s("p",[t._v("那是不是可以在调用 Controller 之前和之后加入一个执行通用逻辑的阶段呢？")]),t._v(" "),s("p",[t._v("比如这样：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/KPWayVlh5MOu8kR.png",alt:""}})]),t._v(" "),s("p",[t._v("是不是就和切了一刀一样？")]),t._v(" "),s("p",[t._v("这样的横向扩展点就叫做切面，这种透明的加入一些切面逻辑的编程方式就叫做 AOP （面向切面编程）。")]),t._v(" "),s("p",[s("strong",[t._v("AOP 的好处是可以把一些通用逻辑分离到切面中，保持业务逻辑的纯粹性，这样切面逻辑可以复用，还可以动态的增删。")])]),t._v(" "),s("p",[t._v("其实 Express 的中间件的洋葱模型也是一种 AOP 的实现，因为你可以透明的在外面包一层，加入一些逻辑，内层感知不到。")]),t._v(" "),s("p",[t._v("而 Nest 实现 AOP 的方式更多，一共有五种，包括 Middleware、Guard、Pipe、Interceptor、ExceptionFilter。")]),t._v(" "),s("p",[t._v("新建个 nest 项目，我们挨个试一下：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("nest new aop-test\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/F1HwOJPk4yAfzps.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"中间件-middleware"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#中间件-middleware"}},[t._v("#")]),t._v(" 中间件 Middleware")]),t._v(" "),s("p",[t._v("中间件是 Express 里的概念，Nest 的底层是 Express，所以自然也可以使用中间件，但是做了进一步的细分，分为了全局中间件和路由中间件。")]),t._v(" "),s("h4",{attrs:{id:"全局中间件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局中间件"}},[t._v("#")]),t._v(" 全局中间件")]),t._v(" "),s("p",[t._v("全局中间件就是这样：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/4PanZfIv8GsOkKT.png",alt:""}})]),t._v(" "),s("p",[t._v("在 main.ts 里通过 app.use 使用：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("req")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("res")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" NextFunction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'before'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'after'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("在 AppController 里也加个打印：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/BTAWqLoFnHItVN3.png",alt:""}})]),t._v(" "),s("p",[t._v("把服务跑起来：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npm run start:dev\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/LbVksIUT8K6rt4h.png",alt:""}})]),t._v(" "),s("p",[t._v("浏览器访问下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/JOwgyVMk61xrS94.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/kRnoyt7VEBsp93q.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，在调用 handler 前后，执行了中间件的逻辑。")]),t._v(" "),s("p",[t._v("我们再添加几个路由：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/lJxtRBVzqmMH812.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'aaa'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("aaa")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'aaa...'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'aaa'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bbb'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bbb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bbb...'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bbb'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("p",[t._v("然后浏览器访问下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/no9f1TD2hFRmgIk.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/oSRxYNLgBKPav7f.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，中间件逻辑都执行了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/3bmDercX62BuHlV.png",alt:""}})]),t._v(" "),s("p",[t._v("也就是说，可以在多个 handler 之间复用中间件的逻辑：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/zhMQ21enotaRdP8.png",alt:""}})]),t._v(" "),s("p",[t._v("这种可以给在 handler 前后动态增加一些可复用的逻辑，就是 AOP 的切面编程的思想。")]),t._v(" "),s("h4",{attrs:{id:"路由中间件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#路由中间件"}},[t._v("#")]),t._v(" 路由中间件")]),t._v(" "),s("p",[t._v("除了全局中间件，Nest 还支持路由中间件。")]),t._v(" "),s("p",[t._v("用 nest cli 创建一个路由中间件：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("nest g middleware log --no-spec --flat\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/c9kxvg4RLjfV8XH.png",alt:""}})]),t._v(" "),s("p",[t._v("--no-spec 是不生成测试文件，--flat 是平铺，不生成目录。")]),t._v(" "),s("p",[t._v("生成的代码是这样的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/ZK7vJipj5RfAQ3C.png",alt:""}})]),t._v(" "),s("p",[t._v("在前后打印下日志：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Injectable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" NestMiddleware "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Response "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Injectable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LogMiddleware")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NestMiddleware")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("res")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'before2'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'after2'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br")])]),s("p",[t._v("然后在 AppModule 里启用：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/8LHv9XAeJNhKxWM.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" MiddlewareConsumer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" NestModule "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" AppController "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./app.controller'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" AppService "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./app.service'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" LogMiddleware "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./log.middleware'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("imports")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("controllers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("AppController"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("providers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("AppService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppModule")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NestModule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("configure")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("consumer")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" MiddlewareConsumer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("consumer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LogMiddleware"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forRoutes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'aaa*'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br")])]),s("p",[t._v("在 configure 方法里配置 LogMiddleware 在哪些路由生效。")]),t._v(" "),s("p",[t._v("然后测试下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/Kyr2L4BQfbsUNWo.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/GNEmPfVUioBHkM9.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/ta6PVWg7H2ITevs.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，只有 aaa 的路由，中间件生效了。")]),t._v(" "),s("p",[t._v("这就是全局中间件和路由中间件的区别。")]),t._v(" "),s("h3",{attrs:{id:"守卫-guard"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#守卫-guard"}},[t._v("#")]),t._v(" 守卫 Guard")]),t._v(" "),s("h4",{attrs:{id:"路由守卫"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#路由守卫"}},[t._v("#")]),t._v(" 路由守卫")]),t._v(" "),s("p",[t._v("Guard 是路由守卫的意思，可以用于在调用某个 Controller 之前判断权限，返回 true 或者 false 来决定是否放行：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/VjQ6bSLUvt4B9Wy.png",alt:""}})]),t._v(" "),s("p",[t._v("我们创建个 Guard：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("nest g guard login --no-spec --flat\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/eDhBKvM5JVEAkSa.png",alt:""}})]),t._v(" "),s("p",[t._v("生成的 Guard 代码是这样的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/a3DbTWxj87fs59d.png",alt:""}})]),t._v(" "),s("p",[t._v("Guard 要实现 CanActivate 接口，实现 canActivate 方法，可以从 context 拿到请求的信息，然后做一些权限验证等处理之后返回 true 或者 false。")]),t._v(" "),s("p",[t._v("我们加个打印语句，然后返回 false：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" CanActivate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Injectable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Observable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rxjs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Injectable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LoginGuard")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CanActivate")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("canActivate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("context")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" boolean "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Promise"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("boolean"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Observable"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("boolean"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'login check'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("p",[t._v("之后在 AppController 里启用：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/73eg5L8UXalWBhA.png",alt:""}})]),t._v(" "),s("p",[t._v("然后再访问下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/3y9TIAo4wu62NlM.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/zct4hdoTESqOBbI.png",alt:""}})]),t._v(" "),s("p",[t._v("aaa 没有权限，返回了 403。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/oQdCxlibMkgUHXP.png",alt:""}})]),t._v(" "),s("p",[t._v("Controller 本身不需要做啥修改，却透明的加上了权限判断的逻辑，这就是 AOP 架构的好处。")]),t._v(" "),s("h4",{attrs:{id:"全局守卫"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局守卫"}},[t._v("#")]),t._v(" 全局守卫")]),t._v(" "),s("h5",{attrs:{id:"useglobalguards"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#useglobalguards"}},[t._v("#")]),t._v(" useGlobalGuards")]),t._v(" "),s("p",[t._v("而且，就像 Middleware 支持全局级别和路由级别一样，Guard 也可以全局启用：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/KOs9m1RrwtDEX4G.png",alt:""}})]),t._v(" "),s("p",[t._v("这样每个路由都会应用这个 Guard：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/TNFUjL8ZiAGkp9l.png",alt:""}})]),t._v(" "),s("h5",{attrs:{id:"注入"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注入"}},[t._v("#")]),t._v(" 注入")]),t._v(" "),s("p",[t._v("还有一种全局启用的方式，是在 AppModule 里这样声明：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/iZ7cMYoml8TPqja.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("provide")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("APP_GUARD")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useClass")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" LoginGuard\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("把 main.ts 里的 useGlobalGuards 注释掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/Fmn3xPpYJsVkf6R.png",alt:""}})]),t._v(" "),s("p",[t._v("再试下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91145c2d73d343a9aca3acb385002e56~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=700&h=356&s=38399&e=png&b=fefefe",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，Guard 依然是生效的。")]),t._v(" "),s("p",[t._v("那为什么都是声明全局 Guard，需要有两种方式呢？")]),t._v(" "),s("p",[t._v("因为之前这种方式是手动 new 的 Guard 实例，不在 IoC 容器里：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/ZLSXJh9AHlUo8p1.png",alt:""}})]),t._v(" "),s("p",[t._v("而用 provider 的方式声明的 Guard 是在 IoC 容器里的，可以注入别的 provider：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/dpQvq9jGn13TDVY.png",alt:""}})]),t._v(" "),s("p",[t._v("我们注入下 AppService 试试：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/yTmt5GKSEW8HIxo.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Inject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AppService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("appService")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" AppService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("浏览器访问下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/18/XRgl7x2zcbrYtyj.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，注入的 AppService 生效了。")]),t._v(" "),s("p",[t._v("所以，当需要注入别的 provider 的时候，就要用第二种全局 Guard 的声明方式。")]),t._v(" "),s("blockquote",[s("p",[t._v("当使用此方法为守卫程序执行依赖项注入时，请注意，无论使用此构造的模块是什么，守卫程序实际上是全局的。应该在哪里进行?选择定义守卫的模块(上例中的 "),s("code",[t._v("RolesGuard")]),t._v(")。此外，"),s("code",[t._v("useClass")]),t._v("不是处理自定义 "),s("code",[t._v("providers")]),t._v(" 注册的唯一方法。在"),s("a",{attrs:{href:"https://docs.nestjs.cn/8/fundamentals?id=%E8%87%AA%E5%AE%9A%E4%B9%89providercustomer-provider",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),s("OutboundLink")],1),t._v("了解更多。")])]),t._v(" "),s("h3",{attrs:{id:"拦截器-interceptor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拦截器-interceptor"}},[t._v("#")]),t._v(" 拦截器 Interceptor")]),t._v(" "),s("p",[t._v("Interceptor 是拦截器的意思，可以在目标 Controller 方法前后加入一些逻辑：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/RW3YjrZQmcphtJ1.png",alt:""}})]),t._v(" "),s("p",[t._v("创建个 interceptor：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("nest g interceptor time --no-spec --flat\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/ksa4HfZQOEIlrUn.png",alt:""}})]),t._v(" "),s("p",[t._v("生成的 interceptor 是这样的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/mq42jMzRiDwvsTu.png",alt:""}})]),t._v(" "),s("p",[t._v("Interceptor 要实现 NestInterceptor 接口，实现 intercept 方法，调用 next.handle() 就会调用目标 Controller，可以在之前和之后加入一些处理逻辑。")]),t._v(" "),s("p",[t._v("Controller 之前之后的处理逻辑可能是异步的。Nest 里通过 rxjs 来组织它们，所以可以使用 rxjs 的各种 operator。")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" CallHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Injectable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" NestInterceptor "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Observable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tap "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rxjs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Injectable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TimeInterceptor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NestInterceptor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("intercept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" CallHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Observable"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("any"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'time: '")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("p",[t._v("把之前那个 LoginGuard 注掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/4fsWZlqtOSy9ECN.png",alt:""}})]),t._v(" "),s("p",[t._v("然后启用这个 interceptor：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/MqQktE9pc5GOvCX.png",alt:""}})]),t._v(" "),s("p",[t._v("跑一下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/DyJQb8K1nfiYWam.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，interceptor 生效了。")]),t._v(" "),s("p",[t._v("有的同学可能会觉得 Interceptor 和 Middleware 差不多，其实是有区别的，主要在于参数的不同。")]),t._v(" "),s("p",[t._v("interceptor 可以拿到调用的 controller 和 handler：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/egLcDNwB7A1MIu4.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/jqUe8Zl4fWsSayp.png",alt:""}})]),t._v(" "),s("p",[t._v("后面我们会在 controller 和 handler 上加一些 metadata，这种就只有 interceptor或者 guard 里可以取出来，middleware 不行。")]),t._v(" "),s("h4",{attrs:{id:"前置拦截器-before"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前置拦截器-before"}},[t._v("#")]),t._v(" 前置拦截器（Before）")]),t._v(" "),s("p",[t._v("前置处理发生在 "),s("code",[t._v("next.handle()")]),t._v(" 调用之前：")]),t._v(" "),s("div",{staticClass:"language-ts line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[t._v("typescript"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在 next.handle() 之前执行的代码是前置处理")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("intercept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" CallHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Observable"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("any")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("console")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Before...'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这是前置处理")]),t._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用下一个处理器（可能是另一个拦截器或路由处理器）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pipe 中的处理是后置处理")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("h4",{attrs:{id:"后置拦截器-after"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#后置拦截器-after"}},[t._v("#")]),t._v(" 后置拦截器（After）")]),t._v(" "),s("p",[t._v("后置处理发生在 "),s("code",[t._v("next.handle()")]),t._v(" 返回的 Observable 中：")]),t._v(" "),s("div",{staticClass:"language-ts line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("typescriptintercept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ExecutionContext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" CallHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Observable"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("any")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 前置处理")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("console")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Before...'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用下一个处理器")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("console")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("After...")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这是后置处理")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("       "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这也是后置处理")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br")])]),s("h4",{attrs:{id:"拦截器执行顺序"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拦截器执行顺序"}},[t._v("#")]),t._v(" 拦截器执行顺序")]),t._v(" "),s("p",[t._v("当多个拦截器应用于同一个路由时，它们的执行顺序如下：")]),t._v(" "),s("ol",[s("li",[t._v("前置处理按顺序执行（从外到内）")]),t._v(" "),s("li",[t._v("路由处理器执行")]),t._v(" "),s("li",[t._v("后置处理按相反顺序执行（从内到外）")])]),t._v(" "),s("p",[t._v("例如，如果我们应用了两个拦截器 A 和 B：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("A 前置 -> B 前置 -> 路由处理器 -> B 后置 -> A 后置\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h4",{attrs:{id:"单独启用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#单独启用"}},[t._v("#")]),t._v(" 单独启用")]),t._v(" "),s("p",[t._v("Interceptor 支持每个路由单独启用，只作用于某个 handler：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/PZlg3I4q1Vmu7va.png",alt:""}})]),t._v(" "),s("p",[t._v("也可以在 controller 级别启动，作用于下面的全部 handler：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/JCYEbuL9mlpvwBg.png",alt:""}})]),t._v(" "),s("h4",{attrs:{id:"全局启用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局启用"}},[t._v("#")]),t._v(" 全局启用")]),t._v(" "),s("p",[t._v("也同样支持全局启用，作用于全部 controller：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/UNZYEH8eDvRTpnf.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/REK3nvX4lLVkSmJ.png",alt:""}})]),t._v(" "),s("p",[t._v("两种全局启用方式的区别和 guard 的一样，就不测试了。")]),t._v(" "),s("p",[t._v("除了路由的权限控制、目标 Controller 之前之后的处理这些都是通用逻辑外，对参数的处理也是一个通用的逻辑，所以 Nest 也抽出了对应的切面，也就是 Pipe：")]),t._v(" "),s("h3",{attrs:{id:"参数检验和转换-pipe"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数检验和转换-pipe"}},[t._v("#")]),t._v(" 参数检验和转换 Pipe")]),t._v(" "),s("p",[t._v("Pipe 是管道的意思，用来对参数做一些检验和转换：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/EM9FbrOl237PmTD.png",alt:""}})]),t._v(" "),s("p",[t._v("用 nest cli 创建个 pipe：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("nest g pipe validate --no-spec --flat\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/K7Ndotkbfr1VgIp.png",alt:""}})]),t._v(" "),s("p",[t._v("生成的代码是这样的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/Etg8wmvZ3KFzWyh.png",alt:""}})]),t._v(" "),s("p",[t._v("Pipe 要实现 PipeTransform 接口，实现 transform 方法，里面可以对传入的参数值 value 做参数验证，比如格式、类型是否正确，不正确就抛出异常。也可以做转换，返回转换后的值。")]),t._v(" "),s("p",[t._v("我们实现下：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ArgumentMetadata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BadRequestException"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Injectable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PipeTransform "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Injectable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ValidatePipe")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PipeTransform")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ArgumentMetadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isNaN")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseInt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BadRequestException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("参数")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("metadata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("错误")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'number'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseInt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("p",[t._v("这里的 value 就是传入的参数，如果不能转成数字，就返回参数错误，否则乘 10 再传入 handler：")]),t._v(" "),s("p",[t._v("在 AppController 添加一个 handler，然后应用这个 pipe：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/Q2WXJlnYOIgpmuT.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ccc'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ccc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Query")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'num'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ValidatePipe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" num"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" num "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("访问下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/Hv7zuOUKDSPm9Yj.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/To2XuwyCsatOHQW.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，参数错误的时候返回了 400 响应，参数正确的时候也乘 10 传入了 handler。")]),t._v(" "),s("p",[t._v("这就是 Pipe 的作用。")]),t._v(" "),s("h4",{attrs:{id:"内置-pipe"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内置-pipe"}},[t._v("#")]),t._v(" 内置 Pipe")]),t._v(" "),s("p",[t._v("Nest 内置了一些 Pipe，从名字就能看出它们的意思：")]),t._v(" "),s("ul",[s("li",[t._v("ValidationPipe")]),t._v(" "),s("li",[t._v("ParseIntPipe")]),t._v(" "),s("li",[t._v("ParseBoolPipe")]),t._v(" "),s("li",[t._v("ParseArrayPipe")]),t._v(" "),s("li",[t._v("ParseUUIDPipe")]),t._v(" "),s("li",[t._v("DefaultValuePipe")]),t._v(" "),s("li",[t._v("ParseEnumPipe")]),t._v(" "),s("li",[t._v("ParseFloatPipe")]),t._v(" "),s("li",[t._v("ParseFilePipe")])]),t._v(" "),s("h4",{attrs:{id:"单独或全局使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#单独或全局使用"}},[t._v("#")]),t._v(" 单独或全局使用")]),t._v(" "),s("p",[t._v("同样，Pipe 可以只对某个参数生效，或者整个 Controller 都生效：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/mQRz39dclaZUetr.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/LOT62S9doDRYUBE.png",alt:""}})]),t._v(" "),s("p",[t._v("或者全局生效：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/Ml6NHXJcLemP3DT.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/1kUm4OiZQswfyYh.png",alt:""}})]),t._v(" "),s("p",[t._v("不管是 Pipe、Guard、Interceptor 还是最终调用的 Controller，过程中都可以抛出一些异常，如何对某种异常做出某种响应呢？")]),t._v(" "),s("p",[t._v("这种异常到响应的映射也是一种通用逻辑，Nest 提供了 ExceptionFilter 来支持：")]),t._v(" "),s("h3",{attrs:{id:"异常处理-exceptionfilter"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#异常处理-exceptionfilter"}},[t._v("#")]),t._v(" 异常处理 ExceptionFilter")]),t._v(" "),s("p",[t._v("ExceptionFilter 可以对抛出的异常做处理，返回对应的响应：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/JHASMDfi4yXLnIt.png",alt:""}})]),t._v(" "),s("p",[t._v("其实我们刚刚在 pipe 里抛的这个错误，能够返回 400 的响应，就是 Exception Filter 做的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/7VWQtMHyJE3TqRS.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/To2XuwyCsatOHQW.png",alt:""}})]),t._v(" "),s("p",[t._v("创建一个 filter：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("nest g filter test --no-spec --flat\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/QZ5aAbIpunglD7S.png",alt:""}})]),t._v(" "),s("p",[t._v("生成的代码是这样的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a75179a0606c4c6789c6965ed4a11ef9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=974&h=276&s=56511&e=png&b=1f1f1f",alt:""}})]),t._v(" "),s("p",[t._v("改一下：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ArgumentsHost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BadRequestException"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Catch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ExceptionFilter "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Response "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BadRequestException"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestFilter")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExceptionFilter")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("exception"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" BadRequestException"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("host")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ArgumentsHost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("response")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Response "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" host"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("switchToHttp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResponse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("status")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("statusCode")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("message")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test: '")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" exception"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br")])]),s("p",[t._v("实现 ExceptionFilter 接口，实现 catch 方法，就可以拦截异常了。")]),t._v(" "),s("p",[t._v("拦截什么异常用 @Catch 装饰器来声明，然后在 catch 方法返回对应的响应，给用户更友好的提示。")]),t._v(" "),s("h4",{attrs:{id:"结合-validatepipe-处理异常"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#结合-validatepipe-处理异常"}},[t._v("#")]),t._v(" 结合 validatePipe 处理异常")]),t._v(" "),s("p",[t._v("用一下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/vTmbd9ySUFiHY85.png",alt:""}})]),t._v(" "),s("p",[t._v("再次访问，异常返回的响应就变了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/X4YQea8fo6LIpGu.png",alt:""}})]),t._v(" "),s("h4",{attrs:{id:"内置-httpexception"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内置-httpexception"}},[t._v("#")]),t._v(" 内置 HttpException")]),t._v(" "),s("p",[t._v("Nest 内置了很多 http 相关的异常，都是 HttpException 的子类：")]),t._v(" "),s("ul",[s("li",[t._v("BadRequestException")]),t._v(" "),s("li",[t._v("UnauthorizedException")]),t._v(" "),s("li",[t._v("NotFoundException")]),t._v(" "),s("li",[t._v("ForbiddenException")]),t._v(" "),s("li",[t._v("NotAcceptableException")]),t._v(" "),s("li",[t._v("RequestTimeoutException")]),t._v(" "),s("li",[t._v("ConflictException")]),t._v(" "),s("li",[t._v("GoneException")]),t._v(" "),s("li",[t._v("PayloadTooLargeException")]),t._v(" "),s("li",[t._v("UnsupportedMediaTypeException")]),t._v(" "),s("li",[t._v("UnprocessableException")]),t._v(" "),s("li",[t._v("InternalServerErrorException")]),t._v(" "),s("li",[t._v("NotImplementedException")]),t._v(" "),s("li",[t._v("BadGatewayException")]),t._v(" "),s("li",[t._v("ServiceUnavailableException")]),t._v(" "),s("li",[t._v("GatewayTimeoutException")])]),t._v(" "),s("h4",{attrs:{id:"扩展-httpexception"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#扩展-httpexception"}},[t._v("#")]),t._v(" 扩展 HttpException")]),t._v(" "),s("p",[t._v("当然，也可以自己扩展：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/Xs6d9AY8ipr4kJw.png",alt:""}})]),t._v(" "),s("p",[s("strong",[t._v("Nest 通过这样的方式实现了异常到响应的对应关系，代码里只要抛出不同的异常，就会返回对应的响应，很方便。")])]),t._v(" "),s("h4",{attrs:{id:"单独或全局使用-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#单独或全局使用-2"}},[t._v("#")]),t._v(" 单独或全局使用")]),t._v(" "),s("p",[t._v("同样，ExceptionFilter 也可以选择全局生效或者某个路由生效：")]),t._v(" "),s("p",[t._v("某个 handler：\n"),s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/vTmbd9ySUFiHY85.png",alt:""}})]),t._v(" "),s("p",[t._v("某个 controller：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/HwhkEtcjMb3TPIm.png",alt:""}})]),t._v(" "),s("p",[t._v("全局：\n"),s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/zEAYUHvLa4R6tDS.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/8OIMuFwUL54CbTm.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/puDt6dAoqSsweOn.png",alt:""}}),t._v("\n我们了解了 Nest 提供的 AOP 的机制，但它们的顺序关系是怎样的呢？")]),t._v(" "),s("h3",{attrs:{id:"几种-aop-机制的顺序"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#几种-aop-机制的顺序"}},[t._v("#")]),t._v(" 几种 AOP 机制的顺序")]),t._v(" "),s("p",[t._v("Middleware、Guard、Pipe、Interceptor、ExceptionFilter 都可以透明的添加某种处理逻辑到某个路由或者全部路由，这就是 AOP 的好处。")]),t._v(" "),s("p",[t._v("但是它们之间的顺序关系是什么呢？")]),t._v(" "),s("p",[t._v("调用关系这个得看源码了。")]),t._v(" "),s("p",[t._v("对应的源码是这样的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/tWKJZlg23HoACyp.png",alt:""}})]),t._v(" "),s("p",[t._v("很明显，进入这个路由的时候，会先调用 Guard，判断是否有权限等，如果没有权限，这里就抛异常了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/opZsxMrm4WnacPz.png",alt:""}})]),t._v(" "),s("p",[t._v("抛出的 ForbiddenException 会被 ExceptionFilter 处理，返回 403 状态码。")]),t._v(" "),s("p",[t._v("如果有权限，就会调用到拦截器，拦截器组织了一个链条，一个个的调用，最后会调用的 controller 的方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/ouLgrmWZ2yQiDd3.png",alt:""}})]),t._v(" "),s("p",[t._v("调用 controller 方法之前，会使用 pipe 对参数做处理：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/MvJEThAyIwXds6N.png",alt:""}})]),t._v(" "),s("p",[t._v("会对每个参数做转换：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/UC8RIp7d2BmVTkA.png",alt:""}})]),t._v(" "),s("p",[t._v("ExceptionFilter 的调用时机很容易想到，就是在响应之前对异常做一次处理。")]),t._v(" "),s("p",[t._v("而 Middleware 是 express 中的概念，Nest 只是继承了下，那个是在最外层被调用。")]),t._v(" "),s("h4",{attrs:{id:"图例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#图例"}},[t._v("#")]),t._v(" 图例")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/19/KbBHzMXO2iRcJk9.png",alt:""}})]),t._v(" "),s("p",[t._v("这就是这几种 AOP 机制的调用顺序。把这些理清楚，就知道什么逻辑放在什么切面里了。")]),t._v(" "),s("h4",{attrs:{id:"详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#详解"}},[t._v("#")]),t._v(" 详解")]),t._v(" "),s("p",[t._v("根据NestJS官方文档的执行顺序：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("中间件")]),t._v(" "),s("p",[t._v("直接操作 "),s("code",[t._v("Request")]),t._v(" 和 "),s("code",[t._v("Response")]),t._v(" 对象。适用于所有路由或特定路径的预处理，如日志、请求头验证、CORS 设置、请求体解析（如 "),s("code",[t._v("body-parser")]),t._v("）。")])]),t._v(" "),s("li",[s("p",[t._v("守卫")]),t._v(" "),s("p",[t._v("决定请求是否被允许继续处理（如身份认证、角色验证）。可访问 "),s("code",[t._v("ExecutionContext")]),t._v("，获取控制器、方法、请求参数等元数据。")])]),t._v(" "),s("li",[s("p",[t._v("拦截器（前置处理）")]),t._v(" "),s("p",[t._v("在方法执行前插入逻辑，如数据转换、性能监控、异常处理。可获取 "),s("code",[t._v("ExecutionContext")]),t._v("。可拦截请求参数。通过 "),s("code",[t._v("Observable")]),t._v(" 控制异步流程，支持 "),s("code",[t._v("tap()")]),t._v("、"),s("code",[t._v("map()")]),t._v(" 等操作。")])]),t._v(" "),s("li",[s("p",[t._v("管道")]),t._v(" "),s("p",[t._v("处理请求参数的格式转换（如字符串转数字）和验证（如校验输入是否符合规则）。通常绑定到单个请求参数或控制器方法。")])]),t._v(" "),s("li",[s("p",[t._v("控制器方法")]),t._v(" "),s("p",[t._v("处理具体的 HTTP 请求，调用服务层（Service）完成业务操作。通过装饰器（如 "),s("code",[t._v("@Get")]),t._v("、"),s("code",[t._v("@Post")]),t._v("）定义路由路径和 HTTP 方法。")])]),t._v(" "),s("li",[s("p",[t._v("拦截器（后置处理）")]),t._v(" "),s("p",[t._v("在方法执行后插入逻辑，如数据转换、性能监控、异常处理。可获取 "),s("code",[t._v("ExecutionContext")]),t._v("。可拦截控制器返回的响应数据。通过 "),s("code",[t._v("Observable")]),t._v(" 控制异步流程，支持 "),s("code",[t._v("tap()")]),t._v("、"),s("code",[t._v("map()")]),t._v(" 等操作。")])]),t._v(" "),s("li",[s("p",[t._v("异常过滤器")]),t._v(" "),s("p",[t._v("捕获应用中抛出的异常，统一生成错误响应。将异常转换为特定的 HTTP 响应结构（如 "),s("code",[t._v("{ code, message }")]),t._v("）")])])]),t._v(" "),s("h3",{attrs:{id:"最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#最佳实践"}},[t._v("#")]),t._v(" "),s("strong",[t._v("最佳实践")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("职责分离")]),t._v("：确保每个组件专注于单一职责（如守卫只做权限校验）。")]),t._v(" "),s("li",[s("strong",[t._v("合理分层")]),t._v("：控制器方法应保持简洁，复杂逻辑委托给服务层。")]),t._v(" "),s("li",[s("strong",[t._v("全局配置")]),t._v("：优先使用全局管道、拦截器和异常过滤器，减少重复代码。")]),t._v(" "),s("li",[s("strong",[t._v("错误处理")]),t._v("：在服务层抛出语义化异常（如 "),s("code",[t._v("NotFoundException")]),t._v("），由过滤器统一转换。")])]),t._v(" "),s("p",[t._v("案例代码在"),s("a",{attrs:{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/aop-test",target:"_blank",rel:"noopener noreferrer"}},[t._v("小册仓库"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("Nest 基于 express 这种 http 平台做了一层封装，应用了 MVC、IOC、AOP 等架构思想。")]),t._v(" "),s("p",[t._v("MVC 就是 Model、View Controller 的划分，请求先经过 Controller，然后调用 Model 层的 Service、Repository 完成业务逻辑，最后返回对应的 View。")]),t._v(" "),s("p",[t._v("IOC 是指 Nest 会自动扫描带有 @Controller、@Injectable 装饰器的类，创建它们的对象，并根据依赖关系自动注入它依赖的对象，免去了手动创建和组装对象的麻烦。")]),t._v(" "),s("p",[t._v("AOP 则是把通用逻辑抽离出来，通过切面的方式添加到某个地方，可以复用和动态增删切面逻辑。")]),t._v(" "),s("p",[t._v("Nest 的 Middleware、Guard、Interceptor、Pipe、ExceptionFilter 都是 AOP 思想的实现，只不过是不同位置的切面，它们都可以灵活的作用在某个路由或者全部路由，这就是 AOP 的优势。")]),t._v(" "),s("p",[t._v("我们通过源码来看了它们的调用顺序，Middleware 是 Express 的概念，在最外层，到了某个路由之后，会先调用 Guard，Guard 用于判断路由有没有权限访问，然后会调用 Interceptor，对 Contoller 前后扩展一些逻辑，在到达目标 Controller 之前，还会调用 Pipe 来对参数做检验和转换。所有的 HttpException 的异常都会被 ExceptionFilter 处理，返回不同的响应。")]),t._v(" "),s("p",[t._v("Nest 就是通过这种 AOP 的架构方式，实现了松耦合、易于维护和扩展的架构。")]),t._v(" "),s("p",[t._v("AOP 架构的好处，你感受到了么？")])])}),[],!1,null,null,null);s.default=e.exports}}]);