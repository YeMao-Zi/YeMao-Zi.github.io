(window.webpackJsonp=window.webpackJsonp||[]).push([[341],{717:function(s,t,a){"use strict";a.r(t);var n=a(5),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"docker容器与宿主机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker容器与宿主机"}},[s._v("#")]),s._v(" docker容器与宿主机")]),s._v(" "),t("p",[s._v("Docker 是一种容器技术，它可以在操作系统上创建多个相互隔离的容器。容器内独立安装软件、运行服务。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/j7qURbSr92Hsghe.png",alt:""}})]),s._v(" "),t("p",[s._v("但是，这个容器和宿主机还是有关联的，比如可以把宿主机的端口映射到容器内的端口、宿主机某个目录挂载到容器内的目录。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/P1AESVbO8uLG2IY.png",alt:""}})]),s._v(" "),t("p",[s._v("比如映射了 3000 端口，那容器内 3000 端口的服务，就可以在宿主机的 3000 端口访问了。")]),s._v(" "),t("p",[s._v("比如挂载了 /aaa 到容器的 /bbb/ccc，那容器内读写 /bbb/ccc 目录的时候，改的就是宿主机的 /aaa 目录，反过来，改宿主机 /aaa 目录，容器内的 /bbb/ccc 也会改，这俩同一个。")]),s._v(" "),t("p",[s._v("这分别叫做端口映射、数据卷（volume）挂载。")]),s._v(" "),t("p",[s._v("这个容器是通过镜像起来的，通过 docker run image-name。")]),s._v(" "),t("p",[s._v("比如:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run -p 3000:3000 -v /aaa:/bbb/ccc --name xxx-container xxx-image\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("通过 xxx-image 镜像跑起来一个叫做 xxx-container 的容器。")]),s._v(" "),t("p",[s._v("-p 指定端口映射，映射宿主机的 3000 到容器的 3000 端口。")]),s._v(" "),t("p",[s._v("-v 指定数据卷挂载，挂载宿主机的 /aaa 到容器的 /bbb/ccc 目录。")]),s._v(" "),t("p",[s._v("这个镜像是通过 Dockerfile 经过 build 产生的。")]),s._v(" "),t("p",[s._v("也就是这样的流程：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/ODGkJ9jc7Rtl1To.png",alt:""}})]),s._v(" "),t("p",[s._v("一般在项目里维护 Dockerfile ，然后执行 docker build 构建出镜像、push 到镜像仓库，部署的时候 pull 下来用 docker run 跑起来。")]),s._v(" "),t("p",[s._v("基本 CI/CD 也是这样的流程：")]),s._v(" "),t("p",[s._v("CI 的时候 git clone 项目，根据 dockerfile 构建出镜像，打上 tag，push 到仓库。")]),s._v(" "),t("p",[s._v("CD 的时候把打 tag 的镜像下下来，docker run 跑起来。")]),s._v(" "),t("p",[s._v("这个 Dockerfile 是在项目里维护的，虽然 CI/CD 流程不用自己搞，但是 Dockefile 还是要开发者自己写的。")]),s._v(" "),t("p",[s._v("比如我创建一个 nest 项目：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("npx nest new dockerfile-test -p npm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/ebYkmjhOJFpD7Rd.png",alt:""}})]),s._v(" "),t("p",[s._v("然后执行 npm run build，之后把它跑起来：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("npm run build\nnode ./dist/main.js\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/S3GirsCP89NLqZY.png",alt:""}})]),s._v(" "),t("p",[s._v("这时候访问 http://localhost:3000 可以看到 hello world，说明服务跑成功了:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/qAZv2umzdLNDE5C.png",alt:""}})]),s._v(" "),t("p",[s._v("那如何通过 Docker 部署这个服务呢？")]),s._v(" "),t("p",[s._v("我们来写下 Dockerfile：")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" *.lock .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" [ "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./dist/main.js"')]),s._v(" ]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("FROM node:18 是继承 node:18 基础镜像。")]),s._v(" "),t("p",[s._v("WORKDIR /app 是指定当前目录为 /app")]),s._v(" "),t("p",[s._v("COPY 复制宿主机的 package.json 和 lock 文件到容器的当前目录，也就是 /app 下")]),s._v(" "),t("p",[s._v("RUN 是执行命令，这里执行了 npm install。")]),s._v(" "),t("p",[s._v("然后再复制其余的文件到容器内。")]),s._v(" "),t("p",[s._v("EXPOSE 指定容器需要暴露的端口是 3000。")]),s._v(" "),t("p",[s._v("CMD 指定容器跑起来时执行的命令是 node ./dist/main.js。")]),s._v(" "),t("p",[s._v("然后通过 docker build 把它构建成镜像：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t dockerfile-test:first .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("-t 是指定名字和标签，这里镜像名为 dockerfile-test 标签为 first。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/QMw58mcLF6oIdsV.png",alt:""}})]),s._v(" "),t("p",[s._v("然后在 docker desktop 的 images 里就可以看到这个镜像了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/Uh7nHfvjAMz2obF.png",alt:""}})]),s._v(" "),t("p",[s._v("就是现在镜像稍微大了点，有 1.45 G。")]),s._v(" "),t("p",[s._v("我们先跑起来看看：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run -d -p 2333:3000 --name first-container dockerfile-test:first\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("-d 是后台运行。")]),s._v(" "),t("p",[s._v("-p 指定端口映射，映射宿主机的 2333 端口到容器的 3000 端口。")]),s._v(" "),t("p",[s._v("--name 指定容器名")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/T5d3NJnjS27LGcY.png",alt:""}})]),s._v(" "),t("p",[s._v("然后就可以看到容器部分有了这个容器了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/SJH3Zm8XugPybzF.png",alt:""}})]),s._v(" "),t("p",[s._v("浏览器访问 http://localhost:2333 就可以访问容器内跑的这个服务：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/IKgSBdmuLQEO3xn.png",alt:""}})]),s._v(" "),t("p",[s._v("这就是 Dockerfile 构建成镜像，然后通过容器跑起来的流程。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/5l67uvqk9nzGphC.png",alt:""}})]),s._v(" "),t("p",[s._v("但是刚才也发现了，现在镜像太大了，有 1.45G 呢，怎么优化一下呢？")]),s._v(" "),t("p",[s._v("这就涉及到了第一个技巧：")]),s._v(" "),t("h2",{attrs:{id:"使用-alpine-镜像-而不是默认的-linux-镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-alpine-镜像-而不是默认的-linux-镜像"}},[s._v("#")]),s._v(" 使用 alpine 镜像，而不是默认的 linux 镜像")]),s._v(" "),t("p",[s._v("docker 容器内跑的是 linux 系统，各种镜像的 dockerfile 都会继承 linux 镜像作为基础镜像。")]),s._v(" "),t("p",[s._v("比如我们刚刚创建的那个镜像，点开详情可以看到它的镜像继承关系：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/if8WTvojscNKdw6.png",alt:""}})]),s._v(" "),t("p",[s._v("最终还是继承了 debian 的 Linux 镜像，这是一个 linux 发行版。")]),s._v(" "),t("p",[s._v("但其实这个 linux 镜像可以换成更小的版本，也就是 alpine。")]),s._v(" "),t("p",[s._v("它裁剪了很多不必要的 linux 功能，使得镜像体积大幅减小了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/PGcHSbKTn6XfvUr.png",alt:""}})]),s._v(" "),t("p",[s._v("alpine 是高山植物，就是很少的资源就能存活的意思。")]),s._v(" "),t("p",[s._v("我们改下 dockerfile，使用 alpine 的镜像：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/I9PKFXRigAk7HUm.png",alt:""}})]),s._v(" "),t("p",[s._v("node:18-alpine3.14 是使用 18 版本的 node 镜像，它底层使用 alpine 3.14 的基础镜像。")]),s._v(" "),t("p",[s._v("然后 docker build")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t dockerfile-test:second .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/TWPBqVDGejf1h2N.png",alt:""}})]),s._v(" "),t("p",[s._v("这次的 tag 为 second。")]),s._v(" "),t("p",[s._v("然后在 docker desktop 里看下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/hk2HlWVzo4Oraqp.png",alt:""}})]),s._v(" "),t("p",[s._v("好家伙，足足小了 900M。")]),s._v(" "),t("p",[s._v("我们点开看看：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/BoQpL8MxTwPbeaG.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到它的底层 linux 镜像是 alpine3.14。")]),s._v(" "),t("p",[s._v("体积小了这么多，功能还正常么？")]),s._v(" "),t("p",[s._v("我们跑跑看：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run -d -p 2334:3000 --name second-container dockerfile-test:second\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/hB2qbRCXrml34gJ.png",alt:""}})]),s._v(" "),t("p",[s._v("docker desktop 可以看到这个跑起来的容器：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/FGtlozyUipdIVr4.png",alt:""}})]),s._v(" "),t("p",[s._v("浏览器访问下，依然是正常的：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/sfJH5wrvu2lAziC.png",alt:""}})]),s._v(" "),t("p",[s._v("alpine 只是去掉了很多 linux 里用不到的功能，使得镜像体积更小。")]),s._v(" "),t("p",[s._v("这就是第一个技巧。")]),s._v(" "),t("p",[s._v("然后再来看第二个：")]),s._v(" "),t("h2",{attrs:{id:"使用多阶段构建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用多阶段构建"}},[s._v("#")]),s._v(" 使用多阶段构建")]),s._v(" "),t("p",[s._v("看下这个 dockerfile，大家发现有啥问题没：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/hViHOtyoCk2pcEP.png",alt:""}})]),s._v(" "),t("p",[s._v("有的同学可能会说：为什么先复制 package.json 进去，安装依赖之后再复制其他文件，直接全部复制进去不就行了？")]),s._v(" "),t("p",[s._v("不是的，这两种写法的效果不同。")]),s._v(" "),t("p",[s._v("docker 是分层存储的，dockerfile 里的每一行指令是一层，会做缓存。")]),s._v(" "),t("p",[s._v("每次 docker build 的时候，只会从变化的层开始重新构建，没变的层会直接复用。")]),s._v(" "),t("p",[s._v("也就说现在这种写法，如果 package.json 没变，那么就不会执行 npm install，直接复用之前的。")]),s._v(" "),t("p",[s._v("那如果一开始就把所有文件复制进去呢？")]),s._v(" "),t("p",[s._v("那不管 package.json 变没变，任何一个文件变了，都会重新 npm install，这样没法充分利用缓存，性能不好。")]),s._v(" "),t("p",[s._v("我们试试看就知道了：")]),s._v(" "),t("p",[s._v("现在重新跑 docker build，不管跑多少次，速度都很快，因为文件没变，直接用了镜像缓存：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t dockerfile-test:second .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/DcBaYm5iIARdzxs.png",alt:""}})]),s._v(" "),t("p",[s._v("现在我们改下 README.md：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/hHGrf9baTRgX3iN.png",alt:""}})]),s._v(" "),t("p",[s._v("然后重新跑 build：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/CrHs9E65aMPZ4KW.png",alt:""}})]),s._v(" "),t("p",[s._v("现在花了 25s，其实是没有重新 npm install 的。")]),s._v(" "),t("p",[s._v("然后改下 package.json：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/Cf8qzm2vbwgOJ93.png",alt:""}})]),s._v(" "),t("p",[s._v("再跑 docker build")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/jV5eGvruqSKntBH.png",alt:""}})]),s._v(" "),t("p",[s._v("时间明显多了很多，过程中你可以看到在 npm install 那层停留了很长时间。")]),s._v(" "),t("p",[s._v("这就是为什么要这样写：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/j9pN6sFndk4mto3.png",alt:""}})]),s._v(" "),t("p",[s._v("这里没问题，大家还能发现有没有什么别的问题么？")]),s._v(" "),t("p",[s._v("问题就是源码和很多构建的依赖是不需要的，但是现在都保存在了镜像里。")]),s._v(" "),t("p",[s._v("实际上我们只需要构建出来的 ./dist 目录下的文件还有运行时的依赖。")]),s._v(" "),t("p",[s._v("那怎么办呢？")]),s._v(" "),t("p",[s._v("这时可以用多阶段构建：")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18-alpine3.14 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" build-stage")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# production stage")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18-alpine3.14 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" production-stage")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-stage")])]),s._v(" /app/dist /app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-stage")])]),s._v(" /app/package.json /app/package.json")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install --production")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app/main.js"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[s._v("FROM 后面添加一个 as 来指定当前构建阶段的名字。")]),s._v(" "),t("p",[s._v("通过 COPY --from=xxx 可以从上个阶段复制文件过来。")]),s._v(" "),t("p",[s._v("然后 npm install 的时候添加 --production，这样只会安装 dependencies 的依赖。")]),s._v(" "),t("p",[s._v("docker build 之后，只会留下最后一个阶段的镜像。")]),s._v(" "),t("p",[s._v("也就是说，最终构建出来的镜像里是没有源码的，有的只是 dist 的文件和运行时依赖。")]),s._v(" "),t("p",[s._v("这样镜像就会小很多。")]),s._v(" "),t("p",[s._v("我们来试试看：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t dockerfile-test:third -f 222.Dockerfile .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("标签为 third。")]),s._v(" "),t("p",[s._v("-f 是指定 Dockerfile 的名字。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/rNlqnfOVLcIweJo.png",alt:""}})]),s._v(" "),t("p",[s._v("然后 desktop 里看下构建出来的镜像：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/ECIHnt6cubZmsTW.png",alt:""}})]),s._v(" "),t("p",[s._v("镜像体积比没有用多阶段构建的时候小了 250 M。")]),s._v(" "),t("p",[s._v("然后跑起来试试看：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/VfjLpXMqBzk2not.png",alt:""}})]),s._v(" "),t("p",[s._v("这次映射 2335 端口到容器内的 3000 端口。")]),s._v(" "),t("p",[s._v("依然能正常访问：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/W7jXD2ZbVGSYRO4.png",alt:""}})]),s._v(" "),t("p",[s._v("这就是第二个技巧，多阶段构建。")]),s._v(" "),t("h2",{attrs:{id:"使用-arg-增加构建灵活性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-arg-增加构建灵活性"}},[s._v("#")]),s._v(" 使用 ARG 增加构建灵活性")]),s._v(" "),t("p",[s._v("我们写一个 test.js")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aaa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nconsole"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bbb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("打印了环境变量 aaa、bbb")]),s._v(" "),t("p",[s._v("跑一下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("export aaa=1 bbb=2\nnode ./test.js\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("可以看到打印了这俩环境变量：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/5JvTuMl1aKOiWqY.png",alt:""}})]),s._v(" "),t("p",[s._v("然后我们写个 dockerfile，文件名是 333.Dockerfile：")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18-alpine3.14")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" aaa")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" bbb")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" ./test.js .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" aaa="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${aaa}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    bbb="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${bbb}")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app/test.js"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("使用 ARG 声明构建参数，使用 ${xxx} 来取")]),s._v(" "),t("p",[s._v("然后用 ENV 声明环境变量。")]),s._v(" "),t("p",[s._v("dockerfile 内换行使用 \\")]),s._v(" "),t("p",[s._v("之后构建的时候传入构建参数：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build --build-arg aaa=3 --build-arg bbb=4 -t arg-test -f 333.Dockerfile .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("通过 --build-arg xxx=yyy 传入 ARG 参数的值。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/lO7x4bKjgNptZVH.png",alt:""}})]),s._v(" "),t("p",[s._v("点击查看镜像详情，可以看到 ARG 已经被替换为具体的值了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/rG7jifpPX3q64Cc.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/H7Nzr4A5CWbTVQY.png",alt:""}})]),s._v(" "),t("p",[s._v("然后跑起来：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run  --name fourth-container arg-test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这次就不用 -d 后台运行了，直接看下日志：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/eG1Lif2FIqKZvCD.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到容器内拿到的环境变量就是 ENV 设置的。")]),s._v(" "),t("p",[s._v("也就是说 ARG 是构建时的参数，ENV 时运行时的变量。")]),s._v(" "),t("p",[s._v("灵活使用 ARG，可以增加 dockerfile 的灵活性。")]),s._v(" "),t("p",[s._v("这就是第三个技巧。")]),s._v(" "),t("h2",{attrs:{id:"cmd-结合-entrypoint"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cmd-结合-entrypoint"}},[s._v("#")]),s._v(" CMD 结合 ENTRYPOINT")]),s._v(" "),t("p",[s._v("前面我们指定容器跑起来之后运行什么命令，用的是 CMD：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/EhzvPItw1mqZf2B.png",alt:""}})]),s._v(" "),t("p",[s._v("其实还可以写成 ENTRYPOINT：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/GBpEbU5a9AOWDiN.png",alt:""}})]),s._v(" "),t("p",[s._v("这两种写法有什么区别么？")]),s._v(" "),t("p",[s._v("我们来试试：")]),s._v(" "),t("p",[s._v("写个 444.Dockerfile")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18-alpine3.14")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"echo"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"光光"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"到此一游"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("然后 build：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t cmd-test -f 444.Dockerfile .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/7wcFWeqiHhBtSUA.png",alt:""}})]),s._v(" "),t("p",[s._v("然后 run 一下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run cmd-test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/qaZcEFPwnQrXMN6.png",alt:""}})]),s._v(" "),t("p",[s._v("没有指定 --name 时，会生成一个随机容器名。")]),s._v(" "),t("p",[s._v("就是这种：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/W43BbgMv5CozxZK.png",alt:""}})]),s._v(" "),t("p",[s._v("这不是重点。")]),s._v(" "),t("p",[s._v("重点是用 CMD 的时候，启动命令是可以重写的：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('docker run cmd-test echo "东东"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a34568fe40754411bc41212be232f7ff~tplv-k3u1fbpfcp-watermark.image?",alt:""}})]),s._v(" "),t("p",[s._v("可以替换成任何命令。")]),s._v(" "),t("p",[s._v("而用 ENTRYPOINT 就不会：")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18-alpine3.14")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENTRYPOINT")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"echo"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"光光"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"到此一游"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("docker build:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t cmd-test -f 444.Dockerfile .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/5DsR6E3PuyYgVtl.png",alt:""}}),s._v("\ndocker run:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('docker run cmd-test echo "东东"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/iyAmjJ7NgUcDRPp.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到，现在 dockerfile 里 ENTRYPOINT 的命令依然执行了。")]),s._v(" "),t("p",[s._v("docker run 传入的参数作为了 echo 的额外参数。")]),s._v(" "),t("p",[s._v("这就是 ENTRYPOINT 和 CMD 的区别。")]),s._v(" "),t("p",[s._v("一般还是 CMD 用的多点，可以灵活修改启动命令。")]),s._v(" "),t("p",[s._v("其实 ENTRYPOINT 和 CMD 是可以结合使用的。")]),s._v(" "),t("p",[s._v("比如这样：")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18-alpine3.14")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENTRYPOINT")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"echo"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"光光"')]),s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"到此一游"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("docker build：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t cmd-test -f 444.Dockerfile .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/rPXnRAd9zby56oT.png",alt:""}})]),s._v(" "),t("p",[s._v("docker run:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run cmd-test\ndocker run cmd-test 66666\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/1ZC7n8sUueMpJIE.png",alt:""}})]),s._v(" "),t("p",[s._v("当没传参数的时候，执行的是 ENTRYPOINT + CMD 组合的命令，而传入参数的时候，只有 CMD 部分会被覆盖。")]),s._v(" "),t("p",[s._v("这就起到了默认值的作用。")]),s._v(" "),t("p",[s._v("所以，用 ENTRYPOINT + CMD 的方式更加灵活。")]),s._v(" "),t("p",[s._v("这是第四个技巧。")]),s._v(" "),t("h2",{attrs:{id:"copy-vs-add"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#copy-vs-add"}},[s._v("#")]),s._v(" COPY vs ADD")]),s._v(" "),t("p",[s._v("其实不只是 ENTRYPOINT 和 CMD 相似，dockerfile 里还有一对指令也比较相似，就是 ADD 和 COPY。")]),s._v(" "),t("p",[s._v("这俩都可以把宿主机的文件复制到容器内。")]),s._v(" "),t("p",[s._v("但有一点区别，就是对于 tar.gz 这种压缩文件的处理上：")]),s._v(" "),t("p",[s._v("我们创建一个 aaa 目录，下面添加两个文件：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/d7sKVgSuH3PXFtZ.png",alt:""}})]),s._v(" "),t("p",[s._v("使用 tar 命令打包：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("tar -zcvf aaa.tar.gz ./aaa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/2pg8zINeSJA6BGh.png",alt:""}})]),s._v(" "),t("p",[s._v("然后写个 555.Dockerfile")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18-alpine3.14")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" ./aaa.tar.gz /aaa")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" ./aaa.tar.gz /bbb")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("docker build 生成镜像：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t add-test -f 555.Dockerfile .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/SwTlQspdKCGfazM.png",alt:""}})]),s._v(" "),t("p",[s._v("docker run 跑起来：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run -d --name sixth-container add-test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/8mL6I1qjtBuygar.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到，ADD 把 tar.gz 给解压然后复制到容器内了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/mG15hSU2vR86Mfd.png",alt:""}})]),s._v(" "),t("p",[s._v("而 COPY 没有解压，它把文件整个复制过去了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/AngQUMdesTEHRxz.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/la5VSBJ3iNQ4fRE.png",alt:""}})]),s._v(" "),t("p",[s._v("也就是说，ADD、COPY 都可以用于把目录下的文件复制到容器内的目录下。")]),s._v(" "),t("p",[s._v("但是 ADD 还可以解压 tar.gz 文件。")]),s._v(" "),t("p",[s._v("一般情况下，还是用 COPY 居多。")]),s._v(" "),t("p",[s._v("案例代码在"),t("a",{attrs:{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/dockerfile-test",target:"_blank",rel:"noopener noreferrer"}},[s._v("小册仓库"),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("Docker 是流行的容器技术，它可以在操作系统上创建多个隔离的容器，在容器内跑各种服务。")]),s._v(" "),t("p",[s._v("它的流程是 Dockerfile 经过 docker build 生成 docker 镜像，然后 docker run 来跑容器。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/tm2OkAMKQIcfSp5.png",alt:""}})]),s._v(" "),t("p",[s._v("docker run 的时候可以通过 -p 指定宿主机和容器的端口映射，通过 -v 挂载数据卷到容器内的某个目录。")]),s._v(" "),t("p",[s._v("CI/CD 基本也是这套流程，但是 Dockerfile 是要开发者自己维护的。")]),s._v(" "),t("p",[s._v("Dockerfile 有挺多技巧：")]),s._v(" "),t("ul",[t("li",[s._v("使用 alpine 的镜像，而不是默认的 linux 镜像，可以极大减小镜像体积，比如 node:18-alpine3.14 这种")]),s._v(" "),t("li",[s._v("使用多阶段构建，比如一个阶段来执行 build，一个阶段把文件复制过去，跑起服务来，最后只保留最后一个阶段的镜像。这样使镜像内只保留运行需要的文件以及 dependencies。")]),s._v(" "),t("li",[s._v("使用 ARG 增加构建灵活性，ARG 可以在 docker build 时通过 --build-arg xxx=yyy 传入，在 dockerfile 中生效，可以使构建过程更灵活。如果是想定义运行时可以访问的变量，可以通过 ENV 定义环境变量，值使用 ARG 传入。")]),s._v(" "),t("li",[s._v("CMD 和 ENTRYPOINT 都可以指定容器跑起来之后运行的命令，CMD 可以被覆盖，而 ENTRYPOINT 不可以，两者结合使用可以实现参数默认值的功能。")]),s._v(" "),t("li",[s._v("ADD 和 COPY 都可以复制文件到容器内，但是 ADD 处理 tar.gz 的时候，还会做一下解压。")])]),s._v(" "),t("p",[s._v("灵活使用这些技巧，可以让你的 Dockerfile 更加灵活、性能更好。")])])}),[],!1,null,null,null);t.default=e.exports}}]);