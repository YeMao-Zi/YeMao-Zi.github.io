(window.webpackJsonp=window.webpackJsonp||[]).push([[680],{1054:function(s,t,a){"use strict";a.r(t);var n=a(5),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"技术方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#技术方案"}},[s._v("#")]),s._v(" 技术方案")]),s._v(" "),t("p",[s._v("通过 "),t("code",[s._v("docker compose")]),s._v("进行部署")]),s._v(" "),t("h2",{attrs:{id:"项目依赖的第三方容器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#项目依赖的第三方容器"}},[s._v("#")]),s._v(" 项目依赖的第三方容器")]),s._v(" "),t("ol",[t("li",[s._v("redis7")]),s._v(" "),t("li",[s._v("mysql8")])]),s._v(" "),t("h2",{attrs:{id:"编写-dockerfile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写-dockerfile"}},[s._v("#")]),s._v(" 编写 Dockerfile")]),s._v(" "),t("p",[s._v("由于后端我们使用的 "),t("code",[s._v("Midway")]),s._v(" 框架，它是由 "),t("code",[s._v("ts")]),s._v(" 编写的，部署时需要将 "),t("code",[s._v("ts")]),s._v(" 文件构建成 "),t("code",[s._v("js")]),s._v(" 文件，所以这里会走一个 "),t("code",[s._v("npm run build")]),s._v(" 构建命令；")]),s._v(" "),t("p",[s._v("如果你用的是其它 "),t("code",[s._v("node.js")]),s._v(" 框架，比如 "),t("code",[s._v("express")]),s._v(" 可能并不需要 "),t("code",[s._v("build")]),s._v(" 这一阶段")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:12 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install --registry=https://registry.npmmirror.com")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:12-alpine")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build")])]),s._v(" /app/dist ./dist")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build")])]),s._v(" /app/bootstrap.js ./")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build")])]),s._v(" /app/package.json ./")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在docker container 中不能自动识别宿主机的时区，可通过安装tzdata软件包，配置TZ环境变量识别正确时区．")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --no-cache tzdata")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" TZ="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Asia/Shanghai"')])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 移除开发依赖，构建正式包的时候只安装 dependencies 的依赖")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install --production --registry=https://registry.npmmirror.com")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果端口更换，这边可以更新一下")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 7001")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"npm"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"run"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"start"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("h3",{attrs:{id:"docker-体积优化策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-体积优化策略"}},[s._v("#")]),s._v(" docker 体积优化策略")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("合理使用 "),t("code",[s._v("COPY")]),s._v(" 命令，"),t("code",[s._v("COPY")]),s._v("命令是会对文件进行差异化对比的，只要文件没有发生变化，那么就会使用上一层的镜像缓存")])]),s._v(" "),t("li",[t("ol",[t("li",[s._v("当然 "),t("code",[s._v("ADD")]),s._v(" 也可以，但是 "),t("code",[s._v("COPY")]),s._v(" 和 "),t("code",[s._v("ADD")]),s._v(" 还是有本质区别的， "),t("a",{attrs:{href:"https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#add-or-copy",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker 文档"),t("OutboundLink")],1),s._v("有对这两个命令有所解释")])])]),s._v(" "),t("li",[t("p",[s._v("多阶段构建")])]),s._v(" "),t("li",[t("ol",[t("li",[s._v("通过多阶段构建，减少构建体积")]),s._v(" "),t("li",[s._v("多阶段构建最明显的好处是，最终打出的镜像只包含编译产物而不包含编译过程中的依赖等冗余文件，可大大减小最终镜像的体积")])])])]),s._v(" "),t("h2",{attrs:{id:"编写docker-compose-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写docker-compose-yml"}},[s._v("#")]),s._v(" 编写docker-compose.yml")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("redis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./home/redis/data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/data\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("TZ")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Asia/Shanghai\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("expose")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./home/mysql/data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/lib/mysql\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("expose")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("authentication"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plugin=mysql_native_password\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("character"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("set"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server=utf8mb4\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("collation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server=utf8mb4_general_ci\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env_file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./.env\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" TZ=Asia/Shanghai\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" MYSQL_DATABASE=tutulist_admin\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" MYSQL_ROOT_USER=root\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" MYSQL_ROOT_PASSWORD=tutulist\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app_server\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" .\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'7001:7001'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env_file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./.env\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mysql\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" redis\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("links")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" redis\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mysql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br")])]),t("h3",{attrs:{id:"命令说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#命令说明"}},[s._v("#")]),s._v(" 命令说明")]),s._v(" "),t("p",[s._v("文档上啥都有 "),t("a",{attrs:{href:"https://yeasy.gitbook.io/docker_practice/",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档地址"),t("OutboundLink")],1)]),s._v(" "),t("h4",{attrs:{id:"image"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#image"}},[s._v("#")]),s._v(" image")]),s._v(" "),t("p",[s._v("指定使用的镜像名称，redis 我们使用的是 alpine 版本，大小只有 28.4 MB")]),s._v(" "),t("h4",{attrs:{id:"restart"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#restart"}},[s._v("#")]),s._v(" restart")]),s._v(" "),t("p",[s._v("指定容器退出后的重启策略为始终重启")]),s._v(" "),t("h4",{attrs:{id:"volumes"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#volumes"}},[s._v("#")]),s._v(" volumes")]),s._v(" "),t("p",[s._v("数据卷所挂载路径设置，可以持久化的保存数据；")]),s._v(" "),t("p",[s._v("拿 mysql 为例，我们并不希望 mysql 容器关闭后，存储在 mysql 中存储的数据就丢了，这时我们可以将映射一个宿主机的目录，将数据存储在宿主机上")]),s._v(" "),t("h4",{attrs:{id:"expose"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#expose"}},[s._v("#")]),s._v(" expose")]),s._v(" "),t("p",[s._v("暴露端口，但不映射到宿主机，只被连接的服务访问；")]),s._v(" "),t("p",[s._v("不映射到宿主机也有缺点")]),s._v(" "),t("ol",[t("li",[s._v("就是调试不方便，拿 MySQL 为例，不映射端口到宿主机，我们就无法在宿主机使用 navicat 连接这个数据库查看数据")])]),s._v(" "),t("h4",{attrs:{id:"environment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#environment"}},[s._v("#")]),s._v(" environment")]),s._v(" "),t("p",[s._v("设置环境变量")]),s._v(" "),t("h4",{attrs:{id:"env-file"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#env-file"}},[s._v("#")]),s._v(" env_file")]),s._v(" "),t("p",[s._v("从文件中获取环境变量，就是我们的那个 "),t("code",[s._v(".env")])]),s._v(" "),t("h4",{attrs:{id:"build"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#build"}},[s._v("#")]),s._v(" build")]),s._v(" "),t("p",[s._v("指定 Dockerfile 所在文件夹的路径")]),s._v(" "),t("h4",{attrs:{id:"ports"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ports"}},[s._v("#")]),s._v(" ports")]),s._v(" "),t("p",[s._v("暴露端口信息")]),s._v(" "),t("p",[s._v("格式")]),s._v(" "),t("ol",[t("li",[s._v("宿主机端口:容器端口")])]),s._v(" "),t("h4",{attrs:{id:"container-name"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#container-name"}},[s._v("#")]),s._v(" container_name")]),s._v(" "),t("p",[s._v("指定容器名称")]),s._v(" "),t("h4",{attrs:{id:"links"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#links"}},[s._v("#")]),s._v(" links")]),s._v(" "),t("p",[s._v("默认情况下，服务之间可使用服务名称相互访问, "),t("code",[s._v("links")]),s._v("允许我们定义一个别名，从而使用该别名访问其他服务")]),s._v(" "),t("p",[s._v("比如，之前我们在 "),t("code",[s._v("config.dev.ts")]),s._v(" 中需要制定具体的 "),t("code",[s._v("host")]),s._v(" 名称，现在我们就可以直接使用别名访问")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2023/09/05/1GTEzIwogX7tBCe.png",alt:"img"}})]),s._v(" "),t("h4",{attrs:{id:"depends-on"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#depends-on"}},[s._v("#")]),s._v(" depends_on")]),s._v(" "),t("p",[s._v("解决容器的依赖、启动先后的问题")]),s._v(" "),t("p",[s._v("比如我们的 "),t("code",[s._v("app")]),s._v(" 容器，它依赖于 "),t("code",[s._v("mysql")]),s._v(" 和 "),t("code",[s._v("redis")]),s._v("两个容器 ，只有它们先启动了，我们 app 业务容器才能对外提供服务")]),s._v(" "),t("h5",{attrs:{id:"启动并不代表就能提供服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动并不代表就能提供服务"}},[s._v("#")]),s._v(" 启动并不代表就能提供服务")]),s._v(" "),t("ol",[t("li",[s._v("拿我们的电脑的日常开机来讲，启动 -> 加载进度条 -> 展示界面，从启动到展示界面这段过程中，我们的电脑是不能给我们提供服务的")]),s._v(" "),t("li",[s._v("为了解决  "),t("a",{attrs:{href:"https://docs.docker.com/compose/startup-order/",target:"_blank",rel:"noopener noreferrer"}},[s._v("这个问题"),t("OutboundLink")],1),s._v("，我们就需要用到另一个工具 "),t("a",{attrs:{href:"https://github.com/vishnubob/wait-for-it",target:"_blank",rel:"noopener noreferrer"}},[s._v("wait-for-it"),t("OutboundLink")],1)])]),s._v(" "),t("h5",{attrs:{id:"使用-restart-always-解决此问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-restart-always-解决此问题"}},[s._v("#")]),s._v(" 使用 restart: always 解决此问题")]),s._v(" "),t("p",[s._v("在这里我没有使用 "),t("code",[s._v("wait-for-it")]),s._v(" 这个脚本，而是配置了 "),t("code",[s._v("restart:always")])]),s._v(" "),t("p",[s._v("我们的 "),t("code",[s._v("app")]),s._v(" 业务容器连接不上 "),t("code",[s._v("mysql")]),s._v("是会报错的，并且 "),t("code",[s._v("app")]),s._v(" 业务容器也会停止运行，而我们配置 "),t("code",[s._v("restart:always")]),s._v(" 后，每次报错停止运行后，都会重启容器，直至"),t("code",[s._v("mysql")]),s._v(" 容器能给 "),t("code",[s._v("app")]),s._v(" 容器提供服务。")]),s._v(" "),t("h5",{attrs:{id:"其它方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其它方案"}},[s._v("#")]),s._v(" 其它方案")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/baidu_35805755/article/details/124008745",target:"_blank",rel:"noopener noreferrer"}},[s._v("condition: service_completed_successfully"),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"配置项目"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置项目"}},[s._v("#")]),s._v(" 配置项目")]),s._v(" "),t("h3",{attrs:{id:"创建-dockerignore文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建-dockerignore文件"}},[s._v("#")]),s._v(" 创建 "),t("code",[s._v(".dockerignore")]),s._v("文件")]),s._v(" "),t("p",[s._v("它的作用和 "),t("code",[s._v("git")]),s._v(" 的 "),t("code",[s._v(".gitignore")]),s._v(" 类似，我们直接将 "),t("code",[s._v(".gitignore")]),s._v("内容复制进去即可")]),s._v(" "),t("h3",{attrs:{id:"更改项目配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更改项目配置文件"}},[s._v("#")]),s._v(" 更改项目配置文件")]),s._v(" "),t("p",[s._v("根据环境的不同，"),t("code",[s._v("midway")]),s._v(" 会加载不同的配置文件，在这里我们以 "),t("code",[s._v("build")]),s._v(" 为例， 它会将 "),t("code",[s._v("config.default.ts")]),s._v(" 和 "),t("code",[s._v("config.prod.ts")]),s._v(" 配置进行合并，详情见 "),t("a",{attrs:{href:"http://www.midwayjs.org/docs/env_config#%E9%85%8D%E7%BD%AE%E5%90%88%E5%B9%B6%E8%A7%84%E5%88%99",target:"_blank",rel:"noopener noreferrer"}},[s._v("midway 文档"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2023/09/05/64x7XuoOkU3lQYT.png",alt:"img"}})]),s._v(" "),t("h4",{attrs:{id:"config-default-ts"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#config-default-ts"}},[s._v("#")]),s._v(" config.default.ts")]),s._v(" "),t("p",[s._v("所有的环境都会走这个文件，一般也会作为 开发环境 的默认配置文件。")]),s._v(" "),t("p",[s._v("如果在生产环境中走另一套配置，只需要在 "),t("code",[s._v("config.prod.ts")]),s._v(" 中再添加一份配置即可，如果配置相同，它会将 "),t("code",[s._v("config.default")]),s._v(" 的配置进行覆盖")]),s._v(" "),t("div",{staticClass:"language-typescript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-typescript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" MidwayConfig "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@midwayjs/core'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  keys"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1659760140542_6750'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  koa"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    globalPrefix"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/api'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  jwt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    secret"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxxxxxxxxxxxxxxxx'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// fs.readFileSync('xxxxx.key')")]),s._v("\n    expiresIn"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2d'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// https://github.com/vercel/ms")]),s._v("\n    refreshExpiresIn"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'4d'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  typeorm"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    dataSource"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        type"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        synchronize"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        database"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DATABASE_NAME")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DATABASE_USERNAME")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DATABASE_PASSWORD")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        entities"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/entity'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  redis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    client"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Redis host")]),s._v("\n      db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" MidwayConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("h2",{attrs:{id:"服务器部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务器部署"}},[s._v("#")]),s._v(" 服务器部署")]),s._v(" "),t("h3",{attrs:{id:"安装-node、npm、git"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-node、npm、git"}},[s._v("#")]),s._v(" 安装 node、npm、git")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo yum install –y nodejs\nsudo yum install -y npm\nsudo yum install -y git\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"下载代码到服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下载代码到服务器"}},[s._v("#")]),s._v(" 下载代码到服务器")]),s._v(" "),t("p",[t("code",[s._v("git clone")]),s._v(" 拉取代码。")]),s._v(" "),t("p",[t("code",[s._v("ls-a")]),s._v("查看是否存在 "),t("code",[s._v(".env")]),s._v(" 文件，可能会被 "),t("code",[s._v(".gitignore")]),s._v(" 给忽略掉了，没有就 "),t("code",[s._v("touch .env")]),s._v(" 创建一个，将项目中的环境变量 "),t("code",[s._v("copy")]),s._v(" 进去")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2023/09/05/5Jkdx6pmD2tjaBY.png",alt:"img"}})]),s._v(" "),t("h3",{attrs:{id:"运行项目"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行项目"}},[s._v("#")]),s._v(" 运行项目")]),s._v(" "),t("p",[s._v("关于 "),t("a",{attrs:{href:"https://docs.docker.com/engine/reference/commandline/compose/",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker compose 更多命令"),t("OutboundLink")],1)]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker compose up -d\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"查看运行状态-是否是-running-状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看运行状态-是否是-running-状态"}},[s._v("#")]),s._v(" 查看运行状态，是否是 running 状态")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker compose ps\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2022/png/275583/1665769966233-8dba5fa3-b416-4c18-93cd-a5574dd5b6b5.png",alt:"img"}})]),s._v(" "),t("h3",{attrs:{id:"修改服务器防火墙"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改服务器防火墙"}},[s._v("#")]),s._v(" 修改服务器防火墙")]),s._v(" "),t("p",[s._v("将 7001 端口暴露出来")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2023/09/05/74ILKa1ybuESTsp.png",alt:"img"}})]),s._v(" "),t("h4",{attrs:{id:"测试是否能访问"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试是否能访问"}},[s._v("#")]),s._v(" 测试是否能访问")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2023/09/05/D2Kjd6W4QuBJSMq.png",alt:"img"}})]),s._v(" "),t("h3",{attrs:{id:"更改服务器-nginx-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更改服务器-nginx-配置"}},[s._v("#")]),s._v(" 更改服务器 nginx 配置")]),s._v(" "),t("p",[s._v("添加 "),t("code",[s._v("/api/")]),s._v(" 开头的配置并配置代理，让前端可以通过 "),t("code",[s._v("api")]),s._v(" 进行访问")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /api/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://43.138.82.165:7001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("重启 nginx 容器")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker restart nginx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"代码更新-重新部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代码更新-重新部署"}},[s._v("#")]),s._v(" 代码更新，重新部署")]),s._v(" "),t("p",[s._v("当我们的业务代码发生变更时，需要重新构建")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("git pull\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("拉取最新代码")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker compose up -d --build app --no-deps\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("--build：构建（重新构建）项目中的服务容器。")]),s._v(" "),t("li",[s._v("[service name]：在  docker-compose.yml 文件中为我们的业务容器定义的服务名称 app")]),s._v(" "),t("li",[s._v("--no-deps：不启动与该 service 关联的其它容器。")])]),s._v(" "),t("p",[s._v("以上的方式还是要登录服务器，并在服务器上手敲命令。")]),s._v(" "),t("p",[s._v("在下一篇中，我们会借助 "),t("code",[s._v("gitlab ci/cd")]),s._v(" 和  "),t("code",[s._v("gitlab webhooks")]),s._v(" 最终将这一流程实现自动化")])])}),[],!1,null,null,null);t.default=e.exports}}]);