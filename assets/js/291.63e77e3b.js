(window.webpackJsonp=window.webpackJsonp||[]).push([[291],{668:function(t,s,a){"use strict";a.r(s);var n=a(5),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("前面我们用的 Nest 的 request、response 对象都是 Express 的，而且 Nest 也支持 Express 的中间件机制。")]),t._v(" "),s("p",[t._v("那 Nest 和 Express 是什么关系呢？")]),t._v(" "),s("h2",{attrs:{id:"了解-express"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#了解-express"}},[t._v("#")]),t._v(" 了解 Express")]),t._v(" "),s("p",[t._v("Express 是一个处理请求、响应的库，它是这样用的：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" express "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cookieParser "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cookie-parser'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cookieValidator "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./cookieValidator'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("express")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("validateCookies")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cookieValidator")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\napp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cookieParser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("validateCookies"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("status")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br")])]),s("p",[t._v("通过 use 一个个中间件来处理请求、返回响应。")]),t._v(" "),s("p",[t._v("这种调用链叫做洋葱模型：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/24/8Nm2AZV7SDPEc6a.png",alt:""}})]),t._v(" "),s("p",[t._v("基于中间件能完成各种功能。")]),t._v(" "),s("p",[t._v("但是 Express 只是一个处理请求的库，并没有提供组织代码的架构能力，代码可能写成各种样子。")]),t._v(" "),s("h2",{attrs:{id:"nest-做了哪些"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nest-做了哪些"}},[t._v("#")]),t._v(" Nest 做了哪些？")]),t._v(" "),s("p",[t._v("所以企业级开发，我们会用对它封装了一层的库，比如 Nest。")]),t._v(" "),s("p",[t._v("Nest 提供了 IOC、AOP 等架构特性，规定了代码组织的形式，而且对 websocket、graphql、orm 等各种方案都提供了开箱即用的支持。")]),t._v(" "),s("p",[t._v("也就是说，用 Node 写一个 http 服务有三个层次：")]),t._v(" "),s("ul",[s("li",[t._v("直接使用 http、https 的模块")]),t._v(" "),s("li",[t._v("使用 express、koa 这种库")]),t._v(" "),s("li",[t._v("使用 Nest 这种企业级框架")])]),t._v(" "),s("p",[t._v("就像写 java 你还会直接处理 http 请求并手动集成各种方案么？")]),t._v(" "),s("p",[t._v("不会，会直接用 Spring 这种一站式企业级开发框架。")]),t._v(" "),s("p",[t._v("同样的道理， Nest 就是 node 生态里的 Spring。")]),t._v(" "),s("p",[t._v("但是 Nest 也没有和 Express 强耦合，它做了一层抽象：")]),t._v(" "),s("p",[t._v("定义了 "),s("a",{attrs:{href:"https://github.com/nestjs/nest/blob/d352e6f138bc70ff33cccf830053946d17272b82/packages/common/interfaces/http/http-server.interface.ts#L21C1-L85",target:"_blank",rel:"noopener noreferrer"}},[t._v("HttpServer 的 interface"),s("OutboundLink")],1),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/OPcfRE73WijSvsN.png",alt:""}})]),t._v(" "),s("p",[t._v("然后封装了 "),s("a",{attrs:{href:"https://github.com/nestjs/nest/blob/d352e6f138bc70ff33cccf830053946d17272b82/packages/core/adapters/http-adapter.ts#L12C1-L131",target:"_blank",rel:"noopener noreferrer"}},[t._v("AbstractHttpAdapter 的 abstract class"),s("OutboundLink")],1),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/Ww2HxZpoA4OEuVi.png",alt:""}})]),t._v(" "),s("p",[t._v("之后分别提供了 express 和 fastify 的实现：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/o9PlFEG8D1izXu6.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/MRFBAlt5Oz8GfIh.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"adapter"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#adapter"}},[t._v("#")]),t._v(" Adapter")]),t._v(" "),s("p",[t._v("Adapter 是适配器的意思，也就是说 Nest 内部并没有直接依赖任何一个 http 处理的库，只是依赖了抽象的接口，想用什么库需要实现这些接口的适配器。")]),t._v(" "),s("p",[t._v("你可以用 express，也可以灵活的切换成 fastify，对 Nest 没有任何影响。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/AsSMv6YXlJkpE8W.png",alt:""}})]),t._v(" "),s("p",[t._v("这俩适配器分别在 @nestjs/platform-express 和 @nestjs/platform-fastify 的包里：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/PGvHJaEzeliNR3r.png",alt:""}})]),t._v(" "),s("p",[t._v("默认用的是 platform-express 的包：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/cCzyav5Vx1wLMEU.png",alt:""}})]),t._v(" "),s("p",[t._v("下面我们切换到 fastify 试试看：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("nest new fastify-test -p npm\n")])])]),s("p",[t._v("同样，先用 @nestjs/cli 创建个 nest 项目")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/UIJQjzV8udTto9g.png",alt:""}})]),t._v(" "),s("p",[t._v("然后把它跑起来：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("nest start --watch\n")])])]),s("p",[t._v("浏览器访问 "),s("a",{attrs:{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:3000"),s("OutboundLink")],1),t._v(" 看到 hello world 就是服务跑成功了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/8GdMhyXq6BCvjRD.png",alt:""}})]),t._v(" "),s("p",[t._v("现在用的是默认的 express，我们切换到 fastify 试试看：")]),t._v(" "),s("h2",{attrs:{id:"切换到-fastify"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#切换到-fastify"}},[t._v("#")]),t._v(" 切换到 fastify")]),t._v(" "),s("p",[t._v("安装 fastify 和 @nestjs/platform-fastify：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("npm install fastify @nestjs/platform-fastify\n")])])]),s("p",[t._v("然后修改下 Nest 创建的方式：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/RmTL1lbzEBcGtSo.png",alt:""}})]),t._v(" "),s("p",[t._v("改成这样：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/De4Pi2cxnMoBQLt.png",alt:""}})]),t._v(" "),s("p",[t._v("这个 FastifyAdapter 前面讲过，传入这个 adapter 之后，就切换到了 fastify 平台。")]),t._v(" "),s("p",[t._v("这里你还可以再传一个类型参数：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/c4KZnLBOeRIP6T8.png",alt:""}})]),t._v(" "),s("p",[t._v("这样返回的 app 就会提示 fastify 平台特有的方法了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/PvkWFiOhrfTYo43.png",alt:""}})]),t._v(" "),s("p",[t._v("这也是为什么之前我们要传入 NestExpressApplication 才有 useStaticAssets 方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/RBrqdniz2SfWxKp.png",alt:""}})]),t._v(" "),s("p",[t._v("然后在 controller 里可以注入 fastify 的 request 和 reply 对象：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Controller"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Response "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" FastifyReply"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" FastifyRequest "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fastify'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" AppService "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./app.service'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Controller")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppController")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" readonly appService"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" AppService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getHello")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Request")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" request"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" FastifyRequest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Response")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" reply"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" FastifyReply")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    reply"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("header")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'url'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    reply"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br")])]),s("p",[t._v("我们注入了 fastify 的 request 和 reply 对象，然后用它来设置 header 发送响应：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/kYXb6DjnioH3WVE.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/f7xT2y5bJE6DOAj.png",alt:""}})]),t._v(" "),s("p",[t._v("这里要注意的是一旦用 @Response 注入了响应对象，就不能通过 return 的方式来返回响应内容了，需要手动调用 res.send。")]),t._v(" "),s("p",[t._v("这点用 express 时也是一样。")]),t._v(" "),s("p",[t._v("很容易理解，因为你可能在方法里用 resposne 对象发送数据了，那如果 Nest 再把返回值作为响应内容，不就冲突了么？")]),t._v(" "),s("p",[t._v("当然，你也可以这样做：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/Cp2lj9NfPwAt7Gv.png",alt:""}})]),t._v(" "),s("p",[t._v("传个 passthrough 参数，代表不会在方法里自己发送响应内容。")]),t._v(" "),s("p",[t._v("这样返回值就生效了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/21/iOtF29Erqbc8XfU.png",alt:""}})]),t._v(" "),s("p",[t._v("最后，我们来思考下为什么 Nest 要做能够轻松切换 http 处理库呢？")]),t._v(" "),s("p",[t._v("因为 Nest 的核心还是在于 IOC、AOP 这些架构特性，像 express、fastify 只不过是请求、响应的方法不同而已，区别并不大。")]),t._v(" "),s("p",[t._v("如果强依赖于 express，万一有更好的 http 处理库怎么办？")]),t._v(" "),s("p",[t._v("这种加一层抽象和适配器的方式，能让 Nest 更加通用、灵活，有更强的扩展性。")]),t._v(" "),s("p",[t._v("案例代码在"),s("a",{attrs:{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/fastify-test",target:"_blank",rel:"noopener noreferrer"}},[t._v("小册仓库"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("express 是基于中间件的洋葱模型处理请求、响应的库，它并没有提供组织代码的架构特性，代码可以写的很随意。")]),t._v(" "),s("p",[t._v("而为了更好的可维护性，我们都会用 Nest 这种一站式企业级开发框架。就像 java 里会用 Spring 框架一样。")]),t._v(" "),s("p",[t._v("Nest 底层是 express 但也不完全是，它内部实现是基于 interface 的，而且提供了 @nestjs/platform-express、@nestjs/platform-fastify 这两个 adapter 包。")]),t._v(" "),s("p",[t._v("这样就可以轻松的切换 express、fastify 或者其他的 http 请求处理的库。")]),t._v(" "),s("p",[t._v("这就是适配器模式的魅力。")])])}),[],!1,null,null,null);s.default=e.exports}}]);