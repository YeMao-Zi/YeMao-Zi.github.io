(window.webpackJsonp=window.webpackJsonp||[]).push([[326],{701:function(t,s,a){"use strict";a.r(s);var n=a(5),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("上节我们学了 pipe 来对参数做验证和转换，但那些都是 get 请求的参数，如果是 post 请求呢？")]),t._v(" "),s("h2",{attrs:{id:"dto"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dto"}},[t._v("#")]),t._v(" dto")]),t._v(" "),s("p",[t._v("post 请求的数据是通过 @Body 装饰器来取，并且要有一个 dto class 来接收：")]),t._v(" "),s("p",[t._v("（dto 是 data transfer object，数据传输对象，用于封装请求体的数据）")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/JDQq7BkgP28zfFx.png",alt:""}})]),t._v(" "),s("p",[t._v("我们用 postman 来发个 post 请求。")]),t._v(" "),s("p",[t._v("(postman 在这里下载： "),s("a",{attrs:{href:"https://www.postman.com/downloads",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.postman.com/downloads"),s("OutboundLink")],1),t._v(")")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/d3yJiFcWMTOoIkl.png",alt:""}})]),t._v(" "),s("p",[t._v("content-type 指定为 json。")]),t._v(" "),s("p",[t._v("点击 send，就可以看到服务端接收到了数据，并且把它转为了 dto 类的对象：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/IhG2d1jsoJRmrWw.png",alt:""}})]),t._v(" "),s("p",[t._v("但如果我们 age 传一个浮点数，服务端也能正常接收：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/VwdAemR1vF7DGZX.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/AvYgauM3Qf8HDWx.png",alt:""}})]),t._v(" "),s("p",[t._v("因为它也是 number。")]),t._v(" "),s("p",[t._v("而这很可能会导致后续的逻辑出错。")]),t._v(" "),s("p",[t._v("所以我们要对他做参数验证。")]),t._v(" "),s("p",[t._v("怎么做呢？")]),t._v(" "),s("p",[t._v("这就需要用到这节的 ValidationPipe 了。")]),t._v(" "),s("h2",{attrs:{id:"validationpipe"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#validationpipe"}},[t._v("#")]),t._v(" ValidationPipe")]),t._v(" "),s("p",[t._v("它需要两个依赖包：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npm install class-validator class-transformer\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("然后在 @Body 里添加这个 pipe：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/uAybBopS9nOE6ia.png",alt:""}})]),t._v(" "),s("p",[t._v("在 dto 这里，用 class-validator 包的 @IsInt 装饰器标记一下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/qdwHgoulECfysG7.png",alt:""}})]),t._v(" "),s("p",[t._v("再次请求，你就会发现它检查出了参数里的错误：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/bRhZgFjNoQBHqSe.png",alt:""}})]),t._v(" "),s("p",[t._v("那它是怎么实现的呢？")]),t._v(" "),s("h3",{attrs:{id:"实现原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现原理"}},[t._v("#")]),t._v(" 实现原理")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.npmjs.com/package/class-validator",target:"_blank",rel:"noopener noreferrer"}},[t._v("class-validator"),s("OutboundLink")],1),t._v(" 包提供了基于装饰器声明的规则对对象做校验的功能：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/MbxkWZ9yawXNY2t.png",alt:""}})]),t._v(" "),s("p",[t._v("而 "),s("a",{attrs:{href:"https://www.npmjs.com/package/class-transformer",target:"_blank",rel:"noopener noreferrer"}},[t._v("class-transformer"),s("OutboundLink")],1),t._v(" 则是把一个普通对象转换为某个 class 的实例对象的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/bT2Vrl4CepLqQtk.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/xfopiqGJMShI6VC.png",alt:""}})]),t._v(" "),s("p",[t._v("这两者一结合，那 ValidationPipe 是怎么实现的不就想明白了么：")]),t._v(" "),s("p",[s("strong",[t._v("我们声明了参数的类型为 dto 类，pipe 里拿到这个类，把参数对象通过 class-transformer 转换为 dto 类的对象，之后再用 class-validator 包来对这个对象做验证。")])]),t._v(" "),s("h3",{attrs:{id:"自主实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自主实现"}},[t._v("#")]),t._v(" 自主实现")]),t._v(" "),s("p",[t._v("我们自己写写看：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" PipeTransform"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Injectable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ArgumentMetadata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BadRequestException "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" validate "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'class-validator'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" plainToInstance "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'class-transformer'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Injectable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyValidationPipe")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PipeTransform")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("any"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" metatype "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ArgumentMetadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("metatype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" object "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("plainToInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metatype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" errors "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("validate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("errors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BadRequestException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'参数验证失败'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br")])]),s("p",[t._v("pipe 里拿到的 metatype 就是这部分：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/pL9gnPl6V3b5qZI.png",alt:""}})]),t._v(" "),s("p",[t._v("如果没有声明这部分，那就没法转换和验证，直接返回 value。")]),t._v(" "),s("p",[t._v("否则，通过 class-transformer 包的 plainToInstance 把普通对象转换为 dto class 的实例对象。")]),t._v(" "),s("p",[t._v("之后调用 class-validator 包的 validate api 对它做验证。如果验证不通过，就抛一个异常。")]),t._v(" "),s("p",[t._v("我们来用下看：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/sdNOjrC8an4DgY3.png",alt:""}})]),t._v(" "),s("p",[t._v("替换为我们自己实现的 MyValidationPipe。")]),t._v(" "),s("p",[t._v("再次请求下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/cgzDTSdFV1u5JYr.png",alt:""}})]),t._v(" "),s("p",[t._v("确实检查出了错误。")]),t._v(" "),s("p",[t._v("当然，我们做的并不够完善，还是直接用内置的 ValidationPipe 好了。")]),t._v(" "),s("h3",{attrs:{id:"注入依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注入依赖"}},[t._v("#")]),t._v(" 注入依赖")]),t._v(" "),s("p",[t._v("pipe 里也是可以注入依赖的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/SqQv4YX7g3J6y2m.png",alt:""}})]),t._v(" "),s("p",[t._v("比如，我们指定 @Inject 注入 token 为 validation_options 的对象。")]),t._v(" "),s("p",[t._v("因为标记了 @Optional，没找到对应的 provider 也不会报错：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/kB3csmORWKHN1Xn.png",alt:""}})]),t._v(" "),s("p",[t._v("但当我们在 module 里添加了这个 provider：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/ko947XH8byqBLrz.png",alt:""}})]),t._v(" "),s("p",[t._v("就可以正常注入了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/DSagpB4jwGHfxK7.png",alt:""}})]),t._v(" "),s("p",[t._v("当然，这种方式就不能用 new 的方式了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/xWTi4KujoeIDUBY.png",alt:""}})]),t._v(" "),s("p",[t._v("直接指定 class，让 Nest 去创建对象放到 ioc 容器里。")]),t._v(" "),s("p",[t._v("如果是全局的 pipe，要通过这种方式来创建才能注入依赖：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/WxARLSdZazy7GYV.png",alt:""}})]),t._v(" "),s("p",[t._v("这就和我们之前创建全局 interceptor 一样。")]),t._v(" "),s("p",[t._v("同理，其余的 filter、guard 也可以通过这种方式声明为全局生效的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/AO2uJPGUabK5wiD.png",alt:""}})]),t._v(" "),s("p",[t._v("现在我们就可以把 handler 里的 ValidationPipe 去掉了")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/Ntr8XRZzq1Bv6eV.png",alt:""}})]),t._v(" "),s("p",[t._v("再次访问，它依然是生效的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/t1ouj4HvCnrXheD.png",alt:""}})]),t._v(" "),s("p",[t._v("当然，这里我们没有注入什么依赖，所以这种方式也可以：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/iZrlGdQtO5n4kUB.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"class-validator"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#class-validator"}},[t._v("#")]),t._v(" class-validator")]),t._v(" "),s("p",[t._v("会用 ValidationPipe 之后，我们回过头来再看看 class-validator 都支持哪些验证方式：")]),t._v(" "),s("p",[t._v("我们声明这样一个 dto class：")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Contains"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IsDate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IsEmail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IsFQDN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IsInt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Max"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Min "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'class-validator'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Ppp")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Length")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("title")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Contains")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("text")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsInt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Max")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("rating")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsEmail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("email")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsFQDN")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("site")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br")])]),s("p",[t._v("其中 @IsFQDN 是是否是域名的意思。")]),t._v(" "),s("p",[t._v("然后添加一个 post 的 handler：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/ahqyijKZSx9F2pB.png",alt:""}})]),t._v(" "),s("p",[t._v("在 postman 里发送 post 请求。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/mjaplqgMi1x3D7Z.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"title"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aaaaaaaaaaaaaaa"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"text"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello aaa"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"rating"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"email"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aaa@qq.com"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"site"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aaa.guang.com"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"createDate"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2023-05-28T01:45:37.803Z"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("p",[t._v("参数正确的时候是不会报错的。")]),t._v(" "),s("p",[t._v("当参数不正确，ValidationPipe 就会返回 class-validator 的报错：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/R7Bgr93DJHLsyaK.png",alt:"image.png"}})]),t._v(" "),s("h3",{attrs:{id:"定制错误提示"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#定制错误提示"}},[t._v("#")]),t._v(" 定制错误提示")]),t._v(" "),s("p",[t._v("这个错误消息也是可以定制的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/PMV93gIZzOfKGby.png",alt:"image.png"}})]),t._v(" "),s("p",[t._v("添加一个 options 对象，传入 message 函数，打印下它的参数：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/mSKWTIElckFAd2N.png",alt:"image.png"}})]),t._v(" "),s("p",[t._v("可以拿到对象、属性名、属性值、class 名等各种信息，然后你可以返回自定义的 message：")]),t._v(" "),s("div",{staticClass:"language-typescript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token decorator"}},[s("span",{pre:!0,attrs:{class:"token at operator"}},[t._v("@")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Length")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("message")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("targetName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" property"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" constraints"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("targetName"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" 类的 ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("property"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" 属性的值 ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" 不满足约束: ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("constraints"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntitle"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("再次访问，返回的就是自定义的错误消息：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/27/kjeoKDWv3QOdmLV.png",alt:""}})]),t._v(" "),s("p",[t._v("更多的装饰器可以看 "),s("a",{attrs:{href:"https://www.npmjs.com/package/class-validator",target:"_blank",rel:"noopener noreferrer"}},[t._v("class-validator 文档"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("案例代码在"),s("a",{attrs:{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/pipe-test",target:"_blank",rel:"noopener noreferrer"}},[t._v("小册仓库"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("接收 post 请求的方式是声明一个 dto class，然后通过 @Body 来取请求体来注入值。")]),t._v(" "),s("p",[t._v("对它做验证要使用 ValidationPipe。")]),t._v(" "),s("p",[t._v("它的实现原理是基于 class-tranformer 把参数对象转换为 dto class 的对象，然后通过 class-validator 基于装饰器对这个对象做验证。")]),t._v(" "),s("p",[t._v("我们可以自己实现这样的 pipe，pipe 里可以注入依赖。")]),t._v(" "),s("p",[t._v("如果是全局 pipe 想注入依赖，需要通过 APP_PIPE 的 token 在 AppModule 里声明 provider。")]),t._v(" "),s("p",[t._v("class-validator 支持很多种验证规则，比如邮箱、域名、长度、值的范围等，而且错误消息也可以自定义。")]),t._v(" "),s("p",[t._v("ValidationPipe 是非常常用的 pipe，后面会大量用到。")])])}),[],!1,null,null,null);s.default=r.exports}}]);