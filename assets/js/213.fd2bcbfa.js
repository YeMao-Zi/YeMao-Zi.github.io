(window.webpackJsonp=window.webpackJsonp||[]).push([[213],{588:function(t,s,a){"use strict";a.r(s);var n=a(5),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("模块导出 provider，另一个模块需要 imports 它才能用这些 provider。")]),t._v(" "),s("p",[t._v("但如果这个模块被很多模块依赖了，那每次都要 imports 就很麻烦。")]),t._v(" "),s("p",[t._v("能不能设置成全局的，它导出的 provider 直接可用呢？")]),t._v(" "),s("p",[t._v("Module、Controller、Provider 是由 Nest 创建的，能不能在创建、销毁的时候执行一些逻辑呢？")]),t._v(" "),s("p",[t._v("这节我们来学习下全局模块和生命周期。")]),t._v(" "),s("p",[t._v("创建一个 nest 项目：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("nest new global-and-lifecycle -p npm\n")])])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/cXzqLUZugv4YIoP.png",alt:""}})]),t._v(" "),s("p",[t._v("然后创建两个 CRUD 的模块：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("nest g resource aaa --no-spec\nnest g resource bbb --no-spec\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("--no-spec 是不生成测试文件")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/2aIVw5yPsWxRSQr.png",alt:""}})]),t._v(" "),s("p",[t._v("在 AaaModule 里指定 exports 的 provider：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/M4skXBAv6otygCZ.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"普通导入导出"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#普通导入导出"}},[t._v("#")]),t._v(" 普通导入导出")]),t._v(" "),s("p",[t._v("然后在 BbbModule 里 imports：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/yMrWBjn6LkXf5zs.png",alt:""}})]),t._v(" "),s("p",[t._v("这样就可以在 BbbModule 内注入 AaaService 了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/Usdp9Dvqow2KZMa.png",alt:""}})]),t._v(" "),s("p",[t._v("把 nest 服务跑起来：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npm run start:dev\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("可以看到 aaaService 生效了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/mpxvaKc5DwftEZR.png",alt:""}})]),t._v(" "),s("p",[t._v("这是我们常用的引入 Module 的方式。")]),t._v(" "),s("h2",{attrs:{id:"模块重导出"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#模块重导出"}},[t._v("#")]),t._v(" 模块重导出")]),t._v(" "),s("p",[t._v("有时候我们希望在导出一个模块的同时，也重新导出它所导入的模块。这样可以让这个模块的消费者直接使用它依赖的模块的功能，而无需显式地导入它们。")]),t._v(" "),s("p",[t._v("在 Nest.js 中，可以使用 "),s("code",[t._v("exports")]),t._v(" 数组来重导出模块：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("imports")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("CommonModule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("providers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("EmailService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("exports")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("EmailService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CommonModule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重导出 CommonModule")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("EmailModule")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("在上面的代码中，"),s("code",[t._v("EmailModule")]),t._v(" 不仅导出了它自己的 "),s("code",[t._v("EmailService")]),t._v("，也重导出了它导入的 "),s("code",[t._v("CommonModule")]),t._v("。")]),t._v(" "),s("p",[t._v("这意味着导入 "),s("code",[t._v("EmailModule")]),t._v(" 的模块也会自动导入 "),s("code",[t._v("CommonModule")]),t._v("，并可以使用其提供的服务。")]),t._v(" "),s("p",[t._v("这种重导出机制在组织大型应用程序时非常有用，因为它可以减少模块间的耦合，同时简化外部模块的导入过程。")]),t._v(" "),s("h2",{attrs:{id:"全局导入"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局导入"}},[t._v("#")]),t._v(" 全局导入")]),t._v(" "),s("p",[t._v("但如果这个 AaaModule 被很多地方引用呢？")]),t._v(" "),s("p",[t._v("每个模块都 imports 太麻烦了，这时候就可以把它声明为全局的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/JBuHf8EVRpb5OFN.png",alt:""}})]),t._v(" "),s("p",[t._v("在 AaaModule 上加一个 @Global 的装饰器，然后在 BbbModule 里把 AaaModule 的 imports 去掉。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/sDzdrIGoylvXmJM.png",alt:""}})]),t._v(" "),s("p",[t._v("这样依然是可以注入的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/bCSgEKOh6cFvAGR.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/taHXEIjA3ODfGZp.png",alt:""}})]),t._v(" "),s("p",[t._v("这就是全局模块。")]),t._v(" "),s("blockquote",[s("p",[t._v("注意：Nest 中只能定义一个全局模块！")]),t._v(" "),s("p",[t._v("不过全局模块还是尽量少用，不然注入的很多 provider 都不知道来源，会降低代码的可维护性。")]),t._v(" "),s("p",[t._v("将所有东西都放在全局模块内是一个不好的决定，全局模块只是用于减少必要的文件数量，"),s("code",[t._v("imports")]),t._v(" 仍然是使模块 API 透明的最佳方式。")])]),t._v(" "),s("div",{staticClass:"custom-block note"},[s("p",{staticClass:"custom-block-title"},[t._v("笔记")]),t._v(" "),s("p",[t._v("在 NestJS 中，即使你将一个模块标记为全局模块（通过使用 "),s("code",[t._v("@Global()")]),t._v(" 装饰器），它仍然需要在至少一个地方注册或导入，通常是在 "),s("code",[t._v("AppModule")]),t._v(" 或者其他根模块中。这是因为 NestJS 需要有一个入口点来识别和加载这些全局模块。")])]),t._v(" "),s("h2",{attrs:{id:"动态模块"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#动态模块"}},[t._v("#")]),t._v(" 动态模块")]),t._v(" "),s("p",[t._v("我们需要导入的时候给其传入一些参数怎么办？可以使用动态模块。")]),t._v(" "),s("p",[t._v("动态模块允许在模块被导入时动态配置提供者（providers）、控制器（controllers）和导出（exports）。")]),t._v(" "),s("p",[t._v("这种方式非常适合需要根据不同环境或配置动态更改其行为的模块。")]),t._v(" "),s("p",[t._v("下面是一个简单的例子：")]),t._v(" "),s("p",[t._v("多了一个 "),s("code",[t._v("module")]),t._v(" 属性指向当前的模块类，即 "),s("code",[t._v("DynamicModuleModule")]),t._v("。")]),t._v(" "),s("p",[t._v("我们给 DynamicModuleModule 加一个 register 的静态方法，返回模块定义的对象，外部传入的 options 参数对象会作为一个新的 provider。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DynamicModule "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" BbbService "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./bbb.service'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" BbbController "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./bbb.controller'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BbbModule")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("register")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Record"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" DynamicModule "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" providers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      BbbService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("provide")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bbbOptions'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useValue")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// global: true,")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("module")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" BbbModule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("controllers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("BbbController"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("providers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" providers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("exports")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("BbbService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bbbOptions'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br")])]),s("blockquote",[s("p",[t._v("如果要在全局范围内注册动态模块，请将 "),s("code",[t._v("global")]),t._v(" 属性设置为 "),s("code",[t._v("true")]),t._v("。")])]),t._v(" "),s("p",[t._v("导入时配置：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/Irm4pM3tzxFbW7w.png",alt:"image-20250317150606749"}})]),t._v(" "),s("p",[t._v("注入依赖：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/2GmcDF4UCLn3Tlt.png",alt:"image-20250317150719636"}})]),t._v(" "),s("h2",{attrs:{id:"生命周期"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#生命周期"}},[t._v("#")]),t._v(" 生命周期")]),t._v(" "),s("p",[t._v("然后是生命周期：")]),t._v(" "),s("p",[t._v("Nest 在启动的时候，会递归解析 Module 依赖，扫描其中的 provider、controller，注入它的依赖。")]),t._v(" "),s("p",[t._v("全部解析完后，会监听网络端口，开始处理请求。")]),t._v(" "),s("p",[t._v("这个过程中，Nest 暴露了一些生命周期方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/CogHsmp7MlWbkO2.png",alt:""}})]),t._v(" "),s("p",[t._v("首先，递归初始化模块，会依次调用模块内的 controller、provider 的 "),s("code",[t._v("onModuleInit")]),t._v(" 方法，然后再调用 module 的 "),s("code",[t._v("onModuleInit")]),t._v(" 方法。")]),t._v(" "),s("p",[t._v("全部初始化完之后，再依次调用模块内的 controller、provider 的 "),s("code",[t._v("onApplicationBootstrap")]),t._v(" 方法，然后调用 module 的 "),s("code",[t._v("onApplicationBootstrap")]),t._v(" 方法")]),t._v(" "),s("p",[t._v("然后监听网络端口。")]),t._v(" "),s("p",[t._v("之后 Nest 应用就正常运行了。")]),t._v(" "),s("p",[t._v("这个过程中，"),s("code",[t._v("onModuleInit")]),t._v("、"),s("code",[t._v("onApplicationBootstrap")]),t._v(" 都是我们可以实现的生命周期方法。")]),t._v(" "),s("p",[t._v("我们来试一下：")]),t._v(" "),s("p",[t._v("再创建两个 Module：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("nest g resource ccc --no-spec\nnest g resource ddd --no-spec\n")])])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/da8qHzAyRfikE1S.png",alt:""}}),t._v("******")]),t._v(" "),s("p",[t._v("nest 提供了这样两个 interface：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/iZAPG5RwxqWEFjn.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63d821abc66e4eaa81338f4c9cd3cf81~tplv-k3u1fbpfcp-watermark.image?",alt:""}})]),t._v(" "),s("p",[t._v("在 controller、service、module 里分别实现它：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/wdFAE1Oe86syJNB.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/1rk82i9XKGpsHqQ.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/yaSrI6DhwMspjv7.png",alt:""}})]),t._v(" "),s("p",[t._v("ddd 模块也是这样。")]),t._v(" "),s("p",[t._v("然后重新跑下服务，会看到这样的日志信息：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/eZ7cAMNLQoIPJOg.png",alt:""}})]),t._v(" "),s("p",[t._v("这就是 onModuleInit 和 onApplicationBootstrap 生命周期的调用顺序。")]),t._v(" "),s("p",[t._v("应用销毁的时候也同样有生命周期：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/WiqfurayMChILAm.png",alt:""}})]),t._v(" "),s("p",[t._v("先调用每个模块的 controller、provider 的 onModuleDestroy 方法，然后调用 Module 的 onModuleDestroy 方法。")]),t._v(" "),s("p",[t._v("之后再调用每个模块的 controller、provider 的 beforeApplicationShutdown 方法，然后调用 Module 的 beforeApplicationShutdown 方法。")]),t._v(" "),s("p",[t._v("然后停止监听网络端口。")]),t._v(" "),s("p",[t._v("之后调用每个模块的 controller、provider 的 onApplicationShutdown 方法，然后调用 Module 的 onApplicationShutdown 方法。")]),t._v(" "),s("p",[t._v("之后停止进程。")]),t._v(" "),s("p",[t._v("是不是感觉 onModuleDestory 和 beforeApplicationShutdown 没区别呀？")]),t._v(" "),s("p",[t._v("其实是有区别的，可以看下对应的 interface：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/Dgo47UvwP65f2xp.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/fW4syphIgKk6SQR.png",alt:""}})]),t._v(" "),s("p",[t._v("beforeApplicationShutdown 是可以拿到 signal 系统信号的，比如 SIGTERM。")]),t._v(" "),s("p",[t._v("这些终止信号是别的进程传过来的，让它做一些销毁的事情，比如用 k8s 管理容器的时候，可以通过这个信号来通知它。")]),t._v(" "),s("p",[t._v("我们分别给 CccController、CccProvider、CccModule 还有 ddd 模块的那些给加一下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/2n7sfrwChkbBRoX.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/eGVjcJBiKLku8gp.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/t6zEVjQb8pUeOro.png",alt:""}})]),t._v(" "),s("p",[t._v("3s 后调用 app.close() 触发销毁（app.close() 只是触发销毁逻辑，但不会真正退出进程）")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/WYIOKRHm5qFLEZ2.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"执行顺序"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#执行顺序"}},[t._v("#")]),t._v(" 执行顺序")]),t._v(" "),s("p",[t._v("生命周期方法是这样的执行顺序：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/HqxRQ2lthdDeN1K.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"异步生命周期"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#异步生命周期"}},[t._v("#")]),t._v(" 异步生命周期")]),t._v(" "),s("p",[t._v("而且所有的生命周期函数都是支持 async 的。")]),t._v(" "),s("p",[t._v("我们来看看 @nestjs/typeorm、@nestjs/mongoose 里都是怎么用的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/HYok8hIXrJ1B2nD.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67a26e1870004d419fdbdd468caa47ec~tplv-k3u1fbpfcp-watermark.image?",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，一般都是通过 moduleRef 取出一些 provider 来销毁，比如关闭连接。")]),t._v(" "),s("p",[s("strong",[t._v("这里的 moduleRef 就是当前模块的引用。")])]),t._v(" "),s("p",[t._v("我们来试试：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/zJAyu1N3w2jKFVp.png",alt:""}})]),t._v(" "),s("p",[t._v("onApplicationShutdown 的生命周期里，拿到当前模块的引用 moduleRef，调用 get 方法，传入 token，取出对应的 provider 实例，然后调用它的方法。")]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" OnModuleInit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" OnApplicationBootstrap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" OnModuleDestroy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BeforeApplicationShutdown"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" OnApplicationShutdown  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/common'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ModuleRef "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nestjs/core'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" CccService "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./ccc.service'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" CccController "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./ccc.controller'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Module")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("controllers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("CccController"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("providers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("CccService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CccModule")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OnModuleInit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" OnApplicationBootstrap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" OnModuleDestroy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BeforeApplicationShutdown"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" OnApplicationShutdown  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onModuleDestroy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CccModule onModuleDestroy'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeApplicationShutdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("signal")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CccModule beforeApplicationShutdown'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" signal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onApplicationShutdown")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cccService "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("moduleRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CccService"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CccService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--------------------------'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cccService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findAll")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CccModule onApplicationShutdown'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onModuleInit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CccModule OnModuleInit'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onApplicationBootstrap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CccModule onApplicationBootstrap'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/03/17/dIp5XbPBWx7yVeU.png",alt:""}})]),t._v(" "),s("p",[t._v("这就是 onApplicationShutdown 生命周期的常见用法。")]),t._v(" "),s("p",[t._v("案例代码在"),s("a",{attrs:{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/global-and-lifecycle",target:"_blank",rel:"noopener noreferrer"}},[t._v("小册仓库"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("这节我们学习了全局模块和生命周期。")]),t._v(" "),s("p",[t._v("模块可以通过 @Global 声明为全局的，这样它 exports 的 provider 就可以在各处使用了，不需要 imports。")]),t._v(" "),s("p",[t._v("provider、controller、module 都支持启动和销毁的生命周期函数，这些生命周期函数都支持 async 的方式。")]),t._v(" "),s("p",[t._v("可以在其中做一些初始化、销毁的逻辑，比如 onApplicationShutwon 里通过 moduleRef.get 取出一些 provider，执行关闭连接等销毁逻辑。")]),t._v(" "),s("p",[t._v("全局模块、生命周期、moduleRef 都是 Nest 很常用的功能。")])])}),[],!1,null,null,null);s.default=e.exports}}]);