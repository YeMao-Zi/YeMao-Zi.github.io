(window.webpackJsonp=window.webpackJsonp||[]).push([[340],{715:function(s,t,n){"use strict";n.r(t);var a=n(5),e=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"dockerfile-和-docker-daemon"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-和-docker-daemon"}},[s._v("#")]),s._v(" dockerfile 和 docker daemon")]),s._v(" "),t("p",[s._v("首先思考一个问题：")]),s._v(" "),t("p",[s._v("dockerfile 是在哪里 build 的，在命令行工具里，还是在 docker 守护进程呢？")]),s._v(" "),t("p",[s._v("答案是在守护进程 docker daemon。")]),s._v(" "),t("p",[s._v("我没启动 docker daemon 的时候是不能 build 的，启动之后才可以：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/jsEzI5f8cOXy6G9.png",alt:""}})]),s._v(" "),t("p",[s._v("命令行工具会和 docker daemon 交互来实现各种功能。")]),s._v(" "),t("p",[s._v("比如 docker build 的时候，会把 dockerfile 和它的构建上下文（也就是所在目录）打包发送给 docker daemon 来构建镜像。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/D4HQFzBYjKonZi7.png",alt:""}})]),s._v(" "),t("p",[s._v("比如我们会执行这样的命令：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" name:tag "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" filename "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这个 . 就是构建上下文的目录，你也可以指定别的路径。")]),s._v(" "),t("h2",{attrs:{id:"dockerignore"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dockerignore"}},[s._v("#")]),s._v(" .dockerignore")]),s._v(" "),t("p",[s._v("而镜像自然是越小性能越好，所以 docker 支持你通过 .dockerignore 声明哪些不需要发送给 docker daemon。")]),s._v(" "),t("p",[s._v(".dockerignore 是这样写的：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("*.md\n!README.md\nnode_modules/\n[a-c].txt\n.git/\n.DS_Store\n.vscode/\n.dockerignore\n.eslintignore\n.eslintrc\n.prettierrc\n.prettierignore\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("*.md 就是忽略所有 md 结尾的文件，然后 !README.md 就是其中不包括 README.md")]),s._v(" "),t("p",[s._v("node_modules/ 就是忽略 node_modules 下 的所有文件")]),s._v(" "),t("p",[s._v("[a-c].txt 是忽略 a.txt、b.txt、c.txt 这三个文件")]),s._v(" "),t("p",[s._v(".DS_Store 是 mac 的用于指定目录的图标、背景、字体大小的配置文件，这个一般都要忽略")]),s._v(" "),t("p",[s._v("eslint、prettier 的配置文件在构建镜像的时候也用不到")]),s._v(" "),t("p",[s._v("此外，还有注释的语法：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/3Zrv7dD5HNzgAep.png",alt:""}})]),s._v(" "),t("p",[s._v("这就是 dockerfile 的全部语法，没多少东西。")]),s._v(" "),t("p",[t("strong",[s._v("docker build 时，会先解析 .dockerignore，把该忽略的文件忽略掉，然后把剩余文件打包发送给 docker daemon 作为上下文来构建产生镜像。")])]),s._v(" "),t("p",[s._v("这就像你在 git add 的时候，.gitignore 下配置的文件也会被忽略一样。")]),s._v(" "),t("p",[s._v("忽略这些用不到的文件，是为了让构建更快、镜像体积更小。")]),s._v(" "),t("h2",{attrs:{id:"此外-还有一种减小镜像体积的手段-多阶段构建。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#此外-还有一种减小镜像体积的手段-多阶段构建。"}},[s._v("#")]),s._v(" 此外，还有一种减小镜像体积的手段：多阶段构建。")]),s._v(" "),t("p",[s._v("我们会先把源码目录发送到 docker daemon 中执行 npm run build 来构建产物，之后再 node ./dist/main.js 把服务跑起来。")]),s._v(" "),t("p",[s._v("也就是这样：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/DxgN1WcqX4tVTKZ.png",alt:""}})]),s._v(" "),t("p",[s._v("新建个项目：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("nest new dockerfile-test "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("编写 .dockerignore：")]),s._v(" "),t("div",{staticClass:"language-.ignore line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("*.md\nnode_modules/\n.git/\n.DS_Store\n.vscode/\n.dockerignore\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("编写 Dockerfile：")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" [ "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./dist/main.js"')]),s._v(" ]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("基于 node 18 的镜像。")]),s._v(" "),t("p",[s._v("指定当前目录为容器内的 /app。")]),s._v(" "),t("p",[s._v("把 package.json 复制到容器里，设置淘宝的 npm registry，执行 npm install。")]),s._v(" "),t("p",[s._v("之后把其余的文件复制过去，执行 npm run build。")]),s._v(" "),t("p",[s._v("指定暴露的端口为 3000，容器跑起来以后执行 node ./dist/main.js 命令。")]),s._v(" "),t("p",[s._v("然后执行 docker build：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t nest:first .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("镜像名为 nest、标签为 first，构建上下文是当前目录")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/1AMEXDQRtfvP4oc.png",alt:""}})]),s._v(" "),t("p",[s._v("然后就可以在 docker desktop 里看到你构建出来的镜像了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/AE7NoBq1VjmFt3I.png",alt:""}})]),s._v(" "),t("p",[s._v("如果你 build 的时候报这个错误：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/D5YhQKkdJGm1SIX.png",alt:""}})]),s._v(" "),t("p",[s._v("那需要加一行：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v("RUN ln -s /sbin/runc /usr/bin/runc\n")])])]),t("p",[s._v("原因如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/LHMuAYVIT23Wm6K.png",alt:""}})]),s._v(" "),t("p",[s._v("点击 run 把它跑起来：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/DM92QJ3fw8yodGs.png",alt:""}})]),s._v(" "),t("p",[s._v("容器跑成功了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/Lz89oHgMkT7bNtv.png",alt:""}})]),s._v(" "),t("p",[s._v("浏览器访问下也没啥问题：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/zNZT1lx9gJfkLwb.png",alt:""}})]),s._v(" "),t("p",[s._v("这样我们就用 docker 把我们的 nest 应用跑起来了！")]),s._v(" "),t("p",[s._v("但现在 docker 镜像还是不完美的。")]),s._v(" "),t("p",[s._v("这样构建出来的镜像有什么问题呢？")]),s._v(" "),t("p",[s._v("明显，src 等目录就不再需要了，构建的时候需要这些，但运行的时候只需要 dist 目录就可以了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/rxADEg3F9V8Swk1.png",alt:""}})]),s._v(" "),t("p",[s._v("把这些文件包含在内，会让镜像体积变大。")]),s._v(" "),t("p",[s._v("那怎么办呢？")]),s._v(" "),t("p",[s._v("构建两次么？第一次构建出 dist 目录，第二次再构建出跑 dist/main.js 的镜像。那不是要两个 dockerfile？")]),s._v(" "),t("p",[s._v("确实需要构建两次，但只需要一个 dockerfile 就可以搞定。")]),s._v(" "),t("p",[s._v("这需要用到 dockerfile 的多阶段构建的语法。")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# build stage")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" build-stage")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# production stage")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" production-stage")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-stage")])]),s._v(" /app/dist /app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-stage")])]),s._v(" /app/package.json /app/package.json")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install --production")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app/main.js"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("p",[s._v("通过 FROM 继承镜像的时候，给当前镜像指定一个名字，比如 build-stage。")]),s._v(" "),t("p",[s._v("然后第一个镜像执行 build。")]),s._v(" "),t("p",[s._v("之后再通过 FROM 继承 node 镜像创建一个新镜像。")]),s._v(" "),t("p",[s._v("通过 COPY --from-build-stage 从那个镜像内复制 /app/dist 的文件到当前镜像的 /app 下。")]),s._v(" "),t("p",[s._v("还要把 package.json 也复制过来，然后切到 /app 目录执行 npm install --production 只安装 dependencies 依赖")]),s._v(" "),t("p",[s._v("这个生产阶段的镜像就指定容器跑起来执行 node /app/main.js 就好了。")]),s._v(" "),t("p",[s._v("执行 docker build，打上 second 标签：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t nest:second .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/ZBrMi3AINTW5dvH.png",alt:""}})]),s._v(" "),t("p",[s._v("把之前的容器停掉，把这个跑起来：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/3bOPZl6FVpkr4wa.png",alt:""}})]),s._v(" "),t("p",[s._v("这次用 3003 端口来跑：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/ao4De1GYXvk8PAt.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/XrheOqlHdjm4o5a.png",alt:""}})]),s._v(" "),t("p",[s._v("浏览器访问下：\n"),t("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/485940af45b1484283a04d1e4067cc21~tplv-k3u1fbpfcp-watermark.image?",alt:""}})]),s._v(" "),t("p",[s._v("nest 服务跑成功了。")]),s._v(" "),t("p",[s._v("这时候 app 下就是有 dist 的文件、生产阶段的 node_modules、package.json 这些文件：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/H5ku36EhyoUlVFJ.png",alt:""}})]),s._v(" "),t("p",[s._v("对比下镜像体积，明显看出有减小，少的就是 src、test、构建阶段的 node_modules 这些文件：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/ZteBNuhnPO3rksK.png",alt:""}})]),s._v(" "),t("p",[s._v("这就是多阶段构建（multi-stage build）的魅力。")]),s._v(" "),t("h2",{attrs:{id:"有同学说-但现在镜像依然很大呀-那是因为我们用的基础的-linux-镜像比较大-可以换成-alpine-的-这是一个-linux-发行版-主打的就是一个体积小。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#有同学说-但现在镜像依然很大呀-那是因为我们用的基础的-linux-镜像比较大-可以换成-alpine-的-这是一个-linux-发行版-主打的就是一个体积小。"}},[s._v("#")]),s._v(" 有同学说，但现在镜像依然很大呀，那是因为我们用的基础的 linux 镜像比较大，可以换成 alpine 的，这是一个 linux 发行版，主打的就是一个体积小。")]),s._v(" "),t("div",{staticClass:"language-docker line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18.0-alpine3.14 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" build-stage")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# production stage")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:18.0-alpine3.14 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" production-stage")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-stage")])]),s._v(" /app/dist /app")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-stage")])]),s._v(" /app/package.json /app/package.json")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm config set registry https://registry.npmmirror.com/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install --production")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app/main.js"')]),s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[s._v("node:18-alpine3.14 就是用 alpine 的 linux 的 3.14 版本，用 node 的 18.0 版本。")]),s._v(" "),t("p",[s._v("然后再 docker build 一下。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker build -t nest:ccc .\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/zo27kyWTN1XDeu4.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到现在镜像体积只有 277M 了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/7Ne2sJPAZHy9U3z.png",alt:""}})]),s._v(" "),t("p",[s._v("一般情况下，我们都会用多阶段构建 + alpine 基础镜像。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/05/30/AB1tUTlIC4jng27.png",alt:""}})]),s._v(" "),t("p",[s._v("alpine 是一种高山植物，就是很少的养分就能存活，很贴合体积小的含义。")]),s._v(" "),t("p",[s._v("案例代码在"),t("a",{attrs:{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nest-dockerfile",target:"_blank",rel:"noopener noreferrer"}},[s._v("小册仓库"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("docker build 的时候会把构建上下文的所有文件打包发送给 docker daemon 来构建镜像。")]),s._v(" "),t("p",[s._v("可以通过 .dockerignore 指定哪些文件不发送，这样能加快构建时间，减小镜像体积。")]),s._v(" "),t("p",[s._v("此外，多阶段构建也能减小镜像体积，也就是 build 一个镜像、production 一个镜像，最终保留下 production 的镜像。")]),s._v(" "),t("p",[s._v("而且我们一般使用 alpine 的基础镜像，类似 node:18.10-alpine3.14，这样构建出来镜像体积会小很多。")]),s._v(" "),t("p",[s._v("这就是用 Nest 项目构建 Docker 镜像的方式。")])])}),[],!1,null,null,null);t.default=e.exports}}]);