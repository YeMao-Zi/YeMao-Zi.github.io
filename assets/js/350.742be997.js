(window.webpackJsonp=window.webpackJsonp||[]).push([[350],{725:function(s,t,a){"use strict";a.r(t);var r=a(5),e=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"事务操作与数据回滚"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#事务操作与数据回滚"}},[s._v("#")]),s._v(" 事务操作与数据回滚")]),s._v(" "),t("p",[s._v("我们学习了增删改查的 sql 语句，并进行了大量的练习。")]),s._v(" "),t("p",[s._v("但有个问题：")]),s._v(" "),t("p",[s._v("如果是两个 update 的语句，一个把订单详情表数量修改了，一个把订单表的总金额修改了。但是改订单总金额的那个 sql 执行失败了。")]),s._v(" "),t("p",[s._v("这时候怎么办？")]),s._v(" "),t("p",[s._v("数量已经改了，但是总金额没改成功，就对不上了。")]),s._v(" "),t("p",[s._v("这种就需要事务（transaction）了。")]),s._v(" "),t("p",[s._v("它是这样用的：")]),s._v(" "),t("p",[s._v("比如 3 号订单的这三个商品，我们把它数量都改为 1。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/XzDnZrRts59uc4p.png",alt:""}})]),s._v(" "),t("p",[s._v("那总金额就是 200，需要改 order 表的 total_amount 为 200。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/KVx7gqABOMi21Xy.png",alt:""}})]),s._v(" "),t("p",[s._v("我们先开启事务：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("START")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRANSACTION")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后执行两条 sql 语句：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" order_items "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" quantity"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" order_id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" orders "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" total_amount"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("分别修改了 order_items 的商品数量和 orders 的订单总金额。")]),s._v(" "),t("p",[s._v("然后再查询下现在 orders 表和 order_items 表的数据。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/2ngLOmBZj9Kei1F.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/twpWnBAIUOcCMvm.png",alt:""}})]),s._v(" "),t("p",[s._v("确实改了。")]),s._v(" "),t("p",[s._v("如果这时候你发现改错了，想再改回去，可你不记得之前的数据是啥了，怎么办呢？")]),s._v(" "),t("h2",{attrs:{id:"rollback-回滚"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rollback-回滚"}},[s._v("#")]),s._v(" ROLLBACK 回滚")]),s._v(" "),t("p",[s._v("别担心，这时候只要执行下 ROLLBACK 就好了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/4ZHOXye5xM9FwhG.png",alt:""}})]),s._v(" "),t("p",[s._v("你会发现它们的数据恢复了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/VJGTNCEpwH9R4ka.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/OkBUjT6fSlbi9ws.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"如果你确实想提交-那可以执行-commit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如果你确实想提交-那可以执行-commit"}},[s._v("#")]),s._v(" 如果你确实想提交，那可以执行 COMMIT：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("START")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRANSACTION")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" order_items "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" quantity"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" order_id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" orders "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" total_amount"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("这时候数据就真正被修改，不能回滚了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/IFxyzqCuVshDYr4.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"那如果我不是想回滚所有的-sql-语句-只是回滚一部分呢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#那如果我不是想回滚所有的-sql-语句-只是回滚一部分呢"}},[s._v("#")]),s._v(" 那如果我不是想回滚所有的 sql 语句，只是回滚一部分呢？")]),s._v(" "),t("p",[s._v("这需要手动告诉 mysql 一些保存的点：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("START")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRANSACTION")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SAVEPOINT")]),s._v(" aaa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" order_items "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" quantity"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" order_id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SAVEPOINT")]),s._v(" bbb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" orders "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" total_amount"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SAVEPOINT")]),s._v(" ccc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("比如我设置了 3 个保存点。")]),s._v(" "),t("p",[s._v("执行这段 sql，数据确实修改了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/GCtNv9ZPfoSBjYJ.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/TfNPMLtu8DIpGBW.png",alt:""}})]),s._v(" "),t("p",[s._v("这时候我们回滚到 bbb 的位置：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ROLLBACK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SAVEPOINT")]),s._v(" bbb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后再查询下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/2kw5DxKi19NPt7U.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/J5PzSInYCMOXKfR.png",alt:""}})]),s._v(" "),t("p",[s._v("这时候 order_items 表修改成功了，但是 orders 表修改没成功。")]),s._v(" "),t("p",[s._v("这确实是这个点的状态：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/xO9PEutJ5giBMQU.png",alt:"image.png"}})]),s._v(" "),t("p",[s._v("再回滚到 ccc：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ROLLBACK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SAVEPOINT")]),s._v(" ccc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/fENMwjrg78q1Du6.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s2.loli.net/2025/06/27/GaNRK9DsLSzM3OP.png",alt:""}})]),s._v(" "),t("p",[s._v("这时候就都修改成功了。")]),s._v(" "),t("p",[s._v("这就是事务：")]),s._v(" "),t("p",[t("strong",[s._v("START TRANSACTION 开启事务后所有的 sql 语句都可以 ROLLBACK，除非执行了 COMMIT 完成这段事务。")])]),s._v(" "),t("p",[t("strong",[s._v("还可以设置几个 SAVEPOINT，这样可以 ROLLBACK TO 任何一个 SAVEPOINT 的位置。")])]),s._v(" "),t("p",[s._v("当你修改多个表的时候，并且这些表的数据是有关联的时候，事务是必须的。要不全部成功，要不全部不成功。")]),s._v(" "),t("h2",{attrs:{id:"那如果事务还没有-commit-但是它修改了一些表-这时候我们能查到它修改后的数据么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#那如果事务还没有-commit-但是它修改了一些表-这时候我们能查到它修改后的数据么"}},[s._v("#")]),s._v(" 那如果事务还没有 COMMIT，但是它修改了一些表，这时候我们能查到它修改后的数据么？")]),s._v(" "),t("p",[s._v("这就涉及到事务的隔离级别的概念了。")]),s._v(" "),t("p",[s._v("MYSQL 有 4 种事务隔离级别：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("READ UNCOMMITTED")]),s._v("：可以读到别的事务尚未提交的数据。")])]),s._v(" "),t("p",[s._v("这就有个问题，你这个事务内第一次读的数据是 aaa，下次读可能就是 bbb 了，这个问题叫做"),t("strong",[s._v("不可重复读")]),s._v("。")]),s._v(" "),t("p",[s._v("而且，万一你读到的数据人家又回滚了，那你读到的就是临时数据，这个问题叫做"),t("strong",[s._v("脏读")]),s._v("。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("READ COMMITTED")]),s._v("：只读取别的事务已提交的数据。")])]),s._v(" "),t("p",[s._v("这样是没有脏读问题了，读到的不会是临时数据。")]),s._v(" "),t("p",[s._v("但是还是有可能你这个事务内第一次读的数据是 aaa，下次读可能是 bbb ，也就是不可重复读的问题依然存在。")]),s._v(" "),t("p",[s._v("不只是数据不一样，可能你两次读取到的记录行数也不一样，这叫做"),t("strong",[s._v("幻读")]),s._v("。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("REPEATABLE READ")]),s._v("：在同一事务内，多次读取数据将保证结果相同。")])]),s._v(" "),t("p",[s._v("这个级别保证了读取到的数据一样，但是不保证行数一样，也就是说解决了不可重复读的问题，但仍然存在幻读的问题。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("SERIALIZABLE")]),s._v("：在同一时间只允许一个事务修改数据。")])]),s._v(" "),t("p",[s._v("事务一个个执行，各种问题都没有了。")]),s._v(" "),t("p",[s._v("但是负面影响就是性能很差，只能一个个的事务执行。")]),s._v(" "),t("p",[s._v("这 4 种级别主要是数据一致性和性能的差别，一致性越好，并发性能就越差。")]),s._v(" "),t("p",[s._v("需要根据实际情况来权衡。")]),s._v(" "),t("p",[s._v("可以这样查询当前的事务隔离级别：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@transaction_isolation")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7baa2d25c6a4ddc963c9f54390bdfad~tplv-k3u1fbpfcp-watermark.image?",alt:""}})]),s._v(" "),t("p",[s._v("这个了解就好，一般用默认的。")]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("事务内的几条 sql 要么全部成功，要么全部不成功，这样能保证数据的一致性。")]),s._v(" "),t("p",[s._v("它的使用方式是 START TRANSACTION; COMMIT; 或者 ROLLBACK;")]),s._v(" "),t("p",[s._v("还可以设置 SAVEPOINT，然后 ROLLBACK TO SAVEPOINT;")]),s._v(" "),t("p",[s._v("事务还没提交的数据，别的事务能不能读取到，这就涉及到隔离级别的概念了。")]),s._v(" "),t("p",[s._v("一般就用默认的隔离级别就行，也就是 REPEATABLE READ。")]),s._v(" "),t("p",[s._v("基本上，只要写增删改的 sql，那都是要开事务的。")])])}),[],!1,null,null,null);t.default=e.exports}}]);