(window.webpackJsonp=window.webpackJsonp||[]).push([[359],{736:function(t,s,a){"use strict";a.r(s);var n=a(5),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("前面我们基于 TypeORM 操作数据库都是开启了 synchronize，只要创建或者修改了 Entity，那就会自动创建表和修改表结构。")]),t._v(" "),s("p",[t._v("在开发时这样很方便，只要关注代码就好了，不用管修改表结构的事情。")]),t._v(" "),s("h2",{attrs:{id:"但是在生产环境下-用-synchronize-很危险-很容易丢数据。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#但是在生产环境下-用-synchronize-很危险-很容易丢数据。"}},[t._v("#")]),t._v(" 但是在生产环境下，用 synchronize 很危险，很容易丢数据。")]),t._v(" "),s("p",[t._v("我们试一下：")]),t._v(" "),s("p",[t._v("新建一个 TypeORM 项目：")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("npx typeorm@latest init "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" typeorm-migration "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--database")]),t._v(" mysql\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/o4Au8EPeK3zZFaR.png",alt:""}})]),t._v(" "),s("p",[t._v("改下 data-source.ts 的配置：")]),t._v(" "),s("div",{staticClass:"language-typescript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"reflect-metadata"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" DataSource "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"typeorm"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" User "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./entity/User"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" AppDataSource "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DataSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  type"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mysql"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  host"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  port"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  username"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  password"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guang"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  database"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"migration-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  synchronize"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  logging"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  entities"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("User"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  migrations"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  subscribers"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  poolSize"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  connectorPackage"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mysql2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  extra"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    authPlugin"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sha256_password"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br")])]),s("p",[t._v("安装用到的 mysql2:")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--save")]),t._v(" mysql2\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("在 mysql workbench 里创建这个 database：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/DoAzCeh5xP9icZf.png",alt:""}})]),t._v(" "),s("p",[t._v("指定名字和字符集，点击 apply.")]),t._v(" "),s("p",[t._v("或者也可以执行这个 sql 来创建：")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SCHEMA")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("migration-test"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CHARACTER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" utf8mb4 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("跑一下：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npm run start\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("可以看到，会自动创建 Entity 对应的表：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/oCD9jTmvigWSeal.png",alt:""}})]),t._v(" "),s("p",[t._v("在 mysql workbench 里也可以看到这个表：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/noAQDV3xBGReNc9.png",alt:""}})]),t._v(" "),s("p",[t._v("把插入数据的代码注释掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/QPApoVbsweKhqX9.png",alt:""}})]),t._v(" "),s("p",[t._v("改下 Entity：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/S9DciRJQ28ZmBjk.png",alt:""}})]),t._v(" "),s("p",[t._v("重新跑下：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npm run start\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("可以看到 TypeORM 检测到 Entity 的变更，修改了表结构：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/NKJALItfCRwSQyn.png",alt:""}})]),t._v(" "),s("p",[t._v("在 mysql workbench 里可以看到，之前的 age 列就没了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/EwuR8DLo1JPx3at.png",alt:""}})]),t._v(" "),s("p",[t._v("数据是不是就全丢了！")]),t._v(" "),s("p",[t._v("更何况跑 nest 项目的时候都是用 npm run start:dev，代码改动立刻重新跑，所以很容易丢数据。")]),t._v(" "),s("p",[t._v("所以说，synchronize 在开发环境下确实很方便，但是在生产环境下不能用，不安全。")]),t._v(" "),s("p",[t._v("那不用 synchonize 用啥呢，手动去数据库执行 sql 么？")]),t._v(" "),s("p",[t._v("那倒也不用。")]),t._v(" "),s("h2",{attrs:{id:"可以用-typeorm-的-migration-功能。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#可以用-typeorm-的-migration-功能。"}},[t._v("#")]),t._v(" 可以用 TypeORM 的 migration 功能。")]),t._v(" "),s("p",[t._v("migration 是迁移的意思，其实前面的 create table、alter table 这些都是 migration：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/oCD9jTmvigWSeal.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/NKJALItfCRwSQyn.png",alt:""}})]),t._v(" "),s("p",[t._v("只不过之前是自动跑，而现在我们要管理起来，手动跑。")]),t._v(" "),s("h3",{attrs:{id:"typeorm-提供了一个-cli-执行-migration-create-的命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#typeorm-提供了一个-cli-执行-migration-create-的命令"}},[t._v("#")]),t._v(" typeorm 提供了一个 cli，执行 migration:create 的命令：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npx ts-node ./node_modules/typeorm/cli migration:create ./src/migration/Aaa\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/7JlXo4Rgxuvz9dF.png",alt:""}})]),t._v(" "),s("p",[t._v("生成了 “时间戳-Aaa.ts” 文件，这个就是放迁移代码的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/nLt8yFHCzmAo3XB.png",alt:""}})]),t._v(" "),s("p",[t._v("迁移就是 create table、alter table 这些。")]),t._v(" "),s("p",[t._v("我们在 mysql workbench 里导出下建表 sql 语句：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/tL8wPvn3lgcZR2q.png",alt:""}})]),t._v(" "),s("p",[t._v("点击左侧的 Data Export，选中要导出的表，指定一个 sql 文件保存位置，点击 Export。")]),t._v(" "),s("p",[t._v("可以看到，生成的 sql 里就包括了 create table 建表语句和插入数据的 insert into 语句：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/RXsyz534TvNO72E.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"我们把建表-sql-拿过来"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#我们把建表-sql-拿过来"}},[t._v("#")]),t._v(" 我们把建表 sql 拿过来：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/FVbwQU3H1M7Kjni.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" MigrationInterface"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" QueryRunner "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"typeorm"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Aaa1708136448263")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MigrationInterface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("up")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryRunner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" QueryRunner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Promise"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" queryRunner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("query")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\n            CREATE TABLE user (\n                id int NOT NULL AUTO_INCREMENT,\n                firstName varchar(255) NOT NULL,\n                lastName varchar(255) NOT NULL,\n                PRIMARY KEY (id)\n            ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;\n        ")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("down")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryRunner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" QueryRunner"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Promise"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br")])]),s("h3",{attrs:{id:"然后把-synchronize-关掉-用-migration-来手动建表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#然后把-synchronize-关掉-用-migration-来手动建表"}},[t._v("#")]),t._v(" 然后把 synchronize 关掉，用 migration 来手动建表：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/42OIGHiUatb76F5.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"reflect-metadata"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" DataSource "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"typeorm"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" User "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./entity/User"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" AppDataSource "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DataSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mysql"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("host")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("username")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guang"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("database")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"migration-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("synchronize")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("logging")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("entities")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("User"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("migrations")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./src/migration/**.ts"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("subscribers")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("poolSize")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("connectorPackage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mysql2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("extra")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("authPlugin")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sha256_password"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br")])]),s("p",[t._v("先在 mysql workbench 里把之前的表删掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/b7GADEks2eUFVoh.png",alt:""}})]),t._v(" "),s("p",[t._v("把 index.ts 注释放开，但 age 去掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/8FsQ4Bbik9xmdT6.png",alt:""}})]),t._v(" "),s("p",[t._v("然后再跑 npm run start")]),t._v(" "),s("p",[t._v("这时候因为 synchronize 关掉了，不会自动建表，所以 报错了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/3fkZiH89rFbdWRS.png",alt:""}})]),t._v(" "),s("p",[t._v("然后我们用 migration:run 来手动建表：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npx ts-node ./node_modules/typeorm/cli migration:run -d ./src/data-source.ts\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/Lfz7VXKAreNhcnG.png",alt:""}})]),t._v(" "),s("p",[t._v("可以看到，执行了 migration 里的 create table 语句。")]),t._v(" "),s("p",[t._v("这时候数据库中就有这个表了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/9FAkOYxrNSho1Ti.png",alt:""}})]),t._v(" "),s("p",[t._v("并且还在 migrations 表里记录了什么时间执行了什么迁移：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/YwMXjpPFkAOU6ib.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"这时候再跑-npm-run-start"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#这时候再跑-npm-run-start"}},[t._v("#")]),t._v(" 这时候再跑 npm run start")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/vcH3BgFWTheiDIf.png",alt:""}})]),t._v(" "),s("p",[t._v("这时候 insert、select 就都成功了。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/5aHcqW4xEFMgeN8.png",alt:""}})]),t._v(" "),s("p",[t._v("生产环境，我们不会用 synchronize 自动同步，就是用的 migration 的方式来建表。")]),t._v(" "),s("p",[t._v("但是导出建表 sql 再复制到 migration 的 up 方法里挺麻烦的。")]),t._v(" "),s("h3",{attrs:{id:"有没有简便的方法呢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#有没有简便的方法呢"}},[t._v("#")]),t._v(" 有没有简便的方法呢？")]),t._v(" "),s("h2",{attrs:{id:"有-这就是-migration-generate-命令。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#有-这就是-migration-generate-命令。"}},[t._v("#")]),t._v(" 有，这就是 migration:generate 命令。")]),t._v(" "),s("p",[t._v("把这两个表删掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/tpaVDg8N3Kmj9ky.png",alt:""}})]),t._v(" "),s("p",[t._v("把之前那个 migration 也删掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/NYosZSAOikqCHW3.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"我们这次用-migration-generate-来生成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#我们这次用-migration-generate-来生成"}},[t._v("#")]),t._v(" 我们这次用 migration:generate 来生成：")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("npx ts-node ./node_modules/typeorm/cli migration:generate ./src/migration/Aaa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" ./src/data-source.ts\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/cagSJA6L3Uot7ZD.png",alt:""}})]),t._v(" "),s("p",[t._v("生成的 migration 文件如下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/kRapGDjUSLBJnEv.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"用-migration-run-执行下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用-migration-run-执行下"}},[t._v("#")]),t._v(" 用 migration:run 执行下：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npx ts-node ./node_modules/typeorm/cli migration:run -d ./src/data-source.ts\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/CEZFL1BXO8H9Rnv.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"然后再跑下-npm-run-start"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#然后再跑下-npm-run-start"}},[t._v("#")]),t._v(" 然后再跑下 npm run start：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/ezUtQY3SiLah6ln.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/yQJlEcoGutjYZHa.png",alt:""}})]),t._v(" "),s("p",[t._v("没啥问题。")]),t._v(" "),s("p",[t._v("这样，就不用自己写 migration 文件了，就很方便。")]),t._v(" "),s("h3",{attrs:{id:"当然-不只是建表算是-migration-修改表结构也算。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#当然-不只是建表算是-migration-修改表结构也算。"}},[t._v("#")]),t._v(" 当然，不只是建表算是 migration，修改表结构也算。")]),t._v(" "),s("p",[t._v("我们在 User 里加一个字段：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/fkMluY8jOshFxZw.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Column")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("email")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("再执行下 migration:generate")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npx ts-node ./node_modules/typeorm/cli migration:generate ./src/migration/Bbb -d ./src/data-source.ts\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/Vv26QfXNUa5AkFz.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/spezIbKEuxMht4P.png",alt:""}})]),t._v(" "),s("p",[t._v("这时候生成的 migration 就是 alter table 语句。")]),t._v(" "),s("p",[t._v("跑下 migration:run")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npx typeorm-ts-node-esm migration:run -d ./src/data-source.ts\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/icSRUYj47mOA2Tx.png",alt:""}})]),t._v(" "),s("p",[t._v("在 migrations 表里记录了 Aaa 跑过，所以这次只会跑 Bbb 的 migration。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/rSW2UbBLmlphYdt.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/wCL3OgzGUXvETa8.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"可以跑-migration-也同样可以撤销"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#可以跑-migration-也同样可以撤销"}},[t._v("#")]),t._v(" 可以跑 migration 也同样可以撤销：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npx ts-node ./node_modules/typeorm/cli migration:revert -d ./src/data-source.ts\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/PwhjeUZfFzxqndm.png",alt:""}})]),t._v(" "),s("p",[t._v("执行 migration:revert 会执行上次的 migration 的 down 方法，并且从 migrations 表里删掉执行记录。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/VafSqZTbk2Wl9xi.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/qQS1maNd3kxuWMI.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/Tn8CHcBpOmwK95q.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"再次-revert-会撤销上一次的-migration-删掉-user-表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#再次-revert-会撤销上一次的-migration-删掉-user-表"}},[t._v("#")]),t._v(" 再次 revert，会撤销上一次的 migration，删掉 user 表：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/A9C6kIBG4hpDEKg.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/8lpO6oatSZIu9ey.png",alt:""}})]),t._v(" "),s("p",[t._v("所以说，每一次的 migration 都是可控的，可以手动执行、也可以撤销。生产环境我们就是用 migration 来修改表结构，而不是 synchronize")]),t._v(" "),s("h3",{attrs:{id:"此外-每次都输这么长串命令也太麻烦了-我们可以把它封装成-npm-scripts"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#此外-每次都输这么长串命令也太麻烦了-我们可以把它封装成-npm-scripts"}},[t._v("#")]),t._v(" 此外，每次都输这么长串命令也太麻烦了，我们可以把它封装成 npm scripts：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/vuflChgSQYzqrka.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"migration:create"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run typeorm -- migration:create"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"migration:generate"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run typeorm -- migration:generate -d ./src/data-source.ts"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"migration:run"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run typeorm -- migration:run -d ./src/data-source.ts"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"migration:revert"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run typeorm -- migration:revert -d ./src/data-source.ts"')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("这样用起来就简单多了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2025/07/28/Owxy3AhZVCi1n9t.png",alt:""}})]),t._v(" "),s("p",[t._v("案例代码在"),s("a",{attrs:{href:"https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/typeorm-migration",target:"_blank",rel:"noopener noreferrer"}},[t._v("小册仓库"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("开发环境我们会用 synchronize 来同步 Entity 和数据库表，它会自动执行 create table、alter table，不用手动修改表结构，很方便。")]),t._v(" "),s("p",[t._v("但是它并不安全，因为很容易丢失数据。所以生产环境下我们会把它关掉，用 migration 来管理。")]),t._v(" "),s("p",[t._v("migration 就是把 create table、alter table 等封装成一个个的 migration，可以一步步执行、也可以一步步撤销回去。")]),t._v(" "),s("p",[t._v("有 4 个常用命令：")]),t._v(" "),s("ul",[s("li",[t._v("migration:create：生成空白 migration 文件")]),t._v(" "),s("li",[t._v("migration:generate：连接数据库，根据 Entity 和数据库表的差异，生成 migration 文件")]),t._v(" "),s("li",[t._v("migration:run：执行 migration，会根据数据库 migrations 表的记录来确定执行哪个")]),t._v(" "),s("li",[t._v("migration:revert：撤销上次 migration，删掉数据库 migrations 里的上次执行记录")])]),t._v(" "),s("p",[t._v("这样就把生产环境里的建表和修改表的操作管理了起来。")])])}),[],!1,null,null,null);s.default=r.exports}}]);